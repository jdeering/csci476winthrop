<HTML>
<HEAD>
<TITLE>
Markup.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="green">// Markup.cpp: implementation of the CMarkup class.</font>
<font color="green">//</font>
<font color="green">// Markup Release 10.1</font>
<font color="green">// Copyright (C) 2008 First Objective Software, Inc. All rights reserved</font>
<font color="green">// Go to www.firstobject.com for the latest CMarkup and EDOM documentation</font>
<font color="green">// Use in commercial applications requires written permission</font>
<font color="green">// This software is provided "as is", with no warranty.</font>
<font color="green">//</font>
<font color="blue">#include</font> <font color="maroon">&#60;stdio.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"Markup.h"</font>

<font color="blue">#if</font> defined<font color="black">(</font>MCD_STRERROR<font color="black">)</font> <font color="green">// C error routine</font>
<font color="blue">#include</font> <font color="maroon">&#60;errno.h&#62;</font>
<font color="blue">#endif</font> <font color="green">// C error routine</font>

<font color="blue">#if</font> defined <font color="black">(</font>MARKUP_ICONV<font color="black">)</font>
<font color="blue">#include</font> <font color="maroon">&#60;iconv.h&#62;</font>
<font color="blue">#endif</font>

<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_STL<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font> defined<font color="black">(</font>MARKUP_WINCONV<font color="black">)</font> <font color="black">|</font><font color="black">|</font> <font color="black">(</font><font color="black">!</font> defined<font color="black">(</font>MCD_STRERROR<font color="black">)</font><font color="black">)</font><font color="black">)</font>
<font color="blue">#include</font> <font color="maroon">&#60;windows.h&#62;</font> <font color="green">// for MultiByteToWideChar, WideCharToMultiByte, FormatMessage</font>
<font color="blue">#endif</font> <font color="green">// need windows.h when STL and (not setlocale or not strerror), MFC afx.h includes it already </font>

<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_MBCS<font color="black">)</font> <font color="green">// MBCS/double byte</font>
<font color="blue">#pragma</font> message<font color="black">(</font> <font color="maroon">"Note: MBCS build (not UTF-8)"</font> <font color="black">)</font>
<font color="green">// For UTF-8, remove MBCS from project settings C/C++ preprocessor definitions</font>
<font color="blue">#if</font> defined <font color="black">(</font>MARKUP_WINCONV<font color="black">)</font>
<font color="blue">#include</font> <font color="maroon">&#60;mbstring.h&#62;</font> <font color="green">// for VC++ _mbclen</font>
<font color="blue">#endif</font> <font color="green">// WINCONV</font>
<font color="blue">#endif</font> <font color="green">// MBCS/double byte</font>

<font color="blue">#if</font> defined<font color="black">(</font>_DEBUG<font color="black">)</font> <font color="black">&</font><font color="black">&</font> _MSC_VER <font color="black">&#62;</font> <font color="maroon">1000</font> <font color="green">// VC++ DEBUG</font>
<font color="blue">#undef</font> THIS_FILE
<font color="blue">static</font> <font color="blue">char</font> THIS_FILE<font color="black">[</font><font color="black">]</font><font color="black">=</font>__FILE__;
<font color="blue">#if</font> defined<font color="black">(</font>DEBUG_NEW<font color="black">)</font>
<font color="blue">#define</font> <font color="blue">new</font> DEBUG_NEW
<font color="blue">#endif</font> <font color="green">// DEBUG_NEW</font>
<font color="blue">#endif</font> <font color="green">// VC++ DEBUG</font>

<font color="green">// Customization</font>
<font color="blue">#define</font> x_EOL MCD_T<font color="black">(</font><font color="maroon">"\r\n"</font><font color="black">)</font> <font color="green">// can be \r\n or \n or empty</font>
<font color="blue">#define</font> x_EOLLEN <font color="black">(</font><font color="blue">sizeof</font><font color="black">(</font>x_EOL<font color="black">)</font><font color="black">/</font><font color="blue">sizeof</font><font color="black">(</font>MCD_CHAR<font color="black">)</font><font color="maroon">-1</font><font color="black">)</font> <font color="green">// string length of x_EOL</font>
<font color="blue">#define</font> x_ATTRIBQUOTE MCD_T<font color="black">(</font><font color="maroon">"\""</font><font color="black">)</font> <font color="green">// can be double or single quote</font>


<font color="green">// Disable "while ( 1 )" warning in VC++ 2002</font>
<font color="blue">#if</font> _MSC_VER <font color="black">&#62;</font><font color="black">=</font> <font color="maroon">1300</font> <font color="green">// VC++ 2002 (7.0)</font>
<font color="blue">#pragma</font> <font color="blue">warning</font><font color="black">(</font>disable<font color="black">:</font><font color="maroon">4127</font><font color="black">)</font>
<font color="blue">#endif</font> <font color="green">// VC++ 2002 (7.0)</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">(</font> <font color="blue">const</font> CMarkup<font color="black">&</font> markup <font color="black">)</font>
<font color="black">{</font>
    m_iPosParent <font color="black">=</font> markup.m_iPosParent;
    m_iPos <font color="black">=</font> markup.m_iPos;
    m_iPosChild <font color="black">=</font> markup.m_iPosChild;
    m_iPosFree <font color="black">=</font> markup.m_iPosFree;
    m_iPosDeleted <font color="black">=</font> markup.m_iPosDeleted;
    m_nNodeType <font color="black">=</font> markup.m_nNodeType;
    m_nNodeOffset <font color="black">=</font> markup.m_nNodeOffset;
    m_nNodeLength <font color="black">=</font> markup.m_nNodeLength;
    m_strDoc <font color="black">=</font> markup.m_strDoc;
    m_strError <font color="black">=</font> markup.m_strError;
    m_nDocFlags <font color="black">=</font> markup.m_nDocFlags;

    <font color="green">// Copy used part of the index array</font>
    m_aPos.RemoveAll<font color="black">(</font><font color="black">)</font>;
    m_aPos.nSize <font color="black">=</font> m_iPosFree;
    <font color="blue">if</font> <font color="black">(</font> m_aPos.nSize <font color="black">&#60;</font> <font color="maroon">8</font> <font color="black">)</font>
        m_aPos.nSize <font color="black">=</font> <font color="maroon">8</font>;
    m_aPos.nSegs <font color="black">=</font> m_aPos.SegsUsed<font color="black">(</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> m_aPos.nSegs <font color="black">)</font>
    <font color="black">{</font>
        m_aPos.pSegs <font color="black">=</font> <font color="black">(</font>ElemPos<font color="black">*</font><font color="black">*</font><font color="black">)</font><font color="black">(</font><font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>m_aPos.nSegs<font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font><font color="black">]</font><font color="black">)</font>;
        <font color="blue">int</font> nSegSize <font color="black">=</font> <font color="maroon">1</font> <font color="black">&#60;</font><font color="black">&#60;</font> m_aPos.PA_SEGBITS;
        <font color="blue">for</font> <font color="black">(</font> <font color="blue">int</font> nSeg<font color="black">=</font><font color="maroon">0</font>; nSeg <font color="black">&#60;</font> m_aPos.nSegs; <font color="black">+</font><font color="black">+</font>nSeg <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> nSeg <font color="black">+</font> <font color="maroon">1</font> <font color="black">=</font><font color="black">=</font> m_aPos.nSegs <font color="black">)</font>
                nSegSize <font color="black">=</font> m_aPos.GetSize<font color="black">(</font><font color="black">)</font> <font color="black">-</font><font color="black">(</font>nSeg <font color="black">&#60;</font><font color="black">&#60;</font> m_aPos.PA_SEGBITS<font color="black">)</font>;
            m_aPos.pSegs<font color="black">[</font>nSeg<font color="black">]</font> <font color="black">=</font> <font color="black">(</font>ElemPos<font color="black">*</font><font color="black">)</font><font color="black">(</font><font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>nSegSize<font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font>ElemPos<font color="black">)</font><font color="black">]</font><font color="black">)</font>;
            memcpy<font color="black">(</font> m_aPos.pSegs<font color="black">[</font>nSeg<font color="black">]</font>, markup.m_aPos.pSegs<font color="black">[</font>nSeg<font color="black">]</font>, nSegSize<font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font>ElemPos<font color="black">)</font> <font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>

    <font color="green">// Copy SavedPos map(s)</font>
    m_SavedPosMapArray.RemoveAll<font color="black">(</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> markup.m_SavedPosMapArray.pMaps <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">int</font> nMap <font color="black">=</font> <font color="maroon">0</font>;
        SavedPosMap<font color="black">*</font> pMap <font color="black">=</font> NULL;
        <font color="blue">while</font> <font color="black">(</font> markup.m_SavedPosMapArray.pMaps<font color="black">[</font>nMap<font color="black">]</font> <font color="black">)</font>
        <font color="black">{</font>
            SavedPosMap<font color="black">*</font> pMapSrc <font color="black">=</font> markup.m_SavedPosMapArray.pMaps<font color="black">[</font>nMap<font color="black">]</font>;
            x_GetMap<font color="black">(</font> pMap, nMap, pMapSrc<font color="black">-</font><font color="black">&#62;</font>nMapSize <font color="black">)</font>;
            <font color="blue">for</font> <font color="black">(</font> <font color="blue">int</font> nSlot<font color="black">=</font><font color="maroon">0</font>; nSlot <font color="black">&#60;</font> pMap<font color="black">-</font><font color="black">&#62;</font>nMapSize; <font color="black">+</font><font color="black">+</font>nSlot <font color="black">)</font>
            <font color="black">{</font>
                SavedPos<font color="black">*</font> pCopySavedPos <font color="black">=</font> pMapSrc<font color="black">-</font><font color="black">&#62;</font>pTable<font color="black">[</font>nSlot<font color="black">]</font>;
                <font color="blue">if</font> <font color="black">(</font> pCopySavedPos <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">int</font> nCount <font color="black">=</font> <font color="maroon">0</font>;
                    <font color="blue">while</font> <font color="black">(</font> pCopySavedPos<font color="black">[</font>nCount<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_USED <font color="black">)</font>
                    <font color="black">{</font>
                        <font color="black">+</font><font color="black">+</font>nCount;
                        <font color="blue">if</font> <font color="black">(</font> pCopySavedPos<font color="black">[</font>nCount<font color="maroon">-1</font><font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST <font color="black">)</font>
                            <font color="blue">break</font>;
                    <font color="black">}</font>
                    <font color="blue">if</font> <font color="black">(</font> nCount <font color="black">)</font>
                    <font color="black">{</font>
                        SavedPos<font color="black">*</font> pNewSavedPos <font color="black">=</font> <font color="blue">new</font> SavedPos<font color="black">[</font>nCount<font color="black">]</font>;
                        <font color="blue">for</font> <font color="black">(</font> <font color="blue">int</font> nCopy<font color="black">=</font><font color="maroon">0</font>; nCopy<font color="black">&#60;</font>nCount; <font color="black">+</font><font color="black">+</font>nCopy <font color="black">)</font>
                            pNewSavedPos<font color="black">[</font>nCopy<font color="black">]</font> <font color="black">=</font> pCopySavedPos<font color="black">[</font>nCopy<font color="black">]</font>;
                        pNewSavedPos<font color="black">[</font>nCount<font color="maroon">-1</font><font color="black">]</font>.nSavedPosFlags <font color="black">|</font><font color="black">=</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST;
                        pMap<font color="black">-</font><font color="black">&#62;</font>pTable<font color="black">[</font>nSlot<font color="black">]</font> <font color="black">=</font> pNewSavedPos;
                    <font color="black">}</font>
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="black">+</font><font color="black">+</font>nMap;
        <font color="black">}</font>
    <font color="black">}</font>

    MARKUP_SETDEBUGSTATE;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>SetDoc<font color="black">(</font> MCD_PCSZ pDoc <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Set document text</font>
    <font color="blue">if</font> <font color="black">(</font> pDoc <font color="black">)</font>
        m_strDoc <font color="black">=</font> pDoc;
    <font color="blue">else</font>
        MCD_STRCLEAR<font color="black">(</font>m_strDoc<font color="black">)</font>;

    MCD_STRCLEAR<font color="black">(</font>m_strError<font color="black">)</font>;
    <font color="blue">return</font> x_ParseDoc<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>;

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>SetDoc<font color="black">(</font> <font color="blue">const</font> MCD_STR<font color="black">&</font> strDoc <font color="black">)</font>
<font color="black">{</font>
    m_strDoc <font color="black">=</font> strDoc;
    MCD_STRCLEAR<font color="black">(</font>m_strError<font color="black">)</font>;
    <font color="blue">return</font> x_ParseDoc<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>IsWellFormed<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> m_aPos.GetSize<font color="black">(</font><font color="black">)</font>
            <font color="black">&</font><font color="black">&</font> <font color="black">!</font> <font color="black">(</font>m_aPos<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>.nFlags <font color="black">&</font> MNF_ILLFORMED<font color="black">)</font>
            <font color="black">&</font><font color="black">&</font> m_aPos<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>.iElemChild
            <font color="black">&</font><font color="black">&</font> <font color="black">!</font> m_aPos<font color="black">[</font>m_aPos<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>.iElemChild<font color="black">]</font>.iElemNext <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>Load<font color="black">(</font> MCD_CSTR_FILENAME szFileName <font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> ReadTextFile<font color="black">(</font>szFileName, m_strDoc, <font color="black">&</font>m_strError, <font color="black">&</font>m_nDocFlags<font color="black">)</font> <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;
    <font color="blue">return</font> x_ParseDoc<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>ReadTextFile<font color="black">(</font> MCD_CSTR_FILENAME szFileName, MCD_STR<font color="black">&</font> strDoc, MCD_STR<font color="black">*</font> pstrError, <font color="blue">int</font><font color="black">*</font> pnDocFlags, MCD_STR<font color="black">*</font> pstrEncoding <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Static utility method to load text file into strDoc</font>
    <font color="green">//</font>
    FilePos file;
    file.nDocFlags <font color="black">=</font> <font color="black">(</font>pnDocFlags?<font color="black">*</font>pnDocFlags<font color="black">:</font><font color="maroon">0</font><font color="black">)</font> <font color="black">|</font> MDF_READFILE;
    <font color="blue">bool</font> bSuccess <font color="black">=</font> x_Open<font color="black">(</font> szFileName, file <font color="black">)</font>;
    MCD_STR strCombinedIOResult <font color="black">=</font> file.strIOResult;
    MCD_STRCLEAR<font color="black">(</font>strDoc<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> bSuccess <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pstrEncoding <font color="black">)</font>
        <font color="black">{</font>
            MCD_STR strEncoding <font color="black">=</font> <font color="black">*</font>pstrEncoding;
            <font color="blue">if</font> <font color="black">(</font> file.nFileCharUnitSize <font color="black">=</font><font color="black">=</font> <font color="maroon">1</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> MCD_STRISEMPTY<font color="black">(</font>strEncoding<font color="black">)</font> <font color="black">&</font><font color="black">&</font> file.strEncoding <font color="black">!</font><font color="black">=</font> strEncoding <font color="black">)</font>
            <font color="black">{</font>
                file.strEncoding <font color="black">=</font> strEncoding; <font color="green">// override</font>
                strCombinedIOResult <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"forced "</font><font color="black">)</font>;
                strCombinedIOResult <font color="black">+</font><font color="black">=</font> file.strEncoding <font color="black">+</font> MCD_T<font color="black">(</font><font color="maroon">" "</font><font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        file.nReadByteLen <font color="black">=</font> file.nFileByteLen;
        bSuccess <font color="black">=</font> x_ReadText<font color="black">(</font> strDoc, file <font color="black">)</font>;
        x_Close<font color="black">(</font> file <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>strCombinedIOResult<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>file.strEncoding<font color="black">)</font> <font color="black">)</font>
                strCombinedIOResult <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"ANSI "</font><font color="black">)</font>;
            <font color="blue">else</font>
                strCombinedIOResult <font color="black">=</font> file.strEncoding <font color="black">+</font> MCD_T<font color="black">(</font><font color="maroon">" "</font><font color="black">)</font>;
        <font color="black">}</font>
        strCombinedIOResult <font color="black">+</font><font color="black">=</font> file.strIOResult;
        <font color="blue">if</font> <font color="black">(</font> pnDocFlags <font color="black">)</font>
            <font color="black">*</font>pnDocFlags <font color="black">=</font> file.nDocFlags;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font> pstrError <font color="black">)</font>
        <font color="black">*</font>pstrError <font color="black">=</font> strCombinedIOResult;
    <font color="blue">return</font> bSuccess;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>Save<font color="black">(</font> MCD_CSTR_FILENAME szFileName <font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> WriteTextFile<font color="black">(</font> szFileName, m_strDoc, <font color="black">&</font>m_strError, <font color="black">&</font>m_nDocFlags <font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>WriteTextFile<font color="black">(</font> MCD_CSTR_FILENAME szFileName, <font color="blue">const</font> MCD_STR<font color="black">&</font> strDoc, MCD_STR<font color="black">*</font> pstrError, <font color="blue">int</font><font color="black">*</font> pnDocFlags, MCD_STR<font color="black">*</font> pstrEncoding <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Static utility method to save strDoc to text file</font>
    <font color="green">//</font>
    FilePos file;
    file.nDocFlags <font color="black">=</font> <font color="black">(</font>pnDocFlags?<font color="black">*</font>pnDocFlags<font color="black">:</font><font color="maroon">0</font><font color="black">)</font> <font color="black">|</font> MDF_WRITEFILE;
    <font color="blue">bool</font> bSuccess <font color="black">=</font> x_Open<font color="black">(</font> szFileName, file <font color="black">)</font>;
    MCD_STR strCombinedIOResult <font color="black">=</font> file.strIOResult;
    <font color="blue">if</font> <font color="black">(</font> bSuccess <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>file.strEncoding<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> MCD_STRISEMPTY<font color="black">(</font>strDoc<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            file.strEncoding <font color="black">=</font> GetDeclaredEncoding<font color="black">(</font> strDoc <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>file.strEncoding<font color="black">)</font> <font color="black">&</font><font color="black">&</font> strDoc<font color="black">[</font><font color="maroon">0</font><font color="black">]</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#60;'</font> <font color="black">)</font>
                file.strEncoding <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"UTF-8"</font><font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> MCD_STRISEMPTY<font color="black">(</font>file.strEncoding<font color="black">)</font> <font color="black">)</font>
                strCombinedIOResult <font color="black">+</font><font color="black">=</font> file.strEncoding <font color="black">+</font> MCD_T<font color="black">(</font><font color="maroon">" "</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font> pstrEncoding <font color="black">)</font>
        <font color="black">{</font>
            MCD_STR strEncoding <font color="black">=</font> <font color="black">*</font>pstrEncoding;
            <font color="blue">if</font> <font color="black">(</font> file.nFileCharUnitSize <font color="black">=</font><font color="black">=</font> <font color="maroon">1</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> MCD_STRISEMPTY<font color="black">(</font>strEncoding<font color="black">)</font> <font color="black">&</font><font color="black">&</font> file.strEncoding <font color="black">!</font><font color="black">=</font> strEncoding <font color="black">)</font>
            <font color="black">{</font>
                file.strEncoding <font color="black">=</font> strEncoding; <font color="green">// override</font>
                strCombinedIOResult <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"forced "</font><font color="black">)</font>;
                strCombinedIOResult <font color="black">+</font><font color="black">=</font> file.strEncoding <font color="black">+</font> MCD_T<font color="black">(</font><font color="maroon">" "</font><font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        bSuccess <font color="black">=</font> x_WriteText<font color="black">(</font> strDoc, file <font color="black">)</font>;
        x_Close<font color="black">(</font> file <font color="black">)</font>;
        strCombinedIOResult <font color="black">+</font><font color="black">=</font> file.strIOResult;
        <font color="blue">if</font> <font color="black">(</font> pnDocFlags <font color="black">)</font>
            <font color="black">*</font>pnDocFlags <font color="black">=</font> file.nDocFlags;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font> pstrError <font color="black">)</font>
        <font color="black">*</font>pstrError <font color="black">=</font> strCombinedIOResult;
    <font color="blue">return</font> bSuccess;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>FindElem<font color="black">(</font> MCD_CSTR szName <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Change current position only if found</font>
    <font color="green">//</font>
    <font color="blue">if</font> <font color="black">(</font> m_aPos.GetSize<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">int</font> iPos <font color="black">=</font> x_FindElem<font color="black">(</font> m_iPosParent, m_iPos, szName <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Assign new position</font>
            x_SetPos<font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemParent, iPos, <font color="maroon">0</font> <font color="black">)</font>;
            <font color="blue">return</font> <font color="blue">true</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>FindChildElem<font color="black">(</font> MCD_CSTR szName <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Change current child position only if found</font>
    <font color="green">//</font>
    <font color="green">// Shorthand: call this with no current main position</font>
    <font color="green">// means find child under root element</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> m_iPos <font color="black">)</font>
        FindElem<font color="black">(</font><font color="black">)</font>;

    <font color="blue">int</font> iPosChild <font color="black">=</font> x_FindElem<font color="black">(</font> m_iPos, m_iPosChild, szName <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> iPosChild <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Assign new position</font>
        <font color="blue">int</font> iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.iElemParent;
        x_SetPos<font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemParent, iPos, iPosChild <font color="black">)</font>;
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>

    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>EscapeText<font color="black">(</font> MCD_CSTR szText, <font color="blue">int</font> nFlags <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Convert text as seen outside XML document to XML friendly</font>
    <font color="green">// replacing special characters with ampersand escape codes</font>
    <font color="green">// E.g. convert "6&#62;7" to "6&gt;7"</font>
    <font color="green">//</font>
    <font color="green">// &lt;   less than</font>
    <font color="green">// &amp;  ampersand</font>
    <font color="green">// &gt;   greater than</font>
    <font color="green">//</font>
    <font color="green">// and for attributes:</font>
    <font color="green">//</font>
    <font color="green">// &apos; apostrophe or single quote</font>
    <font color="green">// &quot; double quote</font>
    <font color="green">//</font>
    <font color="blue">static</font> MCD_PCSZ apReplace<font color="black">[</font><font color="black">]</font> <font color="black">=</font> <font color="black">{</font> MCD_T<font color="black">(</font><font color="maroon">"&lt;"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"&amp;"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"&gt;"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"&apos;"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"&quot;"</font><font color="black">)</font> <font color="black">}</font>;
    MCD_PCSZ pFind <font color="black">=</font> <font color="black">(</font>nFlags<font color="black">&</font>MNF_ESCAPEQUOTES<font color="black">)</font>?MCD_T<font color="black">(</font><font color="maroon">"&#60;&&#62;\'\""</font><font color="black">)</font><font color="black">:</font>MCD_T<font color="black">(</font><font color="maroon">"&#60;&&#62;"</font><font color="black">)</font>;
    MCD_STR strText;
    MCD_PCSZ pSource <font color="black">=</font> szText;
    <font color="blue">int</font> nDestSize <font color="black">=</font> MCD_PSZLEN<font color="black">(</font>pSource<font color="black">)</font>;
    nDestSize <font color="black">+</font><font color="black">=</font> nDestSize <font color="black">/</font> <font color="maroon">10</font> <font color="black">+</font> <font color="maroon">7</font>;
    MCD_BLDRESERVE<font color="black">(</font>strText,nDestSize<font color="black">)</font>;
    MCD_CHAR cSource <font color="black">=</font> <font color="black">*</font>pSource;
    MCD_PCSZ pFound;
    <font color="blue">int</font> nCharLen;
    <font color="blue">while</font> <font color="black">(</font> cSource <font color="black">)</font>
    <font color="black">{</font>
        MCD_BLDCHECK<font color="black">(</font>strText,nDestSize,<font color="maroon">6</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>pFound<font color="black">=</font>MCD_PSZCHR<font color="black">(</font>pFind,cSource<font color="black">)</font><font color="black">)</font> <font color="black">!</font><font color="black">=</font> NULL <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">bool</font> bIgnoreAmpersand <font color="black">=</font> <font color="blue">false</font>;
            <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>nFlags<font color="black">&</font>MNF_WITHREFS<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">*</font>pFound <font color="black">=</font><font color="black">=</font> <font color="maroon">'&'</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// Do not replace ampersand if it is start of any entity reference</font>
                <font color="green">// &[#_:A-Za-zU][_:-.A-Za-z0-9U]*; where U is &#62; 0x7f</font>
                MCD_PCSZ pCheckEntity <font color="black">=</font> pSource;
                <font color="black">+</font><font color="black">+</font>pCheckEntity;
                MCD_CHAR c <font color="black">=</font> <font color="black">*</font>pCheckEntity;
                <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>c<font color="black">&#62;</font><font color="black">=</font><font color="maroon">'A'</font><font color="black">&</font><font color="black">&</font>c<font color="black">&#60;</font><font color="black">=</font><font color="maroon">'Z'</font><font color="black">)</font> <font color="black">|</font><font color="black">|</font> <font color="black">(</font>c<font color="black">&#62;</font><font color="black">=</font><font color="maroon">'a'</font><font color="black">&</font><font color="black">&</font>c<font color="black">&#60;</font><font color="black">=</font><font color="maroon">'z'</font><font color="black">)</font>
                        <font color="black">|</font><font color="black">|</font> c<font color="black">=</font><font color="black">=</font><font color="maroon">'#'</font> <font color="black">|</font><font color="black">|</font> c<font color="black">=</font><font color="black">=</font><font color="maroon">'_'</font> <font color="black">|</font><font color="black">|</font> c<font color="black">=</font><font color="black">=</font><font color="maroon">':'</font> <font color="black">|</font><font color="black">|</font> <font color="black">(</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font>c<font color="black">)</font><font color="black">&#62;</font><font color="maroon">0x7f</font> <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">while</font> <font color="black">(</font> <font color="maroon">1</font> <font color="black">)</font>
                    <font color="black">{</font>
                        pCheckEntity <font color="black">+</font><font color="black">=</font> MCD_CLEN<font color="black">(</font> pCheckEntity <font color="black">)</font>;
                        c <font color="black">=</font> <font color="black">*</font>pCheckEntity;
                        <font color="blue">if</font> <font color="black">(</font> c <font color="black">=</font><font color="black">=</font> <font color="maroon">';'</font> <font color="black">)</font>
                        <font color="black">{</font>
                            <font color="blue">int</font> nEntityLen <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pCheckEntity <font color="black">-</font>pSource<font color="black">)</font> <font color="black">+</font> <font color="maroon">1</font>;
                            MCD_BLDAPPENDN<font color="black">(</font>strText,pSource,nEntityLen<font color="black">)</font>;
                            pSource <font color="black">=</font> pCheckEntity;
                            bIgnoreAmpersand <font color="black">=</font> <font color="blue">true</font>;
                        <font color="black">}</font>
                        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>c<font color="black">&#62;</font><font color="black">=</font><font color="maroon">'A'</font><font color="black">&</font><font color="black">&</font>c<font color="black">&#60;</font><font color="black">=</font><font color="maroon">'Z'</font><font color="black">)</font> <font color="black">|</font><font color="black">|</font> <font color="black">(</font>c<font color="black">&#62;</font><font color="black">=</font><font color="maroon">'a'</font><font color="black">&</font><font color="black">&</font>c<font color="black">&#60;</font><font color="black">=</font><font color="maroon">'z'</font><font color="black">)</font> <font color="black">|</font><font color="black">|</font> <font color="black">(</font>c<font color="black">&#62;</font><font color="black">=</font><font color="maroon">'0'</font><font color="black">&</font><font color="black">&</font>c<font color="black">&#60;</font><font color="black">=</font><font color="maroon">'9'</font><font color="black">)</font>
                                <font color="black">|</font><font color="black">|</font> c<font color="black">=</font><font color="black">=</font><font color="maroon">'_'</font> <font color="black">|</font><font color="black">|</font> c<font color="black">=</font><font color="black">=</font><font color="maroon">':'</font> <font color="black">|</font><font color="black">|</font> c<font color="black">=</font><font color="black">=</font><font color="maroon">'-'</font> <font color="black">|</font><font color="black">|</font> c<font color="black">=</font><font color="black">=</font><font color="maroon">'.'</font> <font color="black">|</font><font color="black">|</font> <font color="black">(</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font>c<font color="black">)</font><font color="black">&#62;</font><font color="maroon">0x7f</font> <font color="black">)</font>
                            <font color="blue">continue</font>;
                        <font color="blue">break</font>;
                    <font color="black">}</font>
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> bIgnoreAmpersand <font color="black">)</font>
            <font color="black">{</font>
                pFound <font color="black">=</font> apReplace<font color="black">[</font>pFound<font color="black">-</font>pFind<font color="black">]</font>;
                MCD_BLDAPPEND<font color="black">(</font>strText,pFound<font color="black">)</font>;
            <font color="black">}</font>
            <font color="black">+</font><font color="black">+</font>pSource; <font color="green">// ASCII, so 1 byte</font>
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            nCharLen <font color="black">=</font> MCD_CLEN<font color="black">(</font> pSource <font color="black">)</font>;
            MCD_BLDAPPENDN<font color="black">(</font>strText,pSource,nCharLen<font color="black">)</font>;
            pSource <font color="black">+</font><font color="black">=</font> nCharLen;
        <font color="black">}</font>
        cSource <font color="black">=</font> <font color="black">*</font>pSource;
    <font color="black">}</font>

    MCD_BLDRELEASE<font color="black">(</font>strText<font color="black">)</font>;
    <font color="blue">return</font> strText;
<font color="black">}</font>

<font color="green">// Predefined character entities</font>
<font color="green">// By default UnescapeText will decode standard HTML entities as well as the 5 in XML</font>
<font color="green">// To unescape only the 5 standard XML entities, use this short table instead:</font>
<font color="green">// MCD_PCSZ PredefEntityTable[4] =</font>
<font color="green">// { MCD_T("20060lt"),MCD_T("40034quot"),MCD_T("30038amp"),MCD_T("20062gt40039apos") };</font>
<font color="green">//</font>
<font color="green">// This is a precompiled ASCII hash table for speed and minimum memory requirement</font>
<font color="green">// Each entry consists of a 1 digit code name length, 4 digit code point, and the code name</font>
<font color="green">// Each table slot can have multiple entries, table size 130 was chosen for even distribution</font>
<font color="green">//</font>
MCD_PCSZ PredefEntityTable<font color="black">[</font><font color="maroon">130</font><font color="black">]</font> <font color="black">=</font>
<font color="black">{</font>
    MCD_T<font color="black">(</font><font color="maroon">"60216oslash60217ugrave60248oslash60249ugrave"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50937omega60221yacute58968lceil50969omega60253yacute"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50916delta50206icirc50948delta50238icirc68472weierp"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"40185sup1"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"68970lfloor40178sup2"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50922kappa60164curren50954kappa58212mdash40179sup3"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"59830diams58211ndash"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"68855otimes58969rceil"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50338oelig50212ocirc50244ocirc50339oelig58482trade"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50197aring50931sigma50229aring50963sigma"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50180acute68971rfloor50732tilde"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"68249lsaquo"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"58734infin68201thinsp"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"50161iexcl"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50920theta50219ucirc50952theta50251ucirc"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"58254oline"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"58260frasl68727lowast"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"59827clubs60191iquest68250rsaquo"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"58629crarr50181micro"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"58222bdquo"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"58243prime60177plusmn58242prime"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"40914beta40946beta"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"50171laquo50215times"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"40710circ"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"49001lang"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"58220ldquo40175macr"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"40182para50163pound48476real"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"58713notin50187raquo"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"48773cong50223szlig50978upsih"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"58776asymp58801equiv49002rang58218sbquo"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50222thorn48659darr48595darr40402fnof58221rdquo50254thorn"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"40162cent58722minus"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"58707exist40170ordf"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"40921iota58709empty48660harr48596harr40953iota"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"40196auml40228auml48226bull40167sect48838sube"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"48656larr48592larr58853oplus"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"30176deg58216lsquo40186ordm"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"40203euml40039apos40235euml48712isin40160nbsp"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"40918zeta40950zeta"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"38743and48195emsp48719prod"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"30935chi38745cap30967chi48194ensp"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"40207iuml40239iuml48706part48869perp48658rarr48594rarr"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"38736ang48836nsub58217rsquo"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"48901sdot48657uarr48593uarr"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"40169copy48364euro"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"30919eta30951eta"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"40214ouml40246ouml48839supe"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"30038amp30174reg"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"48733prop"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"30208eth30934phi40220uuml30240eth30966phi40252uuml"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"40376yuml40255yuml"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"40034quot48204zwnj"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"38746cup68756there4"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"30929rho30961rho38764sim"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"30932tau38834sub30964tau"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"38747int38206lrm38207rlm"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"30936psi30968psi30165yen"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"28805ge30168uml"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"30982piv"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"30172not"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"28804le"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"30173shy"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"39674loz28800ne38721sum"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"38835sup"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"28715ni"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"20928pi20960pi38205zwj"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"60923lambda20062gt60955lambda"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"60199ccedil60231ccedil"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"20060lt"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"20926xi28744or20958xi"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"20924mu20956mu"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"20925nu20957nu"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"68225dagger68224dagger"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"80977thetasym"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"78501alefsym"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"60193aacute60195atilde60225aacute60227atilde"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"70927omicron60247divide70959omicron"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"60192agrave60224agrave"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"60201eacute60233eacute60962sigmaf"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"70917epsilon70949epsilon"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"60200egrave60232egrave"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"60205iacute60237iacute"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"60204igrave68230hellip60236igrave"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"60166brvbar"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"60209ntilde68704forall58711nabla60241ntilde69824spades"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"60211oacute60213otilde60189frac1260183middot60243oacute60245otilde"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"50184cedil60188frac14"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50198aelig50194acirc60210ograve50226acirc50230aelig60242ograve"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50915gamma60190frac3450947gamma58465image58730radic"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"60352scaron60353scaron"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"60218uacute69829hearts60250uacute"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"50913alpha50202ecirc70933upsilon50945alpha50234ecirc70965upsilon"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"68240permil"</font><font color="black">)</font>
<font color="black">}</font>;

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>UnescapeText<font color="black">(</font> MCD_CSTR szText, <font color="blue">int</font> nTextLength <font color="green">/*=-1*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Convert XML friendly text to text as seen outside XML document</font>
    <font color="green">// ampersand escape codes replaced with special characters e.g. convert "6&gt;7" to "6&#62;7"</font>
    <font color="green">// ampersand numeric codes replaced with character e.g. convert &#60; to &#60;</font>
    <font color="green">// Conveniently the result is always the same or shorter in byte length</font>
    <font color="green">//</font>
    MCD_STR strText;
    MCD_PCSZ pSource <font color="black">=</font> szText;
    <font color="blue">if</font> <font color="black">(</font> nTextLength <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
        nTextLength <font color="black">=</font> MCD_PSZLEN<font color="black">(</font>szText<font color="black">)</font>;
    MCD_BLDRESERVE<font color="black">(</font>strText,nTextLength<font color="black">)</font>;
    MCD_CHAR szCodeName<font color="black">[</font><font color="maroon">10</font><font color="black">]</font>;
    <font color="blue">int</font> nCharLen;
    <font color="blue">int</font> nChar <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">while</font> <font color="black">(</font> nChar <font color="black">&#60;</font> nTextLength <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pSource<font color="black">[</font>nChar<font color="black">]</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">'&'</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Get corresponding unicode code point</font>
            <font color="blue">int</font> nUnicode <font color="black">=</font> <font color="maroon">0</font>;

            <font color="green">// Look for terminating semi-colon within 9 ASCII characters</font>
            <font color="blue">int</font> nCodeLen <font color="black">=</font> <font color="maroon">0</font>;
            MCD_CHAR cCodeChar <font color="black">=</font> pSource<font color="black">[</font>nChar<font color="black">+</font><font color="maroon">1</font><font color="black">]</font>;
            <font color="blue">while</font> <font color="black">(</font> nCodeLen <font color="black">&#60;</font> <font color="maroon">9</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font>cCodeChar<font color="black">)</font> <font color="black">&#60;</font> <font color="maroon">128</font> <font color="black">&</font><font color="black">&</font> cCodeChar <font color="black">!</font><font color="black">=</font> <font color="maroon">';'</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> cCodeChar <font color="black">&#62;</font><font color="black">=</font> <font color="maroon">'A'</font> <font color="black">&</font><font color="black">&</font> cCodeChar <font color="black">&#60;</font><font color="black">=</font> <font color="maroon">'Z'</font><font color="black">)</font> <font color="green">// upper case?</font>
                    cCodeChar <font color="black">+</font><font color="black">=</font> <font color="black">(</font><font color="maroon">'a'</font> <font color="black">-</font><font color="maroon">'A'</font><font color="black">)</font>; <font color="green">// make lower case</font>
                szCodeName<font color="black">[</font>nCodeLen<font color="black">]</font> <font color="black">=</font> cCodeChar;
                <font color="black">+</font><font color="black">+</font>nCodeLen;
                cCodeChar <font color="black">=</font> pSource<font color="black">[</font>nChar<font color="black">+</font><font color="maroon">1</font><font color="black">+</font>nCodeLen<font color="black">]</font>;
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font> cCodeChar <font color="black">=</font><font color="black">=</font> <font color="maroon">';'</font> <font color="black">)</font> <font color="green">// found semi-colon?</font>
            <font color="black">{</font>
                <font color="green">// Decode szCodeName</font>
                szCodeName<font color="black">[</font>nCodeLen<font color="black">]</font> <font color="black">=</font> <font color="maroon">'\0'</font>;
                <font color="blue">if</font> <font color="black">(</font> <font color="black">*</font>szCodeName <font color="black">=</font><font color="black">=</font> <font color="maroon">'#'</font> <font color="black">)</font> <font color="green">// numeric character reference?</font>
                <font color="black">{</font>
                    <font color="green">// Is it a hex number?</font>
                    <font color="blue">int</font> nBase <font color="black">=</font> <font color="maroon">10</font>; <font color="green">// decimal</font>
                    <font color="blue">int</font> nNumberOffset <font color="black">=</font> <font color="maroon">1</font>; <font color="green">// after #</font>
                    <font color="blue">if</font> <font color="black">(</font> szCodeName<font color="black">[</font><font color="maroon">1</font><font color="black">]</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">'x'</font> <font color="black">)</font>
                    <font color="black">{</font>
                        nNumberOffset <font color="black">=</font> <font color="maroon">2</font>; <font color="green">// after #x</font>
                        nBase <font color="black">=</font> <font color="maroon">16</font>; <font color="green">// hex</font>
                    <font color="black">}</font>
                    nUnicode <font color="black">=</font> MCD_PSZTOL<font color="black">(</font> <font color="black">&</font>szCodeName<font color="black">[</font>nNumberOffset<font color="black">]</font>, NULL, nBase <font color="black">)</font>;
                <font color="black">}</font>
                <font color="blue">else</font> <font color="green">// does not start with #</font>
                <font color="black">{</font>
                    <font color="green">// Look for matching code name in PredefEntityTable</font>
                    MCD_PCSZ pEntry <font color="black">=</font> PredefEntityTable<font color="black">[</font>x_Hash<font color="black">(</font>szCodeName,<font color="blue">sizeof</font><font color="black">(</font>PredefEntityTable<font color="black">)</font><font color="black">/</font><font color="blue">sizeof</font><font color="black">(</font>MCD_PCSZ<font color="black">)</font><font color="black">)</font><font color="black">]</font>;
                    <font color="blue">while</font> <font color="black">(</font> <font color="black">*</font>pEntry <font color="black">)</font>
                    <font color="black">{</font>
                        <font color="green">// e.g. entry: 40039apos means length 4, code point 0039, code name apos</font>
                        <font color="blue">int</font> nEntryLen <font color="black">=</font> <font color="black">(</font><font color="black">*</font>pEntry <font color="black">-</font><font color="maroon">'0'</font><font color="black">)</font>;
                        <font color="black">+</font><font color="black">+</font>pEntry;
                        MCD_PCSZ pCodePoint <font color="black">=</font> pEntry;
                        pEntry <font color="black">+</font><font color="black">=</font> <font color="maroon">4</font>;
                        <font color="blue">if</font> <font color="black">(</font> nEntryLen <font color="black">=</font><font color="black">=</font> nCodeLen <font color="black">&</font><font color="black">&</font> MCD_PSZNCMP<font color="black">(</font>szCodeName,pEntry,nEntryLen<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
                        <font color="black">{</font>
                            <font color="green">// Convert digits to integer up to code name which always starts with alpha </font>
                            nUnicode <font color="black">=</font> MCD_PSZTOL<font color="black">(</font> pCodePoint, NULL, <font color="maroon">10</font> <font color="black">)</font>;
                            <font color="blue">break</font>;
                        <font color="black">}</font>
                        pEntry <font color="black">+</font><font color="black">=</font> nEntryLen;
                    <font color="black">}</font>
                <font color="black">}</font>
            <font color="black">}</font>

            <font color="green">// If a code point found, encode it into text</font>
            <font color="blue">if</font> <font color="black">(</font> nUnicode <font color="black">)</font>
            <font color="black">{</font>
                MCD_CHAR szChar<font color="black">[</font><font color="maroon">5</font><font color="black">]</font>;
                nCharLen <font color="black">=</font> <font color="maroon">0</font>;
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WCHAR<font color="black">)</font> <font color="green">// WCHAR</font>
<font color="blue">#if</font> MARKUP_SIZEOFWCHAR <font color="black">=</font><font color="black">=</font> <font color="maroon">4</font> <font color="green">// sizeof(wchar_t) == 4</font>
                szChar<font color="black">[</font><font color="maroon">0</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font>MCD_CHAR<font color="black">)</font>nUnicode;
                nCharLen <font color="black">=</font> <font color="maroon">1</font>;
<font color="blue">#else</font> <font color="green">// sizeof(wchar_t) == 2</font>
                EncodeCharUTF16<font color="black">(</font> nUnicode, <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>szChar, nCharLen <font color="black">)</font>;
<font color="blue">#endif</font>
<font color="blue">#elif</font> defined<font color="black">(</font>MARKUP_MBCS<font color="black">)</font> <font color="green">// MBCS/double byte</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WINCONV<font color="black">)</font>
                <font color="blue">int</font> nUsedDefaultChar <font color="black">=</font> <font color="maroon">0</font>;
                wchar_t wszUTF16<font color="black">[</font><font color="maroon">2</font><font color="black">]</font>;
                EncodeCharUTF16<font color="black">(</font> nUnicode, <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>wszUTF16, nCharLen <font color="black">)</font>;
                nCharLen <font color="black">=</font> WideCharToMultiByte<font color="black">(</font> CP_ACP, <font color="maroon">0</font>, wszUTF16, nCharLen, szChar, <font color="maroon">5</font>, NULL, <font color="black">&</font>nUsedDefaultChar <font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> nUsedDefaultChar <font color="black">|</font><font color="black">|</font> nCharLen <font color="black">&#60;</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
                    nUnicode <font color="black">=</font> <font color="maroon">0</font>;
<font color="blue">#else</font> <font color="green">// not WINCONV</font>
                wchar_t wcUnicode <font color="black">=</font> <font color="black">(</font>wchar_t<font color="black">)</font>nUnicode;
                nCharLen <font color="black">=</font> wctomb<font color="black">(</font> szChar, wcUnicode <font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> nCharLen <font color="black">&#60;</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
                    nUnicode <font color="black">=</font> <font color="maroon">0</font>;
<font color="blue">#endif</font> <font color="green">// not WINCONV</font>
<font color="blue">#else</font> <font color="green">// not WCHAR and not MBCS/double byte</font>
                EncodeCharUTF8<font color="black">(</font> nUnicode, szChar, nCharLen <font color="black">)</font>;
<font color="blue">#endif</font> <font color="green">// not WCHAR and not MBCS/double byte</font>
                <font color="green">// Increment index past ampersand semi-colon</font>
                <font color="blue">if</font> <font color="black">(</font> nUnicode <font color="black">)</font> <font color="green">// must check since MBCS case can clear it</font>
                <font color="black">{</font>
                    MCD_BLDAPPENDN<font color="black">(</font>strText,szChar,nCharLen<font color="black">)</font>;
                    nChar <font color="black">+</font><font color="black">=</font> nCodeLen <font color="black">+</font> <font color="maroon">2</font>;
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> nUnicode <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// If the code is not converted, leave it as is</font>
                MCD_BLDAPPEND1<font color="black">(</font>strText,<font color="maroon">'&'</font><font color="black">)</font>;
                <font color="black">+</font><font color="black">+</font>nChar;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="green">// not &</font>
        <font color="black">{</font>
            nCharLen <font color="black">=</font> MCD_CLEN<font color="black">(</font><font color="black">&</font>pSource<font color="black">[</font>nChar<font color="black">]</font><font color="black">)</font>;
            MCD_BLDAPPENDN<font color="black">(</font>strText,<font color="black">&</font>pSource<font color="black">[</font>nChar<font color="black">]</font>,nCharLen<font color="black">)</font>;
            nChar <font color="black">+</font><font color="black">=</font> nCharLen;
        <font color="black">}</font>
    <font color="black">}</font>
    MCD_BLDRELEASE<font color="black">(</font>strText<font color="black">)</font>;
    <font color="blue">return</font> strText;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>DetectUTF8<font color="black">(</font> <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> pText, <font color="blue">int</font> nTextLen, <font color="blue">int</font><font color="black">*</font> pnNonASCII<font color="green">/*=NULL*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// return true if ASCII or all non-ASCII byte sequences are valid UTF-8 pattern:</font>
    <font color="green">// ASCII   0xxxxxxx</font>
    <font color="green">// 2-byte  110xxxxx 10xxxxxx</font>
    <font color="green">// 3-byte  1110xxxx 10xxxxxx 10xxxxxx</font>
    <font color="green">// 4-byte  11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</font>
    <font color="green">// *pnNonASCII is set (if pnNonASCII is not NULL) to the number of non-ASCII UTF-8 sequences</font>
    <font color="green">// or if an invalid UTF-8 sequence is found, to 1 + the valid sequences up to the invalid sequence</font>
    <font color="blue">int</font> nUChar;
    <font color="blue">if</font> <font color="black">(</font> pnNonASCII <font color="black">)</font>
        <font color="black">*</font>pnNonASCII <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> pTextEnd <font color="black">=</font> pText <font color="black">+</font> nTextLen;
    <font color="blue">while</font> <font color="black">(</font> <font color="black">*</font>pText <font color="black">&</font><font color="black">&</font> pText <font color="black">!</font><font color="black">=</font> pTextEnd <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">*</font>pText<font color="black">)</font> <font color="black">&</font> <font color="maroon">0x80</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> pnNonASCII <font color="black">)</font>
                <font color="black">+</font><font color="black">+</font><font color="black">(</font><font color="black">*</font>pnNonASCII<font color="black">)</font>;
            nUChar <font color="black">=</font> DecodeCharUTF8<font color="black">(</font> pText, pTextEnd <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
                <font color="blue">return</font> <font color="blue">false</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
            <font color="black">+</font><font color="black">+</font>pText;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>DecodeCharUTF8<font color="black">(</font> <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">&</font> pszUTF8, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> pszUTF8End<font color="green">/*=NULL*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Return Unicode code point and increment pszUTF8 past 1-4 bytes</font>
    <font color="green">// pszUTF8End can be NULL if pszUTF8 is null terminated</font>
    <font color="blue">int</font> nUChar <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">char</font><font color="black">)</font><font color="black">*</font>pszUTF8;
    <font color="black">+</font><font color="black">+</font>pszUTF8;
    <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">&</font> <font color="maroon">0x80</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">int</font> nExtraChars;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>nUChar <font color="black">&</font> <font color="maroon">0x20</font><font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            nExtraChars <font color="black">=</font> <font color="maroon">1</font>;
            nUChar <font color="black">&</font><font color="black">=</font> <font color="maroon">0x1f</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>nUChar <font color="black">&</font> <font color="maroon">0x10</font><font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            nExtraChars <font color="black">=</font> <font color="maroon">2</font>;
            nUChar <font color="black">&</font><font color="black">=</font> <font color="maroon">0x0f</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>nUChar <font color="black">&</font> <font color="maroon">0x08</font><font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            nExtraChars <font color="black">=</font> <font color="maroon">3</font>;
            nUChar <font color="black">&</font><font color="black">=</font> <font color="maroon">0x07</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
            <font color="blue">return</font> <font color="maroon">-1</font>;
        <font color="blue">while</font> <font color="black">(</font> nExtraChars<font color="black">-</font><font color="black">-</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> pszUTF8 <font color="black">=</font><font color="black">=</font> pszUTF8End <font color="black">|</font><font color="black">|</font> <font color="black">!</font> <font color="black">(</font><font color="black">*</font>pszUTF8 <font color="black">&</font> <font color="maroon">0x80</font><font color="black">)</font> <font color="black">)</font>
                <font color="blue">return</font> <font color="maroon">-1</font>;
            nUChar <font color="black">=</font> nUChar<font color="black">&#60;</font><font color="black">&#60;</font><font color="maroon">6</font>;
            nUChar <font color="black">|</font><font color="black">=</font> <font color="black">*</font>pszUTF8 <font color="black">&</font> <font color="maroon">0x3f</font>;
            <font color="black">+</font><font color="black">+</font>pszUTF8;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> nUChar;
<font color="black">}</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font>EncodeCharUTF16<font color="black">(</font> <font color="blue">int</font> nUChar, <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pwszUTF16, <font color="blue">int</font><font color="black">&</font> nUTF16Len <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Write UTF-16 sequence to pwszUTF16 for Unicode code point nUChar and update nUTF16Len</font>
    <font color="green">// Be sure pwszUTF16 has room for up to 2 wide chars</font>
    <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">&</font> ~<font color="maroon">0xffff</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pwszUTF16 <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Surrogate pair</font>
            nUChar <font color="black">-</font><font color="black">=</font> <font color="maroon">0x10000</font>;
            pwszUTF16<font color="black">[</font>nUTF16Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font>wchar_t<font color="black">)</font><font color="black">(</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">10</font><font color="black">)</font> <font color="black">&</font> <font color="maroon">0x3ff</font><font color="black">)</font> <font color="black">|</font> <font color="maroon">0xd800</font><font color="black">)</font>; <font color="green">// W1</font>
            pwszUTF16<font color="black">[</font>nUTF16Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font>wchar_t<font color="black">)</font><font color="black">(</font><font color="black">(</font>nUChar <font color="black">&</font> <font color="maroon">0x3ff</font><font color="black">)</font> <font color="black">|</font> <font color="maroon">0xdc00</font><font color="black">)</font>; <font color="green">// W2</font>
        <font color="black">}</font>
        <font color="blue">else</font>
            nUTF16Len <font color="black">+</font><font color="black">=</font> <font color="maroon">2</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pwszUTF16 <font color="black">)</font>
            pwszUTF16<font color="black">[</font>nUTF16Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font>wchar_t<font color="black">)</font>nUChar;
        <font color="blue">else</font>
            <font color="black">+</font><font color="black">+</font>nUTF16Len;
    <font color="black">}</font>
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>DecodeCharUTF16<font color="black">(</font> <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">&</font> pwszUTF16, <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pszUTF16End<font color="green">/*=NULL*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Return Unicode code point and increment pwszUTF16 past 1 or 2 (if surrogrates) UTF-16 code points</font>
    <font color="green">// pszUTF16End can be NULL if pszUTF16 is zero terminated</font>
    <font color="blue">int</font> nUChar <font color="black">=</font> <font color="black">*</font>pwszUTF16;
    <font color="black">+</font><font color="black">+</font>pwszUTF16;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>nUChar <font color="black">&</font> ~<font color="maroon">0x000007ff</font><font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0xd800</font> <font color="black">)</font> <font color="green">// W1</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pwszUTF16 <font color="black">=</font><font color="black">=</font> pszUTF16End <font color="black">|</font><font color="black">|</font> <font color="black">!</font> <font color="black">(</font><font color="black">*</font>pwszUTF16<font color="black">)</font> <font color="black">)</font> <font color="green">// W2</font>
            <font color="blue">return</font> <font color="maroon">-1</font>; <font color="green">// incorrect UTF-16</font>
        nUChar <font color="black">=</font> <font color="black">(</font><font color="black">(</font><font color="black">(</font>nUChar <font color="black">&</font> <font color="maroon">0x3ff</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">10</font><font color="black">)</font> <font color="black">|</font> <font color="black">(</font><font color="black">*</font>pwszUTF16 <font color="black">&</font> <font color="maroon">0x3ff</font><font color="black">)</font><font color="black">)</font> <font color="black">+</font> <font color="maroon">0x10000</font>;
        <font color="black">+</font><font color="black">+</font>pwszUTF16;
    <font color="black">}</font>
    <font color="blue">return</font> nUChar;
<font color="black">}</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font>EncodeCharUTF8<font color="black">(</font> <font color="blue">int</font> nUChar, <font color="blue">char</font><font color="black">*</font> pszUTF8, <font color="blue">int</font><font color="black">&</font> nUTF8Len <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Write UTF-8 sequence to pszUTF8 for Unicode code point nUChar and update nUTF8Len</font>
    <font color="green">// Be sure pszUTF8 has room for up to 4 bytes</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>nUChar <font color="black">&</font> ~<font color="maroon">0x0000007f</font><font color="black">)</font> <font color="black">)</font> <font color="green">// &#60; 0x80</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pszUTF8 <font color="black">)</font>
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font>nUChar;
        <font color="blue">else</font>
            <font color="black">+</font><font color="black">+</font>nUTF8Len;
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>nUChar <font color="black">&</font> ~<font color="maroon">0x000007ff</font><font color="black">)</font> <font color="black">)</font> <font color="green">// &#60; 0x800</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pszUTF8 <font color="black">)</font>
        <font color="black">{</font>
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&</font><font color="maroon">0x7c0</font><font color="black">)</font><font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">6</font><font color="black">)</font><font color="black">|</font><font color="maroon">0xc0</font><font color="black">)</font>;
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&</font><font color="maroon">0x3f</font><font color="black">)</font><font color="black">|</font><font color="maroon">0x80</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
            nUTF8Len <font color="black">+</font><font color="black">=</font> <font color="maroon">2</font>;
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>nUChar <font color="black">&</font> ~<font color="maroon">0x0000ffff</font><font color="black">)</font> <font color="black">)</font> <font color="green">// &#60; 0x10000</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pszUTF8 <font color="black">)</font>
        <font color="black">{</font>
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&</font><font color="maroon">0xf000</font><font color="black">)</font><font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">12</font><font color="black">)</font><font color="black">|</font><font color="maroon">0xe0</font><font color="black">)</font>;
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&</font><font color="maroon">0xfc0</font><font color="black">)</font><font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">6</font><font color="black">)</font><font color="black">|</font><font color="maroon">0x80</font><font color="black">)</font>;
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&</font><font color="maroon">0x3f</font><font color="black">)</font><font color="black">|</font><font color="maroon">0x80</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
            nUTF8Len <font color="black">+</font><font color="black">=</font> <font color="maroon">3</font>;
    <font color="black">}</font>
    <font color="blue">else</font> <font color="green">// &#60; 0x110000</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pszUTF8 <font color="black">)</font>
        <font color="black">{</font>
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&</font><font color="maroon">0x1c0000</font><font color="black">)</font><font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">18</font><font color="black">)</font><font color="black">|</font><font color="maroon">0xf0</font><font color="black">)</font>;
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&</font><font color="maroon">0x3f000</font><font color="black">)</font><font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">12</font><font color="black">)</font><font color="black">|</font><font color="maroon">0x80</font><font color="black">)</font>;
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&</font><font color="maroon">0xfc0</font><font color="black">)</font><font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">6</font><font color="black">)</font><font color="black">|</font><font color="maroon">0x80</font><font color="black">)</font>;
            pszUTF8<font color="black">[</font>nUTF8Len<font color="black">+</font><font color="black">+</font><font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font><font color="black">(</font><font color="black">(</font>nUChar<font color="black">&</font><font color="maroon">0x3f</font><font color="black">)</font><font color="black">|</font><font color="maroon">0x80</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
            nUTF8Len <font color="black">+</font><font color="black">=</font> <font color="maroon">4</font>;
    <font color="black">}</font>
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>UTF16To8<font color="black">(</font> <font color="blue">char</font><font color="black">*</font> pszUTF8, <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pwszUTF16, <font color="blue">int</font> nUTF8Count <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Supports the same arguments as wcstombs</font>
    <font color="green">// the pwszUTF16 source must be a NULL-terminated UTF-16 string</font>
    <font color="green">// if pszUTF8 is NULL, the number of bytes required is returned and nUTF8Count is ignored</font>
    <font color="green">// otherwise pszUTF8 is filled with the result string and NULL-terminated if nUTF8Count allows</font>
    <font color="green">// nUTF8Count is the byte size of pszUTF8 and must be large enough for the NULL if NULL desired</font>
    <font color="green">// and the number of bytes (excluding NULL) is returned</font>
    <font color="green">//</font>
    <font color="blue">int</font> nUChar, nUTF8Len <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">while</font> <font color="black">(</font> <font color="black">*</font>pwszUTF16 <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Decode UTF-16</font>
        nUChar <font color="black">=</font> DecodeCharUTF16<font color="black">(</font> pwszUTF16, NULL <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
            nUChar <font color="black">=</font> <font color="maroon">'?'</font>;

        <font color="green">// Encode UTF-8</font>
        <font color="blue">if</font> <font color="black">(</font> pszUTF8 <font color="black">&</font><font color="black">&</font> nUTF8Len <font color="black">+</font> <font color="maroon">4</font> <font color="black">&#62;</font> nUTF8Count <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">int</font> nUTF8LenSoFar <font color="black">=</font> nUTF8Len;
            EncodeCharUTF8<font color="black">(</font> nUChar, NULL, nUTF8Len <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> nUTF8Len <font color="black">&#62;</font> nUTF8Count <font color="black">)</font>
                <font color="blue">return</font> nUTF8LenSoFar;
            nUTF8Len <font color="black">=</font> nUTF8LenSoFar;
        <font color="black">}</font>
        EncodeCharUTF8<font color="black">(</font> nUChar, pszUTF8, nUTF8Len <font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font> pszUTF8 <font color="black">&</font><font color="black">&</font> nUTF8Len <font color="black">&#60;</font> nUTF8Count <font color="black">)</font>
        pszUTF8<font color="black">[</font>nUTF8Len<font color="black">]</font> <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">return</font> nUTF8Len;
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>UTF8To16<font color="black">(</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pwszUTF16, <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> pszUTF8, <font color="blue">int</font> nUTF8Count <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Supports the same arguments as mbstowcs</font>
    <font color="green">// the pszUTF8 source must be a UTF-8 string which will be processed up to NULL-terminator or nUTF8Count</font>
    <font color="green">// if pwszUTF16 is NULL, the number of UTF-16 chars required is returned</font>
    <font color="green">// nUTF8Count is maximum UTF-8 bytes to convert and should include NULL if NULL desired in result</font>
    <font color="green">// if pwszUTF16 is not NULL it is filled with the result string and it must be large enough</font>
    <font color="green">// result will be NULL-terminated if NULL encountered in pszUTF8 before nUTF8Count</font>
    <font color="green">// and the number of UTF-8 bytes converted is returned</font>
    <font color="green">//</font>
    <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> pszPosUTF8 <font color="black">=</font> pszUTF8;
    <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> pszUTF8End <font color="black">=</font> pszUTF8 <font color="black">+</font> nUTF8Count;
    <font color="blue">int</font> nUChar, nUTF8Len <font color="black">=</font> <font color="maroon">0</font>, nUTF16Len <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">while</font> <font color="black">(</font> pszPosUTF8 <font color="black">!</font><font color="black">=</font> pszUTF8End <font color="black">)</font>
    <font color="black">{</font>
        nUChar <font color="black">=</font> DecodeCharUTF8<font color="black">(</font> pszPosUTF8, pszUTF8End <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> nUChar <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> pwszUTF16 <font color="black">)</font>
                pwszUTF16<font color="black">[</font>nUTF16Len<font color="black">]</font> <font color="black">=</font> <font color="maroon">0</font>;
            <font color="blue">break</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
            nUChar <font color="black">=</font> <font color="maroon">'?'</font>;

        <font color="green">// Encode UTF-16</font>
        EncodeCharUTF16<font color="black">(</font> nUChar, pwszUTF16, nUTF16Len <font color="black">)</font>;
    <font color="black">}</font>
    nUTF8Len <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pszPosUTF8 <font color="black">-</font>pszUTF8<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> pwszUTF16 <font color="black">)</font>
        <font color="blue">return</font> nUTF16Len;
    <font color="blue">return</font> nUTF8Len;
<font color="black">}</font>

<font color="blue">#if</font> <font color="black">!</font> defined<font color="black">(</font>MARKUP_WCHAR<font color="black">)</font> <font color="green">// not WCHAR</font>
MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>UTF8ToA<font color="black">(</font> MCD_CSTR pszUTF8, <font color="blue">int</font><font color="black">*</font> pnFailed<font color="green">/*=NULL*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Converts from UTF-8 to locale ANSI charset</font>
    MCD_STR strANSI;
    <font color="blue">int</font> nMBLen <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font>MCD_PSZLEN<font color="black">(</font> pszUTF8 <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> pnFailed <font color="black">)</font>
        <font color="black">*</font>pnFailed <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">if</font> <font color="black">(</font> nMBLen <font color="black">)</font>
    <font color="black">{</font>
        ConvertEncoding convert<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"UTF-8"</font><font color="black">)</font>, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pszUTF8, nMBLen <font color="black">)</font>;
        convert.nToCount <font color="black">=</font> nMBLen;
        MCD_CHAR<font color="black">*</font> pANSIBuffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strANSI,convert.nToCount<font color="black">)</font>;
        nMBLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pANSIBuffer <font color="black">)</font>;
        MCD_RELEASEBUFFER<font color="black">(</font>strANSI,pANSIBuffer,nMBLen<font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> pnFailed <font color="black">)</font>
            <font color="black">*</font>pnFailed <font color="black">=</font> convert.nFailedChars;
    <font color="black">}</font>
    <font color="blue">return</font> strANSI;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>AToUTF8<font color="black">(</font> MCD_CSTR pszANSI <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Converts locale ANSI charset to UTF-8</font>
    MCD_STR strUTF8;
    <font color="blue">int</font> nMBLen <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font>MCD_PSZLEN<font color="black">(</font> pszANSI <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> nMBLen <font color="black">)</font>
    <font color="black">{</font>
        ConvertEncoding convert<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"UTF-8"</font><font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pszANSI, nMBLen <font color="black">)</font>;
        convert.nToCount <font color="black">=</font> nMBLen <font color="black">*</font> <font color="maroon">4</font>;
        MCD_CHAR<font color="black">*</font> pUTF8Buffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strUTF8,convert.nToCount<font color="black">)</font>;
        nMBLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pUTF8Buffer <font color="black">)</font>;
        MCD_RELEASEBUFFER<font color="black">(</font>strUTF8,pUTF8Buffer,nMBLen<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> strUTF8;
<font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// not WCHAR</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>GetDeclaredEncoding<font color="black">(</font> MCD_CSTR szDoc <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Extract encoding attribute from XML Declaration, or HTML meta charset</font>
    MCD_STR strEncoding;
    TokenPos token<font color="black">(</font> szDoc, MDF_IGNORECASE <font color="black">)</font>;
    NodePos node;
    <font color="blue">bool</font> bHtml <font color="black">=</font> <font color="blue">false</font>;
    <font color="blue">int</font> nTypeFound <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">while</font> <font color="black">(</font> nTypeFound <font color="black">&#62;</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
    <font color="black">{</font>
        nTypeFound <font color="black">=</font> x_ParseNode<font color="black">(</font> token, node <font color="black">)</font>;
        <font color="blue">int</font> nNext <font color="black">=</font> token.nNext;
        <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> MNT_PROCESSING_INSTRUCTION <font color="black">&</font><font color="black">&</font> token.nL <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
        <font color="black">{</font>
            token.nNext <font color="black">=</font> node.nStart <font color="black">+</font> <font color="maroon">2</font>; <font color="green">// after &#60;?</font>
            <font color="blue">if</font> <font color="black">(</font> x_FindName<font color="black">(</font>token<font color="black">)</font> <font color="black">&</font><font color="black">&</font> token.Match<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">"xml"</font><font color="black">)</font><font color="black">)</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// e.g. &#60;?xml version="1.0" encoding="UTF-8"?&#62;</font>
                <font color="blue">if</font> <font color="black">(</font> x_FindAttrib<font color="black">(</font> token, MCD_T<font color="black">(</font><font color="maroon">"encoding"</font><font color="black">)</font> <font color="black">)</font> <font color="black">)</font>
                    strEncoding <font color="black">=</font> x_GetToken<font color="black">(</font> token <font color="black">)</font>;
                <font color="blue">break</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font> <font color="green">// end tag</font>
        <font color="black">{</font>
            <font color="green">// Check for end of HTML head</font>
            token.nNext <font color="black">=</font> node.nStart <font color="black">+</font> <font color="maroon">2</font>; <font color="green">// after &#60;/</font>
            <font color="blue">if</font> <font color="black">(</font> x_FindName<font color="black">(</font>token<font color="black">)</font> <font color="black">&</font><font color="black">&</font> token.Match<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">"head"</font><font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                <font color="blue">break</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
        <font color="black">{</font>
            token.nNext <font color="black">=</font> node.nStart <font color="black">+</font> <font color="maroon">1</font>; <font color="green">// after &#60;</font>
            x_FindName<font color="black">(</font> token <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> bHtml <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> token.Match<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">"html"</font><font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                    <font color="blue">break</font>;
                bHtml <font color="black">=</font> <font color="blue">true</font>;
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> token.Match<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">"meta"</font><font color="black">)</font><font color="black">)</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// e.g. &#60;META http-equiv=Content-Type content="text/html; charset=UTF-8"&#62;</font>
                <font color="blue">int</font> nAttribOffset <font color="black">=</font> node.nStart <font color="black">+</font> <font color="maroon">1</font>;
                token.nNext <font color="black">=</font> nAttribOffset;
                <font color="blue">if</font> <font color="black">(</font> x_FindAttrib<font color="black">(</font>token,MCD_T<font color="black">(</font><font color="maroon">"http-equiv"</font><font color="black">)</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> token.Match<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">"Content-Type"</font><font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                <font color="black">{</font>
                    token.nNext <font color="black">=</font> nAttribOffset;
                    <font color="blue">if</font> <font color="black">(</font> x_FindAttrib<font color="black">(</font>token,MCD_T<font color="black">(</font><font color="maroon">"content"</font><font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                    <font color="black">{</font>
                        <font color="blue">int</font> nContentEndOffset <font color="black">=</font> token.nNext;
                        token.nNext <font color="black">=</font> token.nL;
                        <font color="blue">while</font> <font color="black">(</font> token.nNext <font color="black">&#60;</font> nContentEndOffset <font color="black">&</font><font color="black">&</font> x_FindName<font color="black">(</font>token<font color="black">)</font> <font color="black">)</font>
                        <font color="black">{</font>
                            <font color="blue">if</font> <font color="black">(</font> token.Match<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">"charset"</font><font color="black">)</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> x_FindName<font color="black">(</font>token<font color="black">)</font> <font color="black">&</font><font color="black">&</font> token.Match<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">"="</font><font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                            <font color="black">{</font>
                                x_FindName<font color="black">(</font> token <font color="black">)</font>;
                                strEncoding <font color="black">=</font> x_GetToken<font color="black">(</font> token <font color="black">)</font>;
                                <font color="blue">break</font>;
                            <font color="black">}</font>
                        <font color="black">}</font>
                    <font color="black">}</font>
                    <font color="blue">break</font>;
                <font color="black">}</font>
            <font color="black">}</font>
        <font color="black">}</font>
        token.nNext <font color="black">=</font> nNext;
    <font color="black">}</font>
    <font color="blue">return</font> strEncoding;
<font color="black">}</font>


<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>FindNode<font color="black">(</font> <font color="blue">int</font> nType <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Change current node position only if a node is found</font>
    <font color="green">// If nType is 0 find any node, otherwise find node of type nType</font>
    <font color="green">// Return type of node or 0 if not found</font>
    <font color="green">// If found node is an element, change m_iPos</font>

    <font color="green">// Determine where in document to start scanning for node</font>
    <font color="blue">int</font> nTypeFound <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> nNodeOffset <font color="black">=</font> m_nNodeOffset;
    <font color="blue">if</font> <font color="black">(</font> m_nNodeType <font color="black">&#62;</font> <font color="maroon">1</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// By-pass current node</font>
        nNodeOffset <font color="black">+</font><font color="black">=</font> m_nNodeLength;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="green">// Set position to begin looking for node</font>
        nNodeOffset <font color="black">=</font> <font color="maroon">0</font>; <font color="green">// default to start of document</font>
        <font color="blue">if</font> <font color="black">(</font> m_iPos <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// After element</font>
            nNodeOffset <font color="black">=</font> m_aPos<font color="black">[</font>m_iPos<font color="black">]</font>.StartAfter<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> m_iPosParent <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Immediately after start tag of parent</font>
            <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>m_iPosParent<font color="black">]</font>.IsEmptyElement<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
                <font color="blue">return</font> <font color="maroon">0</font>;
            <font color="blue">else</font>
                nNodeOffset <font color="black">=</font> m_aPos<font color="black">[</font>m_iPosParent<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>

    <font color="green">// Get nodes until we find what we're looking for</font>
    <font color="blue">int</font> iPosNew <font color="black">=</font> m_iPos;
    TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
    NodePos node;
    token.nNext <font color="black">=</font> nNodeOffset;
    <font color="blue">do</font>
    <font color="black">{</font>
        nNodeOffset <font color="black">=</font> token.nNext;
        nTypeFound <font color="black">=</font> x_ParseNode<font color="black">(</font> token, node <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Check if we have reached the end of the parent element</font>
            <font color="green">// Otherwise it is a lone end tag</font>
            <font color="blue">if</font> <font color="black">(</font> m_iPosParent <font color="black">&</font><font color="black">&</font> nNodeOffset <font color="black">=</font><font color="black">=</font> m_aPos<font color="black">[</font>m_iPosParent<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>
                    <font color="black">+</font> m_aPos<font color="black">[</font>m_iPosParent<font color="black">]</font>.ContentLen<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
                <font color="blue">return</font> <font color="maroon">0</font>;
            nTypeFound <font color="black">=</font> MNT_LONE_END_TAG;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">&#60;</font> <font color="maroon">0</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> <font color="maroon">-2</font> <font color="black">)</font>
                <font color="blue">return</font> <font color="maroon">0</font>;
            <font color="green">// -1 is node error</font>
            nTypeFound <font color="black">=</font> MNT_NODE_ERROR;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> iPosNew <font color="black">)</font>
                iPosNew <font color="black">=</font> m_aPos<font color="black">[</font>iPosNew<font color="black">]</font>.iElemNext;
            <font color="blue">else</font>
                iPosNew <font color="black">=</font> m_aPos<font color="black">[</font>m_iPosParent<font color="black">]</font>.iElemChild;
            <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> iPosNew <font color="black">)</font>
                <font color="blue">return</font> <font color="maroon">0</font>;
            <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> nType <font color="black">|</font><font color="black">|</font> <font color="black">(</font>nType <font color="black">&</font> nTypeFound<font color="black">)</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// Found element node, move position to this element</font>
                x_SetPos<font color="black">(</font> m_iPosParent, iPosNew, <font color="maroon">0</font> <font color="black">)</font>;
                <font color="blue">return</font> m_nNodeType;
            <font color="black">}</font>
            token.nNext <font color="black">=</font> m_aPos<font color="black">[</font>iPosNew<font color="black">]</font>.StartAfter<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">while</font> <font color="black">(</font> nType <font color="black">&</font><font color="black">&</font> <font color="black">!</font> <font color="black">(</font>nType <font color="black">&</font> nTypeFound<font color="black">)</font> <font color="black">)</font>;

    m_iPos <font color="black">=</font> iPosNew;
    m_iPosChild <font color="black">=</font> <font color="maroon">0</font>;
    m_nNodeOffset <font color="black">=</font> nNodeOffset;
    m_nNodeLength <font color="black">=</font> token.nNext <font color="black">-</font>nNodeOffset;
    m_nNodeType <font color="black">=</font> nTypeFound;
    MARKUP_SETDEBUGSTATE;
    <font color="blue">return</font> m_nNodeType;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>RemoveNode<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> m_iPos <font color="black">|</font><font color="black">|</font> m_nNodeLength <font color="black">)</font>
    <font color="black">{</font>
        x_RemoveNode<font color="black">(</font> m_iPosParent, m_iPos, m_nNodeType, m_nNodeOffset, m_nNodeLength <font color="black">)</font>;
        m_iPosChild <font color="black">=</font> <font color="maroon">0</font>;
        MARKUP_SETDEBUGSTATE;
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>GetTagName<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="green">// Return the tag name at the current main position</font>
    MCD_STR strTagName;

    <font color="green">// This method is primarily for elements, however</font>
    <font color="green">// it does return something for certain other nodes</font>
    <font color="blue">if</font> <font color="black">(</font> m_nNodeLength <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">switch</font> <font color="black">(</font> m_nNodeType <font color="black">)</font>
        <font color="black">{</font>
        <font color="blue">case</font> MNT_PROCESSING_INSTRUCTION<font color="black">:</font>
        <font color="blue">case</font> MNT_LONE_END_TAG<font color="black">:</font>
            <font color="black">{</font>
                <font color="green">// &#60;?target or &#60;/tagname</font>
                TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
                token.nNext <font color="black">=</font> m_nNodeOffset <font color="black">+</font> <font color="maroon">2</font>;
                <font color="blue">if</font> <font color="black">(</font> x_FindName<font color="black">(</font>token<font color="black">)</font> <font color="black">)</font>
                    strTagName <font color="black">=</font> x_GetToken<font color="black">(</font> token <font color="black">)</font>;
            <font color="black">}</font>
            <font color="blue">break</font>;
        <font color="blue">case</font> MNT_COMMENT<font color="black">:</font>
            strTagName <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"#comment"</font><font color="black">)</font>;
            <font color="blue">break</font>;
        <font color="blue">case</font> MNT_CDATA_SECTION<font color="black">:</font>
            strTagName <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"#cdata-section"</font><font color="black">)</font>;
            <font color="blue">break</font>;
        <font color="blue">case</font> MNT_DOCUMENT_TYPE<font color="black">:</font>
            <font color="black">{</font>
                <font color="green">// &#60;!DOCTYPE name</font>
                TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
                token.nNext <font color="black">=</font> m_nNodeOffset <font color="black">+</font> <font color="maroon">2</font>;
                <font color="blue">if</font> <font color="black">(</font> x_FindName<font color="black">(</font>token<font color="black">)</font> <font color="black">&</font><font color="black">&</font> x_FindName<font color="black">(</font>token<font color="black">)</font> <font color="black">)</font>
                    strTagName <font color="black">=</font> x_GetToken<font color="black">(</font> token <font color="black">)</font>;
            <font color="black">}</font>
            <font color="blue">break</font>;
        <font color="blue">case</font> MNT_TEXT<font color="black">:</font>
        <font color="blue">case</font> MNT_WHITESPACE<font color="black">:</font>
            strTagName <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"#text"</font><font color="black">)</font>;
            <font color="blue">break</font>;
        <font color="black">}</font>
        <font color="blue">return</font> strTagName;
    <font color="black">}</font>

    <font color="blue">if</font> <font color="black">(</font> m_iPos <font color="black">)</font>
        strTagName <font color="black">=</font> x_GetTagName<font color="black">(</font> m_iPos <font color="black">)</font>;
    <font color="blue">return</font> strTagName;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>IntoElem<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="green">// If there is no child position and IntoElem is called it will succeed in release 6.3</font>
    <font color="green">// (A subsequent call to FindElem will find the first element)</font>
    <font color="green">// The following short-hand behavior was never part of EDOM and was misleading</font>
    <font color="green">// It would find a child element if there was no current child element position and go into it</font>
    <font color="green">// It is removed in release 6.3, this change is NOT backwards compatible!</font>
    <font color="green">// if ( ! m_iPosChild )</font>
    <font color="green">//  FindChildElem();</font>

    <font color="blue">if</font> <font color="black">(</font> m_iPos <font color="black">&</font><font color="black">&</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
    <font color="black">{</font>
        x_SetPos<font color="black">(</font> m_iPos, m_iPosChild, <font color="maroon">0</font> <font color="black">)</font>;
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>OutOfElem<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Go to parent element</font>
    <font color="blue">if</font> <font color="black">(</font> m_iPosParent <font color="black">)</font>
    <font color="black">{</font>
        x_SetPos<font color="black">(</font> m_aPos<font color="black">[</font>m_iPosParent<font color="black">]</font>.iElemParent, m_iPosParent, m_iPos <font color="black">)</font>;
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>GetAttribName<font color="black">(</font> <font color="blue">int</font> n <font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="green">// Return nth attribute name of main position</font>
    TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> m_iPos <font color="black">&</font><font color="black">&</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
        token.nNext <font color="black">=</font> m_aPos<font color="black">[</font>m_iPos<font color="black">]</font>.nStart <font color="black">+</font> <font color="maroon">1</font>;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> m_nNodeLength <font color="black">&</font><font color="black">&</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_PROCESSING_INSTRUCTION <font color="black">)</font>
        token.nNext <font color="black">=</font> m_nNodeOffset <font color="black">+</font> <font color="maroon">2</font>;
    <font color="blue">else</font>
        <font color="blue">return</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> x_FindAttrib<font color="black">(</font>token,NULL,n<font color="black">)</font> <font color="black">)</font>
        <font color="blue">return</font> x_GetToken<font color="black">(</font> token <font color="black">)</font>;
    <font color="blue">return</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>SavePos<font color="black">(</font> MCD_CSTR szPosName <font color="green">/*=""*/</font>, <font color="blue">int</font> nMap <font color="green">/*=0*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Save current element position in saved position map</font>
    <font color="blue">if</font> <font color="black">(</font> szPosName <font color="black">)</font>
    <font color="black">{</font>
        SavedPosMap<font color="black">*</font> pMap;
        x_GetMap<font color="black">(</font> pMap, nMap <font color="black">)</font>;
        SavedPos savedpos;
        <font color="blue">if</font> <font color="black">(</font> szPosName <font color="black">)</font>
            savedpos.strName <font color="black">=</font> szPosName;
        <font color="blue">if</font> <font color="black">(</font> m_iPosChild <font color="black">)</font>
        <font color="black">{</font>
            savedpos.iPos <font color="black">=</font> m_iPosChild;
            savedpos.nSavedPosFlags <font color="black">|</font><font color="black">=</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_CHILD;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> m_iPos <font color="black">)</font>
        <font color="black">{</font>
            savedpos.iPos <font color="black">=</font> m_iPos;
            savedpos.nSavedPosFlags <font color="black">|</font><font color="black">=</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_MAIN;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            savedpos.iPos <font color="black">=</font> m_iPosParent;
        <font color="black">}</font>
        savedpos.nSavedPosFlags <font color="black">|</font><font color="black">=</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_USED;

        <font color="blue">int</font> nSlot <font color="black">=</font> x_Hash<font color="black">(</font> szPosName, pMap<font color="black">-</font><font color="black">&#62;</font>nMapSize<font color="black">)</font>;
        SavedPos<font color="black">*</font> pSavedPos <font color="black">=</font> pMap<font color="black">-</font><font color="black">&#62;</font>pTable<font color="black">[</font>nSlot<font color="black">]</font>;
        <font color="blue">int</font> nOffset <font color="black">=</font> <font color="maroon">0</font>;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> pSavedPos <font color="black">)</font>
        <font color="black">{</font>
            pSavedPos <font color="black">=</font> <font color="blue">new</font> SavedPos<font color="black">[</font><font color="maroon">2</font><font color="black">]</font>;
            pSavedPos<font color="black">[</font><font color="maroon">1</font><font color="black">]</font>.nSavedPosFlags <font color="black">=</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST;
            pMap<font color="black">-</font><font color="black">&#62;</font>pTable<font color="black">[</font>nSlot<font color="black">]</font> <font color="black">=</font> pSavedPos;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            <font color="blue">while</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_USED <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.strName <font color="black">=</font><font color="black">=</font> <font color="black">(</font>MCD_PCSZ<font color="black">)</font>szPosName <font color="black">)</font>
                    <font color="blue">break</font>;
                <font color="blue">if</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">int</font> nNewSize <font color="black">=</font> <font color="black">(</font>nOffset <font color="black">+</font> <font color="maroon">6</font><font color="black">)</font> <font color="black">*</font> <font color="maroon">2</font>;
                    SavedPos<font color="black">*</font> pNewSavedPos <font color="black">=</font> <font color="blue">new</font> SavedPos<font color="black">[</font>nNewSize<font color="black">]</font>;
                    <font color="blue">for</font> <font color="black">(</font> <font color="blue">int</font> nCopy<font color="black">=</font><font color="maroon">0</font>; nCopy<font color="black">&#60;</font><font color="black">=</font>nOffset; <font color="black">+</font><font color="black">+</font>nCopy <font color="black">)</font>
                        pNewSavedPos<font color="black">[</font>nCopy<font color="black">]</font> <font color="black">=</font> pSavedPos<font color="black">[</font>nCopy<font color="black">]</font>;
                    pNewSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags ^<font color="black">=</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST;
                    pNewSavedPos<font color="black">[</font>nNewSize<font color="maroon">-1</font><font color="black">]</font>.nSavedPosFlags <font color="black">=</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST;
                    <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pSavedPos;
                    pSavedPos <font color="black">=</font> pNewSavedPos;
                    pMap<font color="black">-</font><font color="black">&#62;</font>pTable<font color="black">[</font>nSlot<font color="black">]</font> <font color="black">=</font> pSavedPos;
                    <font color="black">+</font><font color="black">+</font>nOffset;
                    <font color="blue">break</font>;
                <font color="black">}</font>
                <font color="black">+</font><font color="black">+</font>nOffset;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST <font color="black">)</font>
            savedpos.nSavedPosFlags <font color="black">|</font><font color="black">=</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST;
        pSavedPos<font color="black">[</font>nOffset<font color="black">]</font> <font color="black">=</font> savedpos;

        <font color="green">/*
        // To review hash table balance, uncomment and watch strBalance
        MCD_STR strBalance, strSlot;
        for ( nSlot=0; nSlot &#60; pMap-&#62;nMapSize; ++nSlot )
        {
            pSavedPos = pMap-&#62;pTable[nSlot];
            int nCount = 0;
            while ( pSavedPos && pSavedPos-&#62;nSavedPosFlags & SavedPos::SPM_USED )
            {
                ++nCount;
                if ( pSavedPos-&#62;nSavedPosFlags & SavedPos::SPM_LAST )
                    break;
                ++pSavedPos;
            }
            strSlot.Format( MCD_T("%d "), nCount );
            strBalance += strSlot;
        }
        */</font>
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>RestorePos<font color="black">(</font> MCD_CSTR szPosName <font color="green">/*=""*/</font>, <font color="blue">int</font> nMap <font color="green">/*=0*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Restore element position if found in saved position map</font>
    <font color="blue">if</font> <font color="black">(</font> szPosName <font color="black">)</font>
    <font color="black">{</font>
        SavedPosMap<font color="black">*</font> pMap;
        x_GetMap<font color="black">(</font> pMap, nMap <font color="black">)</font>;
        <font color="blue">int</font> nSlot <font color="black">=</font> x_Hash<font color="black">(</font> szPosName, pMap<font color="black">-</font><font color="black">&#62;</font>nMapSize <font color="black">)</font>;
        SavedPos<font color="black">*</font> pSavedPos <font color="black">=</font> pMap<font color="black">-</font><font color="black">&#62;</font>pTable<font color="black">[</font>nSlot<font color="black">]</font>;
        <font color="blue">if</font> <font color="black">(</font> pSavedPos <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">int</font> nOffset <font color="black">=</font> <font color="maroon">0</font>;
            <font color="blue">while</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_USED <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.strName <font color="black">=</font><font color="black">=</font> <font color="black">(</font>MCD_PCSZ<font color="black">)</font>szPosName <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">int</font> i <font color="black">=</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.iPos;
                    <font color="blue">if</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_CHILD <font color="black">)</font>
                        x_SetPos<font color="black">(</font> m_aPos<font color="black">[</font>m_aPos<font color="black">[</font>i<font color="black">]</font>.iElemParent<font color="black">]</font>.iElemParent, m_aPos<font color="black">[</font>i<font color="black">]</font>.iElemParent, i <font color="black">)</font>;
                    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_MAIN <font color="black">)</font>
                        x_SetPos<font color="black">(</font> m_aPos<font color="black">[</font>i<font color="black">]</font>.iElemParent, i, <font color="maroon">0</font> <font color="black">)</font>;
                    <font color="blue">else</font>
                        x_SetPos<font color="black">(</font> i, <font color="maroon">0</font>, <font color="maroon">0</font> <font color="black">)</font>;
                    <font color="blue">return</font> <font color="blue">true</font>;
                <font color="black">}</font>
                <font color="blue">if</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST <font color="black">)</font>
                    <font color="blue">break</font>;
                <font color="black">+</font><font color="black">+</font>nOffset;
            <font color="black">}</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>SetMapSize<font color="black">(</font> <font color="blue">int</font> nSize, <font color="blue">int</font> nMap <font color="green">/*=0*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Set saved position map hash table size before using it</font>
    <font color="green">// Returns false if map already exists</font>
    <font color="green">// Some prime numbers: 53, 101, 211, 503, 1009, 2003, 10007, 20011, 50021, 100003, 200003, 500009</font>
    SavedPosMap<font color="black">*</font> pNewMap;
    <font color="blue">return</font> x_GetMap<font color="black">(</font> pNewMap, nMap, nSize <font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>RemoveElem<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Remove current main position element</font>
    <font color="blue">if</font> <font color="black">(</font> m_iPos <font color="black">&</font><font color="black">&</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">int</font> iPos <font color="black">=</font> x_RemoveElem<font color="black">(</font> m_iPos <font color="black">)</font>;
        x_SetPos<font color="black">(</font> m_iPosParent, iPos, <font color="maroon">0</font> <font color="black">)</font>;
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>RemoveChildElem<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Remove current child position element</font>
    <font color="blue">if</font> <font color="black">(</font> m_iPosChild <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">int</font> iPosChild <font color="black">=</font> x_RemoveElem<font color="black">(</font> m_iPosChild <font color="black">)</font>;
        x_SetPos<font color="black">(</font> m_iPosParent, m_iPos, iPosChild <font color="black">)</font>;
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>


<font color="green">//////////////////////////////////////////////////////////////////////</font>
<font color="green">// Private Methods</font>
<font color="green">//////////////////////////////////////////////////////////////////////</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>x_GetLastError<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="green">// strerror is has difficulties cross-platform</font>
    <font color="green">// VC++ leaves MCD_STRERROR undefined and uses FormatMessage</font>
    <font color="green">// Non-VC++ use strerror (even for MARKUP_WCHAR and convert)</font>
    <font color="green">// additional notes:</font>
    <font color="green">// _WIN32_WCE (Windows CE) has no strerror (Embedded VC++ uses FormatMessage) </font>
    <font color="green">// _MSC_VER &#62;= 1310 (VC++ 2003/7.1) has _wcserror (but not used)</font>
    <font color="green">//</font>
    <font color="blue">const</font> <font color="blue">int</font> nErrorBufferSize <font color="black">=</font> <font color="maroon">100</font>;
    MCD_CHAR szError<font color="black">[</font>nErrorBufferSize<font color="black">+</font><font color="maroon">1</font><font color="black">]</font>;
<font color="blue">#if</font> defined<font color="black">(</font>MCD_STRERROR<font color="black">)</font> <font color="green">// C error routine</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WCHAR<font color="black">)</font>
    <font color="blue">char</font> szMBError<font color="black">[</font>nErrorBufferSize<font color="black">+</font><font color="maroon">1</font><font color="black">]</font>;
    strncpy<font color="black">(</font> szMBError, MCD_STRERROR, nErrorBufferSize <font color="black">)</font>;
    szMBError<font color="black">[</font>nErrorBufferSize<font color="black">]</font> <font color="black">=</font> <font color="maroon">'\0'</font>;
    ConvertEncoding convert<font color="black">(</font> MCD_ENC, MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>szMBError, strlen<font color="black">(</font>szMBError<font color="black">)</font> <font color="black">)</font>;
    convert.nToCount <font color="black">=</font> nErrorBufferSize;
    <font color="blue">int</font> nWideLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>szError <font color="black">)</font>;
    szError<font color="black">[</font>nWideLen<font color="black">]</font> <font color="black">=</font> <font color="maroon">'\0'</font>;
<font color="blue">#else</font>
    MCD_PSZNCPY<font color="black">(</font> szError, MCD_STRERROR, nErrorBufferSize <font color="black">)</font>;
    szError<font color="black">[</font>nErrorBufferSize<font color="black">]</font> <font color="black">=</font> <font color="maroon">'\0'</font>;
<font color="blue">#endif</font>
<font color="blue">#else</font> <font color="green">// no C error routine, use Windows API</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">:</font><font color="black">:</font>FormatMessage<font color="black">(</font><font color="maroon">0x1200</font>,<font color="maroon">0</font>,<font color="black">:</font><font color="black">:</font>GetLastError<font color="black">(</font><font color="black">)</font>,<font color="maroon">0</font>,szError,nErrorBufferSize,<font color="maroon">0</font><font color="black">)</font> <font color="black">&#60;</font> <font color="maroon">1</font> <font color="black">)</font>
        szError<font color="black">[</font><font color="maroon">0</font><font color="black">]</font> <font color="black">=</font> <font color="maroon">'\0'</font>;
<font color="blue">#endif</font> <font color="green">// no C error routine</font>
    MCD_STR strError <font color="black">=</font> szError;
    <font color="blue">for</font> <font color="black">(</font> <font color="blue">int</font> nChar<font color="black">=</font><font color="maroon">0</font>; nChar<font color="black">&#60;</font>MCD_STRLENGTH<font color="black">(</font>strError<font color="black">)</font>; <font color="black">+</font><font color="black">+</font>nChar <font color="black">)</font>
        <font color="blue">if</font> <font color="black">(</font> strError<font color="black">[</font>nChar<font color="black">]</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">'\r'</font> <font color="black">|</font><font color="black">|</font> strError<font color="black">[</font>nChar<font color="black">]</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">'\n'</font> <font color="black">)</font>
        <font color="black">{</font>
            strError <font color="black">=</font> MCD_STRMID<font color="black">(</font> strError, <font color="maroon">0</font>, nChar <font color="black">)</font>; <font color="green">// no trailing newline</font>
            <font color="blue">break</font>;
        <font color="black">}</font>
    <font color="blue">return</font> strError;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_AllocPosArray<font color="black">(</font> <font color="blue">int</font> nNewSize <font color="green">/*=0*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Resize m_aPos when the document is created or the array is filled</font>
    <font color="green">// The PosArray class is implemented using segments to reduce contiguous memory requirements</font>
    <font color="green">// It reduces reallocations (copying of memory) since this only occurs within one segment</font>
    <font color="green">// The "Grow By" algorithm ensures there are no reallocations after 2 segments</font>
    <font color="green">//</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> nNewSize <font color="black">)</font>
        nNewSize <font color="black">=</font> m_iPosFree <font color="black">+</font> <font color="black">(</font>m_iPosFree<font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">1</font><font color="black">)</font>; <font color="green">// Grow By: multiply size by 1.5</font>
    <font color="blue">if</font> <font color="black">(</font> m_aPos.GetSize<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font> nNewSize <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Grow By: new size can be at most one more complete segment</font>
        <font color="blue">int</font> nSeg <font color="black">=</font> <font color="black">(</font>m_aPos.GetSize<font color="black">(</font><font color="black">)</font>?m_aPos.GetSize<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">:</font><font color="maroon">0</font><font color="black">)</font> <font color="black">&#62;</font><font color="black">&#62;</font> m_aPos.PA_SEGBITS;
        <font color="blue">int</font> nNewSeg <font color="black">=</font> <font color="black">(</font>nNewSize<font color="maroon">-1</font><font color="black">)</font> <font color="black">&#62;</font><font color="black">&#62;</font> m_aPos.PA_SEGBITS;
        <font color="blue">if</font> <font color="black">(</font> nNewSeg <font color="black">&#62;</font> nSeg <font color="black">+</font> <font color="maroon">1</font> <font color="black">)</font>
        <font color="black">{</font>
            nNewSeg <font color="black">=</font> nSeg <font color="black">+</font> <font color="maroon">1</font>;
            nNewSize <font color="black">=</font> <font color="black">(</font>nNewSeg<font color="black">+</font><font color="maroon">1</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> m_aPos.PA_SEGBITS;
        <font color="black">}</font>

        <font color="green">// Allocate array of segments</font>
        <font color="blue">if</font> <font color="black">(</font> m_aPos.nSegs <font color="black">&#60;</font><font color="black">=</font> nNewSeg <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">int</font> nNewSegments <font color="black">=</font> <font color="maroon">4</font> <font color="black">+</font> nNewSeg <font color="black">*</font> <font color="maroon">2</font>;
            <font color="blue">char</font><font color="black">*</font> pNewSegments <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>nNewSegments<font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font><font color="black">]</font>;
            <font color="blue">if</font> <font color="black">(</font> m_aPos.SegsUsed<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
                memcpy<font color="black">(</font> pNewSegments, m_aPos.pSegs, m_aPos.SegsUsed<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font> <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> m_aPos.pSegs <font color="black">)</font>
                <font color="blue">delete</font><font color="black">[</font><font color="black">]</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>m_aPos.pSegs;
            m_aPos.pSegs <font color="black">=</font> <font color="black">(</font>ElemPos<font color="black">*</font><font color="black">*</font><font color="black">)</font>pNewSegments;
            m_aPos.nSegs <font color="black">=</font> nNewSegments;
        <font color="black">}</font>

        <font color="green">// Calculate segment sizes</font>
        <font color="blue">int</font> nSegSize <font color="black">=</font> m_aPos.GetSize<font color="black">(</font><font color="black">)</font> <font color="black">-</font><font color="black">(</font>nSeg <font color="black">&#60;</font><font color="black">&#60;</font> m_aPos.PA_SEGBITS<font color="black">)</font>;
        <font color="blue">int</font> nNewSegSize <font color="black">=</font> nNewSize <font color="black">-</font><font color="black">(</font>nNewSeg <font color="black">&#60;</font><font color="black">&#60;</font> m_aPos.PA_SEGBITS<font color="black">)</font>;

        <font color="green">// Complete first segment</font>
        <font color="blue">int</font> nFullSegSize <font color="black">=</font> <font color="maroon">1</font> <font color="black">&#60;</font><font color="black">&#60;</font> m_aPos.PA_SEGBITS;
        <font color="blue">if</font> <font color="black">(</font> nSeg <font color="black">&#60;</font> nNewSeg <font color="black">&</font><font color="black">&</font> nSegSize <font color="black">&#60;</font> nFullSegSize <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">char</font><font color="black">*</font> pNewFirstSeg <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font> nFullSegSize <font color="black">*</font> <font color="blue">sizeof</font><font color="black">(</font>ElemPos<font color="black">)</font> <font color="black">]</font>;
            <font color="blue">if</font> <font color="black">(</font> nSegSize <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// Reallocate</font>
                memcpy<font color="black">(</font> pNewFirstSeg, m_aPos.pSegs<font color="black">[</font>nSeg<font color="black">]</font>, nSegSize <font color="black">*</font> <font color="blue">sizeof</font><font color="black">(</font>ElemPos<font color="black">)</font> <font color="black">)</font>;
                <font color="blue">delete</font><font color="black">[</font><font color="black">]</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>m_aPos.pSegs<font color="black">[</font>nSeg<font color="black">]</font>;
            <font color="black">}</font>
            m_aPos.pSegs<font color="black">[</font>nSeg<font color="black">]</font> <font color="black">=</font> <font color="black">(</font>ElemPos<font color="black">*</font><font color="black">)</font>pNewFirstSeg;
        <font color="black">}</font>

        <font color="green">// New segment</font>
        <font color="blue">char</font><font color="black">*</font> pNewSeg <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font> nNewSegSize <font color="black">*</font> <font color="blue">sizeof</font><font color="black">(</font>ElemPos<font color="black">)</font> <font color="black">]</font>;
        <font color="blue">if</font> <font color="black">(</font> nNewSeg <font color="black">=</font><font color="black">=</font> nSeg <font color="black">&</font><font color="black">&</font> nSegSize <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Reallocate</font>
            memcpy<font color="black">(</font> pNewSeg, m_aPos.pSegs<font color="black">[</font>nSeg<font color="black">]</font>, nSegSize <font color="black">*</font> <font color="blue">sizeof</font><font color="black">(</font>ElemPos<font color="black">)</font> <font color="black">)</font>;
            <font color="blue">delete</font><font color="black">[</font><font color="black">]</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>m_aPos.pSegs<font color="black">[</font>nSeg<font color="black">]</font>;
        <font color="black">}</font>
        m_aPos.pSegs<font color="black">[</font>nNewSeg<font color="black">]</font> <font color="black">=</font> <font color="black">(</font>ElemPos<font color="black">*</font><font color="black">)</font>pNewSeg;
        m_aPos.nSize <font color="black">=</font> nNewSize;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_ParseDoc<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Preserve pre-parse result</font>
    MCD_STR strResult <font color="black">=</font> m_strError;

    <font color="green">// Reset indexes</font>
    ResetPos<font color="black">(</font><font color="black">)</font>;
    m_SavedPosMapArray.RemoveAll<font color="black">(</font><font color="black">)</font>;

    <font color="green">// Starting size of position array: 1 element per 64 bytes of document</font>
    <font color="green">// Tight fit when parsing small doc, only 0 to 2 reallocs when parsing large doc</font>
    <font color="green">// Start at 8 when creating new document</font>
    <font color="blue">int</font> nDocLen <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>m_strDoc<font color="black">)</font>;
    m_iPosFree <font color="black">=</font> <font color="maroon">1</font>;
    x_AllocPosArray<font color="black">(</font> nDocLen <font color="black">/</font> <font color="maroon">64</font> <font color="black">+</font> <font color="maroon">8</font> <font color="black">)</font>;
    m_iPosDeleted <font color="black">=</font> <font color="maroon">0</font>;

    <font color="green">// Parse document</font>
    m_aPos<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>.ClearVirtualParent<font color="black">(</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> nDocLen <font color="black">)</font>
    <font color="black">{</font>
        TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
        <font color="blue">int</font> iPos <font color="black">=</font> x_ParseElem<font color="black">(</font> <font color="maroon">0</font>, token <font color="black">)</font>;
        m_aPos<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>.nLength <font color="black">=</font> nDocLen;
        <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">&#62;</font> <font color="maroon">0</font> <font color="black">)</font>
        <font color="black">{</font>
            m_aPos<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>.iElemChild <font color="black">=</font> iPos;
            <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext <font color="black">)</font>
                m_strError <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"Root element has sibling"</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
            m_strError <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"No root element"</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
        m_strError <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"Empty document"</font><font color="black">)</font>;

    ResetPos<font color="black">(</font><font color="black">)</font>;

    <font color="green">// Combine preserved result with parse error</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> MCD_STRISEMPTY<font color="black">(</font>strResult<font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>m_strError<font color="black">)</font> <font color="black">)</font>
            m_strError <font color="black">=</font> strResult;
        <font color="blue">else</font>
            m_strError <font color="black">=</font> strResult <font color="black">+</font> MCD_T<font color="black">(</font><font color="maroon">" "</font><font color="black">)</font> <font color="black">+</font> m_strError;
    <font color="black">}</font>

    <font color="blue">return</font> IsWellFormed<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>;

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_ParseElem<font color="black">(</font> <font color="blue">int</font> iPosParent, TokenPos<font color="black">&</font> token <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// This is either called by x_ParseDoc or x_AddSubDoc or x_SetElemContent</font>
    <font color="green">// Returns index of the first element encountered or zero if no elements</font>
    <font color="green">//</font>
    <font color="blue">int</font> iElemRoot <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> iPos <font color="black">=</font> iPosParent;
    <font color="blue">int</font> iVirtualParent <font color="black">=</font> iPosParent;
    <font color="blue">int</font> nRootDepth <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.Level<font color="black">(</font><font color="black">)</font>;
    token.nNext <font color="black">=</font> <font color="maroon">0</font>;
    MCD_STRCLEAR<font color="black">(</font>m_strError<font color="black">)</font>;

    <font color="green">// Loop through the nodes of the document</font>
    NodeStack aNodes;
    aNodes.Add<font color="black">(</font><font color="black">)</font>;
    <font color="blue">int</font> nDepth <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> nMatchDepth;
    <font color="blue">int</font> iPosChild;
    <font color="blue">int</font> iPosMatch;
    <font color="blue">int</font> nTypeFound <font color="black">=</font> <font color="maroon">0</font>;
    ElemPos<font color="black">*</font> pElem;
    <font color="blue">int</font> iElemFirst, iElemLast;
    <font color="blue">while</font> <font color="black">(</font> <font color="maroon">1</font> <font color="black">)</font>
    <font color="black">{</font>
        nTypeFound <font color="black">=</font> x_ParseNode<font color="black">(</font> token, aNodes.Top<font color="black">(</font><font color="black">)</font> <font color="black">)</font>;
        nMatchDepth <font color="black">=</font> <font color="maroon">0</font>;
        <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font> <font color="green">// start tag</font>
        <font color="black">{</font>
            iPos <font color="black">=</font> x_GetFreePos<font color="black">(</font><font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> iElemRoot <font color="black">)</font>
                iElemRoot <font color="black">=</font> iPos;
            pElem <font color="black">=</font> <font color="black">&</font>m_aPos<font color="black">[</font>iPos<font color="black">]</font>;
            pElem<font color="black">-</font><font color="black">&#62;</font>iElemParent <font color="black">=</font> iPosParent;
            pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext <font color="black">=</font> <font color="maroon">0</font>;
            <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild <font color="black">)</font>
            <font color="black">{</font>
                iElemFirst <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild;
                iElemLast <font color="black">=</font> m_aPos<font color="black">[</font>iElemFirst<font color="black">]</font>.iElemPrev;
                m_aPos<font color="black">[</font>iElemLast<font color="black">]</font>.iElemNext <font color="black">=</font> iPos;
                pElem<font color="black">-</font><font color="black">&#62;</font>iElemPrev <font color="black">=</font> iElemLast;
                m_aPos<font color="black">[</font>iElemFirst<font color="black">]</font>.iElemPrev <font color="black">=</font> iPos;
                pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">=</font> <font color="maroon">0</font>;
            <font color="black">}</font>
            <font color="blue">else</font>
            <font color="black">{</font>
                m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild <font color="black">=</font> iPos;
                pElem<font color="black">-</font><font color="black">&#62;</font>iElemPrev <font color="black">=</font> iPos;
                pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">=</font> MNF_FIRST;
            <font color="black">}</font>
            pElem<font color="black">-</font><font color="black">&#62;</font>SetLevel<font color="black">(</font> nRootDepth <font color="black">+</font> nDepth <font color="black">)</font>;
            pElem<font color="black">-</font><font color="black">&#62;</font>iElemChild <font color="black">=</font> <font color="maroon">0</font>;
            pElem<font color="black">-</font><font color="black">&#62;</font>nStart <font color="black">=</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.nStart;
            pElem<font color="black">-</font><font color="black">&#62;</font>SetStartTagLen<font color="black">(</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.nLength <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.nNodeFlags <font color="black">&</font> MNF_EMPTY <font color="black">)</font>
            <font color="black">{</font>
                iPos <font color="black">=</font> iPosParent;
                pElem<font color="black">-</font><font color="black">&#62;</font>SetEndTagLen<font color="black">(</font> <font color="maroon">0</font> <font color="black">)</font>;
                pElem<font color="black">-</font><font color="black">&#62;</font>nLength <font color="black">=</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.nLength;
            <font color="black">}</font>
            <font color="blue">else</font>
            <font color="black">{</font>
                iPosParent <font color="black">=</font> iPos;
                <font color="black">+</font><font color="black">+</font>nDepth;
                aNodes.Add<font color="black">(</font><font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font> <font color="green">// end tag</font>
        <font color="black">{</font>
            nMatchDepth <font color="black">=</font> nDepth;
            iPosMatch <font color="black">=</font> iPos;
            <font color="blue">while</font> <font color="black">(</font> nMatchDepth <font color="black">&</font><font color="black">&</font> <font color="black">!</font> token.Match<font color="black">(</font>aNodes.At<font color="black">(</font>nMatchDepth<font color="maroon">-1</font><font color="black">)</font>.strMeta<font color="black">)</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">/*
                // Auto-switch case sensitivity
                if ( ! (token.nTokenFlags & MDF_IGNORECASE ) )
                {
                    token.nTokenFlags |= MDF_IGNORECASE;
                    if ( token.Match(aNodes.At(nMatchDepth-1).strMeta) )
                        break;
                    token.nTokenFlags |= MDF_IGNORECASE;
                }
                */</font>
                <font color="black">-</font><font color="black">-</font>nMatchDepth;
                iPosMatch <font color="black">=</font> m_aPos<font color="black">[</font>iPosMatch<font color="black">]</font>.iElemParent;
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font> nMatchDepth <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// Not matched at all, it is a lone end tag, a non-element node</font>
                m_aPos<font color="black">[</font>iVirtualParent<font color="black">]</font>.nFlags <font color="black">|</font><font color="black">=</font> MNF_ILLFORMED;
                m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nFlags <font color="black">|</font><font color="black">=</font> MNF_ILLDATA;
                <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>m_strError<font color="black">)</font> <font color="black">)</font>
                <font color="black">{</font>
                    m_strError <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"No start tag for end tag '"</font><font color="black">)</font>;
                    m_strError <font color="black">+</font><font color="black">=</font> x_GetToken<font color="black">(</font>token<font color="black">)</font>;
                    m_strError <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"' at offset "</font><font color="black">)</font>;
                    m_strError <font color="black">+</font><font color="black">=</font> x_IntToStr<font color="black">(</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.nStart <font color="black">)</font>;
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">else</font>
            <font color="black">{</font>
                pElem <font color="black">=</font> <font color="black">&</font>m_aPos<font color="black">[</font>iPosMatch<font color="black">]</font>;
                pElem<font color="black">-</font><font color="black">&#62;</font>nLength <font color="black">=</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.nStart <font color="black">-</font>pElem<font color="black">-</font><font color="black">&#62;</font>nStart <font color="black">+</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.nLength;
                pElem<font color="black">-</font><font color="black">&#62;</font>SetEndTagLen<font color="black">(</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.nLength <font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
        <font color="black">{</font>
            m_aPos<font color="black">[</font>iVirtualParent<font color="black">]</font>.nFlags <font color="black">|</font><font color="black">=</font> MNF_ILLFORMED;
            m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nFlags <font color="black">|</font><font color="black">=</font> MNF_ILLDATA;
            <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>m_strError<font color="black">)</font> <font color="black">)</font>
                m_strError <font color="black">=</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.strMeta;
        <font color="black">}</font>

        <font color="green">// Matched end tag, or end of document</font>
        <font color="blue">if</font> <font color="black">(</font> nMatchDepth <font color="black">|</font><font color="black">|</font> nTypeFound <font color="black">=</font><font color="black">=</font> <font color="maroon">-2</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> nDepth <font color="black">&#62;</font> nMatchDepth <font color="black">)</font>
                m_aPos<font color="black">[</font>iVirtualParent<font color="black">]</font>.nFlags <font color="black">|</font><font color="black">=</font> MNF_ILLFORMED;

            <font color="green">// Process any non-ended elements</font>
            <font color="blue">while</font> <font color="black">(</font> nDepth <font color="black">&#62;</font> nMatchDepth <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// Element with no end tag</font>
                pElem <font color="black">=</font> <font color="black">&</font>m_aPos<font color="black">[</font>iPos<font color="black">]</font>;
                iPosChild <font color="black">=</font> pElem<font color="black">-</font><font color="black">&#62;</font>iElemChild;
                iPosParent <font color="black">=</font> pElem<font color="black">-</font><font color="black">&#62;</font>iElemParent;
                pElem<font color="black">-</font><font color="black">&#62;</font>SetEndTagLen<font color="black">(</font> <font color="maroon">0</font> <font color="black">)</font>;
                pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">|</font><font color="black">=</font> MNF_NONENDED;
                pElem<font color="black">-</font><font color="black">&#62;</font>iElemChild <font color="black">=</font> <font color="maroon">0</font>;
                pElem<font color="black">-</font><font color="black">&#62;</font>nLength <font color="black">=</font> pElem<font color="black">-</font><font color="black">&#62;</font>StartTagLen<font color="black">(</font><font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">&</font> MNF_ILLDATA <font color="black">)</font>
                <font color="black">{</font>
                    pElem<font color="black">-</font><font color="black">&#62;</font>nFlags ^<font color="black">=</font> MNF_ILLDATA;
                    m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.nFlags <font color="black">|</font><font color="black">=</font> MNF_ILLDATA;
                <font color="black">}</font>
                <font color="blue">while</font> <font color="black">(</font> iPosChild <font color="black">)</font>
                <font color="black">{</font>
                    m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.iElemParent <font color="black">=</font> iPosParent;
                    m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.iElemPrev <font color="black">=</font> iPos;
                    m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext <font color="black">=</font> iPosChild;
                    iPos <font color="black">=</font> iPosChild;
                    iPosChild <font color="black">=</font> m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.iElemNext;
                <font color="black">}</font>
                iPos <font color="black">=</font> iPosParent;
                aNodes.Remove<font color="black">(</font><font color="black">)</font>;
                <font color="black">-</font><font color="black">-</font>nDepth;

                <font color="green">// Error string</font>
                <font color="green">// if end tag did not match, top node is end tag that did not match pElem</font>
                <font color="green">// if end of document, any nodes below top have no end tag</font>
                <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>m_strError<font color="black">)</font> <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
                    <font color="black">{</font>
                        m_strError <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"End tag '"</font><font color="black">)</font> <font color="black">+</font> x_GetToken<font color="black">(</font>token<font color="black">)</font>;
                        m_strError <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"' at offset "</font><font color="black">)</font> <font color="black">+</font> x_IntToStr<font color="black">(</font> token.nL<font color="maroon">-1</font> <font color="black">)</font>;
                        m_strError <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">" does not match start tag '"</font><font color="black">)</font> <font color="black">+</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.strMeta;
                        m_strError <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"' at offset "</font><font color="black">)</font> <font color="black">+</font> x_IntToStr<font color="black">(</font> pElem<font color="black">-</font><font color="black">&#62;</font>nStart <font color="black">)</font>;
                    <font color="black">}</font>
                    <font color="blue">else</font>
                    <font color="black">{</font>
                        m_strError <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"Element '"</font><font color="black">)</font> <font color="black">+</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.strMeta;
                        m_strError <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"' at offset "</font><font color="black">)</font> <font color="black">+</font> x_IntToStr<font color="black">(</font> aNodes.Top<font color="black">(</font><font color="black">)</font>.nStart <font color="black">)</font>;
                        m_strError <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">" not ended"</font><font color="black">)</font>;
                    <font color="black">}</font>
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font> nTypeFound <font color="black">=</font><font color="black">=</font> <font color="maroon">-2</font> <font color="black">)</font>
                <font color="blue">break</font>;
            iPosParent <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemParent;
            iPos <font color="black">=</font> iPosParent;
            aNodes.Remove<font color="black">(</font><font color="black">)</font>;
            <font color="black">-</font><font color="black">-</font>nDepth;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> iElemRoot;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_FindAny<font color="black">(</font> MCD_PCSZ pDoc, <font color="blue">int</font><font color="black">&</font> nChar <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Starting at nChar, find a non-whitespace char</font>
    <font color="green">// return false if no non-whitespace before end of document, nChar points to end</font>
    <font color="green">// otherwise return true and nChar points to non-whitespace char</font>
    <font color="blue">while</font> <font color="black">(</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">&</font><font color="black">&</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">" \t\n\r"</font><font color="black">)</font>,pDoc<font color="black">[</font>nChar<font color="black">]</font><font color="black">)</font> <font color="black">)</font>
        <font color="black">+</font><font color="black">+</font>nChar;
    <font color="blue">return</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">!</font><font color="black">=</font> <font color="maroon">'\0'</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_FindName<font color="black">(</font> CMarkup<font color="black">:</font><font color="black">:</font>TokenPos<font color="black">&</font> token <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Starting at token.nNext, bypass whitespace and find the next name</font>
    <font color="green">// returns true on success, members of token point to token</font>
    <font color="green">// returns false on end of document, members point to end of document</font>
    MCD_PCSZ pDoc <font color="black">=</font> token.pDoc;
    <font color="blue">int</font> nChar <font color="black">=</font> token.nNext;

    <font color="green">// By-pass leading whitespace</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> x_FindAny<font color="black">(</font>pDoc,nChar<font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// No token was found before end of document</font>
        token.nL <font color="black">=</font> nChar;
        token.nR <font color="black">=</font> nChar <font color="maroon">-1</font>;
        token.nNext <font color="black">=</font> nChar;
        <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>

    <font color="green">// Go until special char or whitespace</font>
    token.nL <font color="black">=</font> nChar;
    <font color="blue">while</font> <font color="black">(</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">" \t\n\r&#60;&#62;=\\/?!\"';"</font><font color="black">)</font>,pDoc<font color="black">[</font>nChar<font color="black">]</font><font color="black">)</font> <font color="black">)</font>
        nChar <font color="black">+</font><font color="black">=</font> MCD_CLEN<font color="black">(</font><font color="black">&</font>pDoc<font color="black">[</font>nChar<font color="black">]</font><font color="black">)</font>;

    <font color="green">// Adjust end position if it is one special char</font>
    <font color="blue">if</font> <font color="black">(</font> nChar <font color="black">=</font><font color="black">=</font> token.nL <font color="black">)</font>
        <font color="black">+</font><font color="black">+</font>nChar; <font color="green">// it is a special char</font>
    token.nR <font color="black">=</font> nChar <font color="maroon">-1</font>;

    <font color="green">// nNext points to one past last char of token</font>
    token.nNext <font color="black">=</font> nChar;
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>x_GetToken<font color="black">(</font> <font color="blue">const</font> CMarkup<font color="black">:</font><font color="black">:</font>TokenPos<font color="black">&</font> token <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// The token contains indexes into the document identifying a small substring</font>
    <font color="green">// Build the substring from those indexes and return it</font>
    <font color="blue">if</font> <font color="black">(</font> token.nL <font color="black">&#62;</font> token.nR <font color="black">)</font>
        <font color="blue">return</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;
    MCD_STR strToken<font color="black">(</font> <font color="black">&</font>token.pDoc<font color="black">[</font>token.nL<font color="black">]</font>, token.Length<font color="black">(</font><font color="black">)</font> <font color="black">)</font>;
    <font color="blue">return</font> strToken;
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_FindElem<font color="black">(</font> <font color="blue">int</font> iPosParent, <font color="blue">int</font> iPos, MCD_PCSZ pPath <font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="green">// If pPath is NULL or empty, go to next sibling element</font>
    <font color="green">// Otherwise go to next sibling element with matching path</font>
    <font color="green">//</font>
    <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">)</font>
        iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext;
    <font color="blue">else</font>
        iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild;

    <font color="green">// Finished here if pPath not specified</font>
    <font color="blue">if</font> <font color="black">(</font> pPath <font color="black">=</font><font color="black">=</font> NULL <font color="black">|</font><font color="black">|</font> <font color="black">!</font>pPath<font color="black">[</font><font color="maroon">0</font><font color="black">]</font> <font color="black">)</font>
        <font color="blue">return</font> iPos;

    <font color="green">// Search</font>
    TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
    <font color="blue">while</font> <font color="black">(</font> iPos <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Compare tag name</font>
        token.nNext <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart <font color="black">+</font> <font color="maroon">1</font>;
        x_FindName<font color="black">(</font> token <font color="black">)</font>; <font color="green">// Locate tag name</font>
        <font color="blue">if</font> <font color="black">(</font> token.Match<font color="black">(</font>pPath<font color="black">)</font> <font color="black">)</font>
            <font color="blue">return</font> iPos;
        iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="maroon">0</font>;

<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_ParseNode<font color="black">(</font> CMarkup<font color="black">:</font><font color="black">:</font>TokenPos<font color="black">&</font> token, CMarkup<font color="black">:</font><font color="black">:</font>NodePos<font color="black">&</font> node <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Call this with token.nNext set to the start of the node or tag</font>
    <font color="green">// Upon return token.nNext points to the char after the node or tag</font>
    <font color="green">// </font>
    <font color="green">// &#60;!--...--&#62; comment</font>
    <font color="green">// &#60;!DOCTYPE ...&#62; dtd</font>
    <font color="green">// &#60;?target ...?&#62; processing instruction</font>
    <font color="green">// &#60;![CDATA[...]]&#62; cdata section</font>
    <font color="green">// &#60;NAME ...&#62; element start tag</font>
    <font color="green">// &#60;/NAME ...&#62; element end tag</font>
    <font color="green">//</font>
    <font color="green">// returns the nodetype or</font>
    <font color="green">// 0 for end tag</font>
    <font color="green">// -1 for bad node</font>
    <font color="green">// -2 for end of document</font>
    <font color="green">//</font>
    <font color="blue">enum</font> ParseBits
    <font color="black">{</font>
        PD_OPENTAG <font color="black">=</font> <font color="maroon">1</font>,
        PD_BANG <font color="black">=</font> <font color="maroon">2</font>,
        PD_DASH <font color="black">=</font> <font color="maroon">4</font>,
        PD_BRACKET <font color="black">=</font> <font color="maroon">8</font>,
        PD_TEXTORWS <font color="black">=</font> <font color="maroon">16</font>,
        PD_DOCTYPE <font color="black">=</font> <font color="maroon">32</font>,
        PD_INQUOTE_S <font color="black">=</font> <font color="maroon">64</font>,
        PD_INQUOTE_D <font color="black">=</font> <font color="maroon">128</font>,
        PD_EQUALS <font color="black">=</font> <font color="maroon">256</font>,
    <font color="black">}</font>;
    <font color="blue">int</font> nParseFlags <font color="black">=</font> <font color="maroon">0</font>;

    MCD_PCSZ pFindEnd <font color="black">=</font> NULL;
    <font color="blue">int</font> nNodeType <font color="black">=</font> <font color="maroon">-1</font>;
    <font color="blue">int</font> nEndLen <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> nName <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">unsigned</font> <font color="blue">int</font> cDminus1 <font color="black">=</font> <font color="maroon">0</font>, cDminus2 <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">#define</font> FINDNODETYPE<font color="black">(</font>e,t<font color="black">)</font> <font color="black">{</font> pFindEnd<font color="black">=</font>e; nEndLen<font color="black">=</font><font color="black">(</font><font color="blue">sizeof</font><font color="black">(</font>e<font color="black">)</font><font color="maroon">-1</font><font color="black">)</font><font color="black">/</font><font color="blue">sizeof</font><font color="black">(</font>MCD_CHAR<font color="black">)</font>; nNodeType<font color="black">=</font>t; <font color="black">}</font>
    <font color="blue">#define</font> FINDNODETYPENAME<font color="black">(</font>e,t,n<font color="black">)</font> <font color="black">{</font> FINDNODETYPE<font color="black">(</font>e,t<font color="black">)</font> nName<font color="black">=</font><font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pDoc<font color="black">-</font>token.pDoc<font color="black">)</font><font color="black">+</font>n<font color="maroon">-1</font>; <font color="black">}</font>
    <font color="blue">#define</font> FINDNODEERR<font color="black">(</font>e<font color="black">)</font> node.strMeta<font color="black">=</font>MCD_T<font color="black">(</font><font color="maroon">"Incorrect "</font><font color="black">)</font>; node.strMeta<font color="black">+</font><font color="black">=</font>e; node.strMeta<font color="black">+</font><font color="black">=</font>MCD_T<font color="black">(</font><font color="maroon">" at offset "</font><font color="black">)</font><font color="black">+</font>x_IntToStr<font color="black">(</font>nR<font color="black">)</font>
    <font color="blue">#define</font> FINDNODEBAD<font color="black">(</font>e<font color="black">)</font> <font color="black">{</font> pFindEnd<font color="black">=</font>MCD_T<font color="black">(</font><font color="maroon">"&#62;"</font><font color="black">)</font>; nEndLen<font color="black">=</font><font color="maroon">1</font>; FINDNODEERR<font color="black">(</font>e<font color="black">)</font>; nNodeType<font color="black">=</font><font color="maroon">-1</font>; <font color="black">}</font>

    node.nStart <font color="black">=</font> token.nNext;
    node.nNodeFlags <font color="black">=</font> <font color="maroon">0</font>;

    <font color="blue">int</font> nR <font color="black">=</font> token.nNext;
    MCD_PCSZ pDoc <font color="black">=</font> <font color="black">&</font>token.pDoc<font color="black">[</font>nR<font color="black">]</font>;
    <font color="blue">register</font> <font color="blue">unsigned</font> <font color="blue">int</font> cD <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font><font color="black">*</font>pDoc;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> cD <font color="black">)</font>
    <font color="black">{</font>
        node.nLength <font color="black">=</font> <font color="maroon">0</font>;
        node.nNodeType <font color="black">=</font> <font color="maroon">0</font>;
        <font color="blue">return</font> <font color="maroon">-2</font>; <font color="green">// end of document</font>
    <font color="black">}</font>

    <font color="blue">while</font> <font color="black">(</font> <font color="maroon">1</font> <font color="black">)</font>
    <font color="black">{</font>
        cD <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font><font color="black">*</font>pDoc;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> cD <font color="black">)</font>
        <font color="black">{</font>
            nR <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pDoc <font color="black">-</font>token.pDoc<font color="black">)</font> <font color="maroon">-1</font>;
            <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">!</font><font color="black">=</font> MNT_WHITESPACE <font color="black">&</font><font color="black">&</font> nNodeType <font color="black">!</font><font color="black">=</font> MNT_TEXT <font color="black">)</font>
            <font color="black">{</font>
                MCD_PCSZ pType <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"tag"</font><font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>nParseFlags <font color="black">&</font> PD_DOCTYPE<font color="black">)</font> <font color="black">|</font><font color="black">|</font> nNodeType <font color="black">=</font><font color="black">=</font> MNT_DOCUMENT_TYPE <font color="black">)</font>
                    pType <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"Doctype"</font><font color="black">)</font>;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
                    pType <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"Element tag"</font><font color="black">)</font>;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
                    pType <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"Element end tag"</font><font color="black">)</font>;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> MNT_CDATA_SECTION <font color="black">)</font>
                    pType <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"CDATA Section"</font><font color="black">)</font>;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> MNT_PROCESSING_INSTRUCTION <font color="black">)</font>
                    pType <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"Processing instruction"</font><font color="black">)</font>;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> MNT_COMMENT <font color="black">)</font>
                    pType <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"Comment"</font><font color="black">)</font>;
                nNodeType <font color="black">=</font> <font color="maroon">-1</font>;
                node.strMeta <font color="black">=</font> pType;
                node.strMeta <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">" at offset "</font><font color="black">)</font> <font color="black">+</font> x_IntToStr<font color="black">(</font>node.nStart<font color="black">)</font>;
                node.strMeta <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">" unterminated"</font><font color="black">)</font>;
            <font color="black">}</font>
            <font color="blue">break</font>;
        <font color="black">}</font>

        <font color="blue">if</font> <font color="black">(</font> nName <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">" \t\n\r/&#62;"</font><font color="black">)</font>,<font color="black">(</font>MCD_CHAR<font color="black">)</font>cD<font color="black">)</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">int</font> nNameLen <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pDoc <font color="black">-</font>token.pDoc<font color="black">)</font> <font color="black">-</font>nName;
                <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
                <font color="black">{</font>
                    token.nL <font color="black">=</font> nName;
                    token.nR <font color="black">=</font> nName <font color="black">+</font> nNameLen <font color="maroon">-1</font>;
                <font color="black">}</font>
                <font color="blue">else</font>
                <font color="black">{</font>
                    MCD_STRASSIGN<font color="black">(</font>node.strMeta,<font color="black">&</font>token.pDoc<font color="black">[</font>nName<font color="black">]</font>,nNameLen<font color="black">)</font>;
                <font color="black">}</font>
                nName <font color="black">=</font> <font color="maroon">0</font>;
                cDminus2 <font color="black">=</font> <font color="maroon">0</font>;
                cDminus1 <font color="black">=</font> <font color="maroon">0</font>;
            <font color="black">}</font>
            <font color="blue">else</font>
            <font color="black">{</font>
                pDoc <font color="black">+</font><font color="black">=</font> MCD_CLEN<font color="black">(</font> pDoc <font color="black">)</font>;
                <font color="blue">continue</font>;
            <font color="black">}</font>
        <font color="black">}</font>

        <font color="blue">if</font> <font color="black">(</font> pFindEnd <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#62;'</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> <font color="black">(</font>nParseFlags <font color="black">&</font> <font color="black">(</font>PD_INQUOTE_S<font color="black">|</font>PD_INQUOTE_D<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
            <font color="black">{</font>
                nR <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pDoc <font color="black">-</font>token.pDoc<font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> nEndLen <font color="black">=</font><font color="black">=</font> <font color="maroon">1</font> <font color="black">)</font>
                <font color="black">{</font>
                    pFindEnd <font color="black">=</font> NULL;
                    <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">&</font><font color="black">&</font> cDminus1 <font color="black">=</font><font color="black">=</font> <font color="maroon">'/'</font> <font color="black">)</font>
                    <font color="black">{</font>
                        <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font><font color="black">!</font> cDminus2<font color="black">)</font> <font color="black">|</font><font color="black">|</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">" \t\n\r\'\""</font><font color="black">)</font>,<font color="black">(</font>MCD_CHAR<font color="black">)</font>cDminus2<font color="black">)</font> <font color="black">)</font>
                            node.nNodeFlags <font color="black">|</font><font color="black">=</font> MNF_EMPTY;
                    <font color="black">}</font>
                <font color="black">}</font>
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nR <font color="black">&#62;</font> nEndLen <font color="black">)</font>
                <font color="black">{</font>
                    <font color="green">// Test for end of PI or comment</font>
                    MCD_PCSZ pEnd <font color="black">=</font> pDoc <font color="black">-</font>nEndLen <font color="black">+</font> <font color="maroon">1</font>;
                    MCD_PCSZ pInFindEnd <font color="black">=</font> pFindEnd;
                    <font color="blue">int</font> nLen <font color="black">=</font> nEndLen;
                    <font color="blue">while</font> <font color="black">(</font> <font color="black">-</font><font color="black">-</font>nLen <font color="black">&</font><font color="black">&</font> <font color="black">*</font>pEnd<font color="black">+</font><font color="black">+</font> <font color="black">=</font><font color="black">=</font> <font color="black">*</font>pInFindEnd<font color="black">+</font><font color="black">+</font> <font color="black">)</font>;
                    <font color="blue">if</font> <font color="black">(</font> nLen <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
                        pFindEnd <font color="black">=</font> NULL;
                <font color="black">}</font>
                <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> pFindEnd <font color="black">&</font><font color="black">&</font> <font color="black">!</font> <font color="black">(</font>nParseFlags <font color="black">&</font> PD_DOCTYPE<font color="black">)</font> <font color="black">)</font>
                    <font color="blue">break</font>;
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#60;'</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>nNodeType <font color="black">=</font><font color="black">=</font> MNT_TEXT <font color="black">|</font><font color="black">|</font> nNodeType <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font><font color="black">)</font> <font color="black">)</font>
            <font color="black">{</font>
                nR <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pDoc <font color="black">-</font>token.pDoc<font color="black">)</font> <font color="maroon">-1</font>;
                <font color="blue">break</font>;
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">&</font> MNT_ELEMENT <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>nParseFlags <font color="black">&</font> <font color="black">(</font>PD_INQUOTE_S<font color="black">|</font>PD_INQUOTE_D<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'\"'</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>nParseFlags<font color="black">&</font>PD_INQUOTE_D<font color="black">)</font> <font color="black">)</font>
                        nParseFlags ^<font color="black">=</font> PD_INQUOTE_D; <font color="green">// off</font>
                    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'\''</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>nParseFlags<font color="black">&</font>PD_INQUOTE_S<font color="black">)</font> <font color="black">)</font>
                        nParseFlags ^<font color="black">=</font> PD_INQUOTE_S; <font color="green">// off</font>
                <font color="black">}</font>
                <font color="blue">else</font> <font color="green">// not in quotes</font>
                <font color="black">{</font>
                    <font color="green">// Only set INQUOTE status when preceeded by equal sign</font>
                    <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'\"'</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>nParseFlags<font color="black">&</font>PD_EQUALS<font color="black">)</font> <font color="black">)</font>
                        nParseFlags ^<font color="black">=</font> PD_INQUOTE_D<font color="black">|</font>PD_EQUALS; <font color="green">// D on, equals off</font>
                    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'\''</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>nParseFlags<font color="black">&</font>PD_EQUALS<font color="black">)</font> <font color="black">)</font>
                        nParseFlags ^<font color="black">=</font> PD_INQUOTE_S<font color="black">|</font>PD_EQUALS; <font color="green">// S on, equals off</font>
                    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'='</font> <font color="black">&</font><font color="black">&</font> cDminus1 <font color="black">!</font><font color="black">=</font> <font color="maroon">'='</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> <font color="black">(</font>nParseFlags<font color="black">&</font>PD_EQUALS<font color="black">)</font> <font color="black">)</font>
                        nParseFlags ^<font color="black">=</font> PD_EQUALS; <font color="green">// on</font>
                    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>nParseFlags<font color="black">&</font>PD_EQUALS<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">" \t\n\r"</font><font color="black">)</font>,<font color="black">(</font>MCD_CHAR<font color="black">)</font>cD<font color="black">)</font> <font color="black">)</font>
                        nParseFlags ^<font color="black">=</font> PD_EQUALS; <font color="green">// off</font>
                <font color="black">}</font>
                cDminus2 <font color="black">=</font> cDminus1;
                cDminus1 <font color="black">=</font> cD;
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">&</font> MNT_DOCUMENT_TYPE <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'\"'</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> <font color="black">(</font>nParseFlags<font color="black">&</font>PD_INQUOTE_S<font color="black">)</font> <font color="black">)</font>
                    nParseFlags ^<font color="black">=</font> PD_INQUOTE_D; <font color="green">// toggle</font>
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'\''</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> <font color="black">(</font>nParseFlags<font color="black">&</font>PD_INQUOTE_D<font color="black">)</font> <font color="black">)</font>
                    nParseFlags ^<font color="black">=</font> PD_INQUOTE_S; <font color="green">// toggle</font>
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nParseFlags <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> nParseFlags <font color="black">&</font> PD_TEXTORWS <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#60;'</font> <font color="black">)</font>
                <font color="black">{</font>
                    nR <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pDoc <font color="black">-</font>token.pDoc<font color="black">)</font> <font color="maroon">-1</font>;
                    nNodeType <font color="black">=</font> MNT_WHITESPACE;
                    <font color="blue">break</font>;
                <font color="black">}</font>
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">" \t\n\r"</font><font color="black">)</font>,<font color="black">(</font>MCD_CHAR<font color="black">)</font>cD<font color="black">)</font> <font color="black">)</font>
                <font color="black">{</font>
                    nParseFlags ^<font color="black">=</font> PD_TEXTORWS;
                    FINDNODETYPE<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;"</font><font color="black">)</font>, MNT_TEXT <font color="black">)</font>
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nParseFlags <font color="black">&</font> PD_OPENTAG <font color="black">)</font>
            <font color="black">{</font>
                nParseFlags ^<font color="black">=</font> PD_OPENTAG;
                <font color="blue">if</font> <font color="black">(</font> cD <font color="black">&#62;</font> <font color="maroon">0x60</font> <font color="black">|</font><font color="black">|</font> <font color="black">(</font> cD <font color="black">&#62;</font> <font color="maroon">0x40</font> <font color="black">&</font><font color="black">&</font> cD <font color="black">&#60;</font> <font color="maroon">0x5b</font> <font color="black">)</font> <font color="black">|</font><font color="black">|</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">0x5f</font> <font color="black">|</font><font color="black">|</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">0x3a</font> <font color="black">)</font>
                    FINDNODETYPENAME<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"&#62;"</font><font color="black">)</font>, MNT_ELEMENT, <font color="maroon">1</font> <font color="black">)</font>
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'/'</font> <font color="black">)</font>
                    FINDNODETYPENAME<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"&#62;"</font><font color="black">)</font>, <font color="maroon">0</font>, <font color="maroon">2</font> <font color="black">)</font>
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'!'</font> <font color="black">)</font>
                    nParseFlags <font color="black">|</font><font color="black">=</font> PD_BANG;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'?'</font> <font color="black">)</font>
                    FINDNODETYPENAME<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"?&#62;"</font><font color="black">)</font>, MNT_PROCESSING_INSTRUCTION, <font color="maroon">2</font> <font color="black">)</font>
                <font color="blue">else</font>
                    FINDNODEBAD<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"tag name character"</font><font color="black">)</font> <font color="black">)</font>
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nParseFlags <font color="black">&</font> PD_BANG <font color="black">)</font>
            <font color="black">{</font>
                nParseFlags ^<font color="black">=</font> PD_BANG;
                <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'-'</font> <font color="black">)</font>
                    nParseFlags <font color="black">|</font><font color="black">=</font> PD_DASH;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'['</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font><font color="black">(</font>nParseFlags <font color="black">&</font> PD_DOCTYPE<font color="black">)</font> <font color="black">)</font>
                    nParseFlags <font color="black">|</font><font color="black">=</font> PD_BRACKET;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'D'</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font><font color="black">(</font>nParseFlags <font color="black">&</font> PD_DOCTYPE<font color="black">)</font> <font color="black">)</font>
                    nParseFlags <font color="black">|</font><font color="black">=</font> PD_DOCTYPE;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">"EAN"</font><font color="black">)</font>,<font color="black">(</font>MCD_CHAR<font color="black">)</font>cD<font color="black">)</font> <font color="black">)</font> <font color="green">// &#60;!ELEMENT ATTLIST ENTITY NOTATION</font>
                    FINDNODETYPE<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"&#62;"</font><font color="black">)</font>, MNT_DOCUMENT_TYPE <font color="black">)</font>
                <font color="blue">else</font>
                    FINDNODEBAD<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"! tag"</font><font color="black">)</font> <font color="black">)</font>
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nParseFlags <font color="black">&</font> PD_DASH <font color="black">)</font>
            <font color="black">{</font>
                nParseFlags ^<font color="black">=</font> PD_DASH;
                <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'-'</font> <font color="black">)</font>
                    FINDNODETYPE<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"--&#62;"</font><font color="black">)</font>, MNT_COMMENT <font color="black">)</font>
                <font color="blue">else</font>
                    FINDNODEBAD<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"comment tag"</font><font color="black">)</font> <font color="black">)</font>
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nParseFlags <font color="black">&</font> PD_BRACKET <font color="black">)</font>
            <font color="black">{</font>
                nParseFlags ^<font color="black">=</font> PD_BRACKET;
                <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'C'</font> <font color="black">)</font>
                    FINDNODETYPE<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"]]&#62;"</font><font color="black">)</font>, MNT_CDATA_SECTION <font color="black">)</font>
                <font color="blue">else</font>
                    FINDNODEBAD<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"tag"</font><font color="black">)</font> <font color="black">)</font>
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nParseFlags <font color="black">&</font> PD_DOCTYPE <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#60;'</font> <font color="black">)</font>
                    nParseFlags <font color="black">|</font><font color="black">=</font> PD_OPENTAG;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#62;'</font> <font color="black">)</font>
                <font color="black">{</font>
                    nR <font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pDoc <font color="black">-</font>token.pDoc<font color="black">)</font>;
                    nNodeType <font color="black">=</font> MNT_DOCUMENT_TYPE;
                    <font color="blue">break</font>;
                <font color="black">}</font>
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> cD <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#60;'</font> <font color="black">)</font>
        <font color="black">{</font>
            nParseFlags <font color="black">|</font><font color="black">=</font> PD_OPENTAG;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            nNodeType <font color="black">=</font> MNT_WHITESPACE;
            <font color="blue">if</font> <font color="black">(</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">" \t\n\r"</font><font color="black">)</font>,<font color="black">(</font>MCD_CHAR<font color="black">)</font>cD<font color="black">)</font> <font color="black">)</font>
                nParseFlags <font color="black">|</font><font color="black">=</font> PD_TEXTORWS;
            <font color="blue">else</font>
                FINDNODETYPE<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;"</font><font color="black">)</font>, MNT_TEXT <font color="black">)</font>
        <font color="black">}</font>
        pDoc <font color="black">+</font><font color="black">=</font> MCD_CLEN<font color="black">(</font> pDoc <font color="black">)</font>;
    <font color="black">}</font>
    token.nNext <font color="black">=</font> nR <font color="black">+</font> <font color="maroon">1</font>;
    node.nLength <font color="black">=</font> token.nNext <font color="black">-</font>node.nStart;
    node.nNodeType <font color="black">=</font> nNodeType;
    <font color="blue">return</font> nNodeType;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>x_GetPath<font color="black">(</font> <font color="blue">int</font> iPos <font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    MCD_STR strPath;
    <font color="blue">while</font> <font color="black">(</font> iPos <font color="black">)</font>
    <font color="black">{</font>
        MCD_STR strTagName <font color="black">=</font> x_GetTagName<font color="black">(</font> iPos <font color="black">)</font>;
        <font color="blue">int</font> iPosParent <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemParent;
        <font color="blue">int</font> iPosSib <font color="black">=</font> <font color="maroon">0</font>;
        <font color="blue">int</font> nCount <font color="black">=</font> <font color="maroon">0</font>;
        <font color="blue">while</font> <font color="black">(</font> iPosSib <font color="black">!</font><font color="black">=</font> iPos <font color="black">)</font>
        <font color="black">{</font>
            iPosSib <font color="black">=</font> x_FindElem<font color="black">(</font> iPosParent, iPosSib, MCD_2PCSZ<font color="black">(</font>strTagName<font color="black">)</font> <font color="black">)</font>;
            <font color="black">+</font><font color="black">+</font>nCount;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font> nCount <font color="black">&#62;</font> <font color="maroon">1</font> <font color="black">)</font>
        <font color="black">{</font>
            MCD_CHAR szPred<font color="black">[</font><font color="maroon">25</font><font color="black">]</font>;
            MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szPred<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"[%d]"</font><font color="black">)</font>, nCount <font color="black">)</font>;
            strPath <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"/"</font><font color="black">)</font> <font color="black">+</font> strTagName <font color="black">+</font> szPred <font color="black">+</font> strPath;
        <font color="black">}</font>
        <font color="blue">else</font>
            strPath <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"/"</font><font color="black">)</font> <font color="black">+</font> strTagName <font color="black">+</font> strPath;
        iPos <font color="black">=</font> iPosParent;
    <font color="black">}</font>
    <font color="blue">return</font> strPath;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>x_GetTagName<font color="black">(</font> <font color="blue">int</font> iPos <font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="green">// Return the tag name at specified element</font>
    TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
    token.nNext <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart <font color="black">+</font> <font color="maroon">1</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> iPos <font color="black">|</font><font color="black">|</font> <font color="black">!</font> x_FindName<font color="black">(</font> token <font color="black">)</font> <font color="black">)</font>
        <font color="blue">return</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;

    <font color="green">// Return substring of document</font>
    <font color="blue">return</font> x_GetToken<font color="black">(</font> token <font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_FindAttrib<font color="black">(</font> CMarkup<font color="black">:</font><font color="black">:</font>TokenPos<font color="black">&</font> token, MCD_PCSZ pAttrib, <font color="blue">int</font> n<font color="green">/*=0*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Return true if found, otherwise false and token.nNext is new insertion point</font>
    <font color="green">// If pAttrib is NULL find attrib n and leave token at attrib name</font>
    <font color="green">// If pAttrib is given, find matching attrib and leave token at value</font>
    <font color="green">// support non-well-formed attributes e.g. href=/advanced_search?hl=en, nowrap</font>
    <font color="green">// token also holds start and length of preceeding whitespace to support remove</font>
    <font color="green">//</font>
    <font color="blue">int</font> nPreSpaceStart;
    <font color="blue">int</font> nPreSpaceLength;
    <font color="blue">int</font> nChar;
    MCD_CHAR cFirstChar;
    MCD_PCSZ pDoc <font color="black">=</font> token.pDoc;
    <font color="blue">int</font> nAttrib <font color="black">=</font> <font color="maroon">-1</font>; <font color="green">// starts at tag name</font>
    <font color="blue">int</font> nFoundAttribNameR <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">bool</font> bAfterEqual <font color="black">=</font> <font color="blue">false</font>;
    <font color="blue">while</font> <font color="black">(</font> <font color="maroon">1</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Starting at token.nNext, bypass whitespace and find the next token</font>
        nChar <font color="black">=</font> token.nNext;
        nPreSpaceStart <font color="black">=</font> nChar;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> x_FindAny<font color="black">(</font>pDoc,nChar<font color="black">)</font> <font color="black">)</font>
            <font color="blue">break</font>;
        nPreSpaceLength <font color="black">=</font> nChar <font color="black">-</font>nPreSpaceStart;

        <font color="green">// Is it an opening quote?</font>
        cFirstChar <font color="black">=</font> pDoc<font color="black">[</font>nChar<font color="black">]</font>;
        <font color="blue">if</font> <font color="black">(</font> cFirstChar <font color="black">=</font><font color="black">=</font> <font color="maroon">'\"'</font> <font color="black">|</font><font color="black">|</font> cFirstChar <font color="black">=</font><font color="black">=</font> <font color="maroon">'\''</font> <font color="black">)</font>
        <font color="black">{</font>
            token.nTokenFlags <font color="black">|</font><font color="black">=</font> MNF_QUOTED;

            <font color="green">// Move past opening quote</font>
            <font color="black">+</font><font color="black">+</font>nChar;
            token.nL <font color="black">=</font> nChar;

            <font color="green">// Look for closing quote</font>
            <font color="blue">while</font> <font color="black">(</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">&</font><font color="black">&</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">!</font><font color="black">=</font> cFirstChar <font color="black">)</font>
                nChar <font color="black">+</font><font color="black">=</font> MCD_CLEN<font color="black">(</font> <font color="black">&</font>pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">)</font>;

            <font color="green">// Set right to before closing quote</font>
            token.nR <font color="black">=</font> nChar <font color="maroon">-1</font>;

            <font color="green">// Set nChar past closing quote unless at end of document</font>
            <font color="blue">if</font> <font color="black">(</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">)</font>
                <font color="black">+</font><font color="black">+</font>nChar;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            token.nTokenFlags <font color="black">&</font><font color="black">=</font> ~MNF_QUOTED;

            <font color="green">// Go until special char or whitespace</font>
            token.nL <font color="black">=</font> nChar;
            <font color="blue">if</font> <font color="black">(</font> bAfterEqual <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">while</font> <font color="black">(</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">" \t\n\r&#62;"</font><font color="black">)</font>,pDoc<font color="black">[</font>nChar<font color="black">]</font><font color="black">)</font> <font color="black">)</font>
                    nChar <font color="black">+</font><font color="black">=</font> MCD_CLEN<font color="black">(</font> <font color="black">&</font>pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">)</font>;
            <font color="black">}</font>
            <font color="blue">else</font>
            <font color="black">{</font>
                <font color="blue">while</font> <font color="black">(</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> MCD_PSZCHR<font color="black">(</font>MCD_T<font color="black">(</font><font color="maroon">"= \t\n\r&#62;/?"</font><font color="black">)</font>,pDoc<font color="black">[</font>nChar<font color="black">]</font><font color="black">)</font> <font color="black">)</font>
                    nChar <font color="black">+</font><font color="black">=</font> MCD_CLEN<font color="black">(</font> <font color="black">&</font>pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">)</font>;
            <font color="black">}</font>

            <font color="green">// Adjust end position if it is one special char</font>
            <font color="blue">if</font> <font color="black">(</font> nChar <font color="black">=</font><font color="black">=</font> token.nL <font color="black">)</font>
                <font color="black">+</font><font color="black">+</font>nChar; <font color="green">// it is a special char</font>
            token.nR <font color="black">=</font> nChar <font color="maroon">-1</font>;
        <font color="black">}</font>

        <font color="green">// nNext points to one past last char of token</font>
        token.nNext <font color="black">=</font> nChar;

        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> bAfterEqual <font color="black">&</font><font color="black">&</font> <font color="black">!</font> <font color="black">(</font>token.nTokenFlags<font color="black">&</font>MNF_QUOTED<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Is it an equal sign?</font>
            MCD_CHAR cChar <font color="black">=</font> pDoc<font color="black">[</font>token.nL<font color="black">]</font>;
            <font color="blue">if</font> <font color="black">(</font> cChar <font color="black">=</font><font color="black">=</font> <font color="maroon">'='</font> <font color="black">)</font>
            <font color="black">{</font>
                bAfterEqual <font color="black">=</font> <font color="blue">true</font>;
                <font color="blue">continue</font>;
            <font color="black">}</font>

            <font color="green">// Is it the right angle bracket?</font>
            <font color="blue">if</font> <font color="black">(</font> cChar <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#62;'</font> <font color="black">|</font><font color="black">|</font> cChar <font color="black">=</font><font color="black">=</font> <font color="maroon">'/'</font> <font color="black">|</font><font color="black">|</font> cChar <font color="black">=</font><font color="black">=</font> <font color="maroon">'?'</font> <font color="black">)</font>
            <font color="black">{</font>
                token.nNext <font color="black">=</font> nPreSpaceStart;
                <font color="blue">break</font>; <font color="green">// attrib not found</font>
            <font color="black">}</font>

            <font color="blue">if</font> <font color="black">(</font> nFoundAttribNameR <font color="black">)</font>
                <font color="blue">break</font>;

            <font color="green">// Attribute name</font>
            <font color="blue">if</font> <font color="black">(</font> nAttrib <font color="black">!</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> pAttrib <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">if</font> <font color="black">(</font> nAttrib <font color="black">=</font><font color="black">=</font> n <font color="black">)</font>
                        <font color="blue">return</font> <font color="blue">true</font>; <font color="green">// found by number</font>
                <font color="black">}</font>
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> token.Match<font color="black">(</font>pAttrib<font color="black">)</font> <font color="black">)</font>
                <font color="black">{</font>
                    <font color="green">// Matched attrib name, go forward to value</font>
                    nFoundAttribNameR <font color="black">=</font> token.nR;
                    token.nPreSpaceStart <font color="black">=</font> nPreSpaceStart;
                    token.nPreSpaceLength <font color="black">=</font> nPreSpaceLength;
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="black">+</font><font color="black">+</font>nAttrib;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nFoundAttribNameR <font color="black">)</font>
            <font color="blue">break</font>;
        bAfterEqual <font color="black">=</font> <font color="blue">false</font>;
    <font color="black">}</font>

    <font color="blue">if</font> <font color="black">(</font> nFoundAttribNameR <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> bAfterEqual <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// when attribute has no value the value is the attribute name</font>
            token.nL <font color="black">=</font> token.nPreSpaceStart <font color="black">+</font> token.nPreSpaceLength;
            token.nR <font color="black">=</font> nFoundAttribNameR;
            token.nNext <font color="black">=</font> nFoundAttribNameR <font color="black">+</font> <font color="maroon">1</font>;
        <font color="black">}</font>
        <font color="blue">return</font> <font color="blue">true</font>; <font color="green">// found by name</font>
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>; <font color="green">// not found</font>
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>x_GetAttrib<font color="black">(</font> <font color="blue">int</font> iPos, MCD_PCSZ pAttrib <font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="green">// Return the value of the attrib</font>
    TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">&</font><font color="black">&</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
        token.nNext <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart <font color="black">+</font> <font color="maroon">1</font>;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">=</font><font color="black">=</font> m_iPos <font color="black">&</font><font color="black">&</font> m_nNodeLength <font color="black">&</font><font color="black">&</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_PROCESSING_INSTRUCTION <font color="black">)</font>
        token.nNext <font color="black">=</font> m_nNodeOffset <font color="black">+</font> <font color="maroon">2</font>;
    <font color="blue">else</font>
        <font color="blue">return</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;

    <font color="blue">if</font> <font color="black">(</font> pAttrib <font color="black">&</font><font color="black">&</font> x_FindAttrib<font color="black">(</font> token, pAttrib <font color="black">)</font> <font color="black">)</font>
        <font color="blue">return</font> UnescapeText<font color="black">(</font> <font color="black">&</font>token.pDoc<font color="black">[</font>token.nL<font color="black">]</font>, token.Length<font color="black">(</font><font color="black">)</font> <font color="black">)</font>;
    <font color="blue">return</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_SetAttrib<font color="black">(</font> <font color="blue">int</font> iPos, MCD_PCSZ pAttrib, <font color="blue">int</font> nValue, <font color="blue">int</font> nFlags <font color="green">/*=0*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Convert integer to string</font>
    MCD_CHAR szVal<font color="black">[</font><font color="maroon">25</font><font color="black">]</font>;
    MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szVal<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"%d"</font><font color="black">)</font>, nValue <font color="black">)</font>;
    <font color="blue">return</font> x_SetAttrib<font color="black">(</font> iPos, pAttrib, szVal, nFlags <font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_SetAttrib<font color="black">(</font> <font color="blue">int</font> iPos, MCD_PCSZ pAttrib, MCD_PCSZ pValue, <font color="blue">int</font> nFlags <font color="green">/*=0*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Set attribute in iPos element</font>
    TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">&</font><font color="black">&</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
        token.nNext <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart <font color="black">+</font> <font color="maroon">1</font>;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">=</font><font color="black">=</font> m_iPos <font color="black">&</font><font color="black">&</font> m_nNodeLength <font color="black">&</font><font color="black">&</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_PROCESSING_INSTRUCTION <font color="black">)</font>
        token.nNext <font color="black">=</font> m_nNodeOffset <font color="black">+</font> <font color="maroon">2</font>;
    <font color="blue">else</font>
        <font color="blue">return</font> <font color="blue">false</font>;

    <font color="green">// Create insertion text depending on whether attribute already exists</font>
    <font color="green">// Decision: for empty value leaving attrib="" instead of removing attrib</font>
    <font color="blue">int</font> nReplace <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> nInsertAt;
    MCD_STR strInsert;
    strInsert <font color="black">+</font><font color="black">=</font> x_ATTRIBQUOTE;
    strInsert <font color="black">+</font><font color="black">=</font> EscapeText<font color="black">(</font> pValue, MNF_ESCAPEQUOTES<font color="black">|</font>nFlags <font color="black">)</font>;
    strInsert <font color="black">+</font><font color="black">=</font> x_ATTRIBQUOTE;
    <font color="blue">if</font> <font color="black">(</font> x_FindAttrib<font color="black">(</font> token, pAttrib <font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Replace value</font>
        nInsertAt <font color="black">=</font> token.nL <font color="black">-</font><font color="black">(</font><font color="black">(</font>token.nTokenFlags<font color="black">&</font>MNF_QUOTED<font color="black">)</font>?<font color="maroon">1</font><font color="black">:</font><font color="maroon">0</font><font color="black">)</font>;
        nReplace <font color="black">=</font> token.Length<font color="black">(</font><font color="black">)</font> <font color="black">+</font> <font color="black">(</font><font color="black">(</font>token.nTokenFlags<font color="black">&</font>MNF_QUOTED<font color="black">)</font>?<font color="maroon">2</font><font color="black">:</font><font color="maroon">0</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="green">// Insert string name value pair</font>
        MCD_STR strFormat;
        strFormat <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">" "</font><font color="black">)</font>;
        strFormat <font color="black">+</font><font color="black">=</font> pAttrib;
        strFormat <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"="</font><font color="black">)</font>;
        strFormat <font color="black">+</font><font color="black">=</font> strInsert;
        strInsert <font color="black">=</font> strFormat;
        nInsertAt <font color="black">=</font> token.nNext;
    <font color="black">}</font>

    x_DocChange<font color="black">(</font> nInsertAt, nReplace, strInsert <font color="black">)</font>;
    <font color="blue">int</font> nAdjust <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>strInsert<font color="black">)</font> <font color="black">-</font>nReplace;
    <font color="blue">if</font> <font color="black">(</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_PROCESSING_INSTRUCTION <font color="black">)</font>
    <font color="black">{</font>
        x_AdjustForNode<font color="black">(</font> m_iPosParent, m_iPos, nAdjust <font color="black">)</font>;
        m_nNodeLength <font color="black">+</font><font color="black">=</font> nAdjust;
        MARKUP_SETDEBUGSTATE;
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    m_aPos<font color="black">[</font>iPos<font color="black">]</font>.AdjustStartTagLen<font color="black">(</font> nAdjust <font color="black">)</font>;
    m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nLength <font color="black">+</font><font color="black">=</font> nAdjust;
    x_Adjust<font color="black">(</font> iPos, nAdjust <font color="black">)</font>;
    MARKUP_SETDEBUGSTATE;
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>


<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_CreateNode<font color="black">(</font> MCD_STR<font color="black">&</font> strNode, <font color="blue">int</font> nNodeType, MCD_PCSZ pText <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Set strNode based on nNodeType and szData</font>
    <font color="green">// Return false if szData would jeopardize well-formed document</font>
    <font color="green">//</font>
    <font color="blue">switch</font> <font color="black">(</font> nNodeType <font color="black">)</font>
    <font color="black">{</font>
    <font color="blue">case</font> MNT_PROCESSING_INSTRUCTION<font color="black">:</font>
        strNode <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;?"</font><font color="black">)</font>;
        strNode <font color="black">+</font><font color="black">=</font> pText;
        strNode <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"?&#62;"</font><font color="black">)</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MNT_COMMENT<font color="black">:</font>
        strNode <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;!--"</font><font color="black">)</font>;
        strNode <font color="black">+</font><font color="black">=</font> pText;
        strNode <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"--&#62;"</font><font color="black">)</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MNT_ELEMENT<font color="black">:</font>
        strNode <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;"</font><font color="black">)</font>;
        strNode <font color="black">+</font><font color="black">=</font> pText;
        strNode <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"/&#62;"</font><font color="black">)</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MNT_TEXT<font color="black">:</font>
    <font color="blue">case</font> MNT_WHITESPACE<font color="black">:</font>
        strNode <font color="black">=</font> EscapeText<font color="black">(</font> pText <font color="black">)</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MNT_DOCUMENT_TYPE<font color="black">:</font>
        strNode <font color="black">=</font> pText;
        <font color="blue">break</font>;
    <font color="blue">case</font> MNT_LONE_END_TAG<font color="black">:</font>
        <font color="blue">return</font> <font color="blue">false</font>;
    <font color="blue">case</font> MNT_CDATA_SECTION<font color="black">:</font>
        <font color="blue">if</font> <font color="black">(</font> MCD_PSZSTR<font color="black">(</font>pText,MCD_T<font color="black">(</font><font color="maroon">"]]&#62;"</font><font color="black">)</font><font color="black">)</font> <font color="black">!</font><font color="black">=</font> NULL <font color="black">)</font>
            <font color="blue">return</font> <font color="blue">false</font>;
        strNode <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;![CDATA["</font><font color="black">)</font>;
        strNode <font color="black">+</font><font color="black">=</font> pText;
        strNode <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"]]&#62;"</font><font color="black">)</font>;
        <font color="blue">break</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>x_EncodeCDATASection<font color="black">(</font> MCD_PCSZ szData <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Split CDATA Sections if there are any end delimiters</font>
    MCD_STR strData <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;![CDATA["</font><font color="black">)</font>;
    MCD_PCSZ pszNextStart <font color="black">=</font> szData;
    MCD_PCSZ pszEnd <font color="black">=</font> MCD_PSZSTR<font color="black">(</font> szData, MCD_T<font color="black">(</font><font color="maroon">"]]&#62;"</font><font color="black">)</font> <font color="black">)</font>;
    <font color="blue">while</font> <font color="black">(</font> pszEnd <font color="black">)</font>
    <font color="black">{</font>
        strData <font color="black">+</font><font color="black">=</font> MCD_STR<font color="black">(</font> pszNextStart, <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pszEnd <font color="black">-</font>pszNextStart<font color="black">)</font> <font color="black">)</font>;
        strData <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"]]]]&#62;&#60;![CDATA[&#62;"</font><font color="black">)</font>;
        pszNextStart <font color="black">=</font> pszEnd <font color="black">+</font> <font color="maroon">3</font>;
        pszEnd <font color="black">=</font> MCD_PSZSTR<font color="black">(</font> pszNextStart, MCD_T<font color="black">(</font><font color="maroon">"]]&#62;"</font><font color="black">)</font> <font color="black">)</font>;
    <font color="black">}</font>
    strData <font color="black">+</font><font color="black">=</font> pszNextStart;
    strData <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"]]&#62;"</font><font color="black">)</font>;
    <font color="blue">return</font> strData;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_SetData<font color="black">(</font> <font color="blue">int</font> iPos, <font color="blue">int</font> nValue <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Convert integer to string</font>
    MCD_CHAR szVal<font color="black">[</font><font color="maroon">25</font><font color="black">]</font>;
    MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szVal<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"%d"</font><font color="black">)</font>, nValue <font color="black">)</font>;
    <font color="blue">return</font> x_SetData<font color="black">(</font> iPos, szVal, <font color="maroon">0</font> <font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_SetData<font color="black">(</font> <font color="blue">int</font> iPos, MCD_PCSZ szData, <font color="blue">int</font> nFlags <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Set data at specified position</font>
    <font color="green">// if nFlags==1, set content of element to a CDATA Section</font>
    MCD_STR strInsert;

    <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">=</font><font color="black">=</font> m_iPos <font color="black">&</font><font color="black">&</font> m_nNodeLength <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Not an element</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> x_CreateNode<font color="black">(</font>strInsert, m_nNodeType, szData<font color="black">)</font> <font color="black">)</font>
            <font color="blue">return</font> <font color="blue">false</font>;
        x_DocChange<font color="black">(</font> m_nNodeOffset, m_nNodeLength, strInsert <font color="black">)</font>;
        x_AdjustForNode<font color="black">(</font> m_iPosParent, iPos, MCD_STRLENGTH<font color="black">(</font>strInsert<font color="black">)</font> <font color="black">-</font>m_nNodeLength <font color="black">)</font>;
        m_nNodeLength <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>strInsert<font color="black">)</font>;
        MARKUP_SETDEBUGSTATE;
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>

    <font color="green">// Set data in iPos element</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> iPos <font color="black">|</font><font color="black">|</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemChild <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;

    <font color="green">// Build strInsert from szData based on nFlags</font>
    <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_WITHCDATA <font color="black">)</font>
        strInsert <font color="black">=</font> x_EncodeCDATASection<font color="black">(</font> szData <font color="black">)</font>;
    <font color="blue">else</font>
        strInsert <font color="black">=</font> EscapeText<font color="black">(</font> szData, nFlags <font color="black">)</font>;

    <font color="green">// Insert</font>
    NodePos node<font color="black">(</font> MNF_WITHNOLINES<font color="black">|</font>MNF_REPLACE <font color="black">)</font>;
    node.strMeta <font color="black">=</font> strInsert;
    <font color="blue">int</font> iPosBefore <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> nReplace <font color="black">=</font> x_InsertNew<font color="black">(</font> iPos, iPosBefore, node <font color="black">)</font>;
    <font color="blue">int</font> nAdjust <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>node.strMeta<font color="black">)</font> <font color="black">-</font>nReplace;
    x_Adjust<font color="black">(</font> iPos, nAdjust <font color="black">)</font>;
    m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nLength <font color="black">+</font><font color="black">=</font> nAdjust;
    <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nFlags <font color="black">&</font> MNF_ILLDATA <font color="black">)</font>
        m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nFlags <font color="black">&</font><font color="black">=</font> ~MNF_ILLDATA;
    MARKUP_SETDEBUGSTATE;
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>x_GetData<font color="black">(</font> <font color="blue">int</font> iPos <font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">=</font><font color="black">=</font> m_iPos <font color="black">&</font><font color="black">&</font> m_nNodeLength <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_COMMENT <font color="black">)</font>
            <font color="blue">return</font> MCD_STRMID<font color="black">(</font> m_strDoc, m_nNodeOffset<font color="black">+</font><font color="maroon">4</font>, m_nNodeLength<font color="maroon">-7</font> <font color="black">)</font>;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_PROCESSING_INSTRUCTION <font color="black">)</font>
            <font color="blue">return</font> MCD_STRMID<font color="black">(</font> m_strDoc, m_nNodeOffset<font color="black">+</font><font color="maroon">2</font>, m_nNodeLength<font color="maroon">-4</font> <font color="black">)</font>;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_CDATA_SECTION <font color="black">)</font>
            <font color="blue">return</font> MCD_STRMID<font color="black">(</font> m_strDoc, m_nNodeOffset<font color="black">+</font><font color="maroon">9</font>, m_nNodeLength<font color="maroon">-12</font> <font color="black">)</font>;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_TEXT <font color="black">)</font>
            <font color="blue">return</font> UnescapeText<font color="black">(</font> <font color="black">&</font><font color="black">(</font>MCD_2PCSZ<font color="black">(</font>m_strDoc<font color="black">)</font><font color="black">)</font><font color="black">[</font>m_nNodeOffset<font color="black">]</font>, m_nNodeLength <font color="black">)</font>;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> m_nNodeType <font color="black">=</font><font color="black">=</font> MNT_LONE_END_TAG <font color="black">)</font>
            <font color="blue">return</font> MCD_STRMID<font color="black">(</font> m_strDoc, m_nNodeOffset<font color="black">+</font><font color="maroon">2</font>, m_nNodeLength<font color="maroon">-3</font> <font color="black">)</font>;
        <font color="blue">else</font>
            <font color="blue">return</font> MCD_STRMID<font color="black">(</font> m_strDoc, m_nNodeOffset, m_nNodeLength <font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// Return a string representing data between start and end tag</font>
    <font color="green">// Return empty string if there are any children elements</font>
    MCD_STR strData;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemChild <font color="black">&</font><font color="black">&</font> <font color="black">!</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.IsEmptyElement<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Quick scan for any tags inside content</font>
        <font color="blue">int</font> nContentLen <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.ContentLen<font color="black">(</font><font color="black">)</font>;
        <font color="blue">int</font> nStartContent <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>;
        MCD_PCSZ pszContent <font color="black">=</font> <font color="black">&</font><font color="black">(</font>MCD_2PCSZ<font color="black">(</font>m_strDoc<font color="black">)</font><font color="black">)</font><font color="black">[</font>nStartContent<font color="black">]</font>;
        MCD_PCSZ pszTag <font color="black">=</font> MCD_PSZCHR<font color="black">(</font> pszContent, <font color="maroon">'&#60;'</font> <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> pszTag <font color="black">&</font><font color="black">&</font> <font color="black">(</font><font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>pszTag<font color="black">-</font>pszContent<font color="black">)</font> <font color="black">&#60;</font> nContentLen<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Concatenate all CDATA Sections and text nodes, ignore other nodes</font>
            TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
            token.nNext <font color="black">=</font> nStartContent;
            NodePos node;
            <font color="blue">while</font> <font color="black">(</font> token.nNext <font color="black">&#60;</font> nStartContent <font color="black">+</font> nContentLen <font color="black">)</font>
            <font color="black">{</font>
                x_ParseNode<font color="black">(</font> token, node <font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> node.nNodeType <font color="black">=</font><font color="black">=</font> MNT_TEXT <font color="black">)</font>
                    strData <font color="black">+</font><font color="black">=</font> UnescapeText<font color="black">(</font> <font color="black">&</font>token.pDoc<font color="black">[</font>node.nStart<font color="black">]</font>, node.nLength <font color="black">)</font>;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> node.nNodeType <font color="black">=</font><font color="black">=</font> MNT_CDATA_SECTION <font color="black">)</font>
                    strData <font color="black">+</font><font color="black">=</font> MCD_STRMID<font color="black">(</font> m_strDoc, node.nStart<font color="black">+</font><font color="maroon">9</font>, node.nLength<font color="maroon">-12</font> <font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="green">// no tags</font>
            strData <font color="black">=</font> UnescapeText<font color="black">(</font> <font color="black">&</font><font color="black">(</font>MCD_2PCSZ<font color="black">(</font>m_strDoc<font color="black">)</font><font color="black">)</font><font color="black">[</font>nStartContent<font color="black">]</font>, nContentLen <font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> strData;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>x_GetElemContent<font color="black">(</font> <font color="blue">int</font> iPos <font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">&</font><font color="black">&</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.ContentLen<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
        <font color="blue">return</font> MCD_STRMID<font color="black">(</font> m_strDoc, m_aPos<font color="black">[</font>iPos<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>, m_aPos<font color="black">[</font>iPos<font color="black">]</font>.ContentLen<font color="black">(</font><font color="black">)</font> <font color="black">)</font>;
    <font color="blue">return</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_SetElemContent<font color="black">(</font> MCD_PCSZ szContent <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Set data in iPos element only</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> m_iPos <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;

    <font color="blue">if</font> <font color="black">(</font> m_nNodeLength <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>; <font color="green">// not an element</font>

    <font color="green">// Unlink all children</font>
    <font color="blue">int</font> iPos <font color="black">=</font> m_iPos;
    <font color="blue">int</font> iPosChild <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemChild;
    <font color="blue">bool</font> bHadChild <font color="black">=</font> <font color="black">(</font>iPosChild <font color="black">!</font><font color="black">=</font> <font color="maroon">0</font><font color="black">)</font>;
    <font color="blue">while</font> <font color="black">(</font> iPosChild <font color="black">)</font>
        iPosChild <font color="black">=</font> x_ReleaseSubDoc<font color="black">(</font> iPosChild <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> bHadChild <font color="black">)</font>
        x_CheckSavedPos<font color="black">(</font><font color="black">)</font>;

    <font color="green">// Parse content</font>
    <font color="blue">bool</font> bWellFormed <font color="black">=</font> <font color="blue">true</font>;
    TokenPos token<font color="black">(</font> szContent, m_nDocFlags <font color="black">)</font>;
    <font color="blue">int</font> iPosVirtual <font color="black">=</font> x_GetFreePos<font color="black">(</font><font color="black">)</font>;
    m_aPos<font color="black">[</font>iPosVirtual<font color="black">]</font>.ClearVirtualParent<font color="black">(</font><font color="black">)</font>;
    m_aPos<font color="black">[</font>iPosVirtual<font color="black">]</font>.SetLevel<font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.Level<font color="black">(</font><font color="black">)</font> <font color="black">+</font> <font color="maroon">1</font> <font color="black">)</font>;
    iPosChild <font color="black">=</font> x_ParseElem<font color="black">(</font> iPosVirtual, token <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPosVirtual<font color="black">]</font>.nFlags <font color="black">&</font> MNF_ILLFORMED <font color="black">)</font>
        bWellFormed <font color="black">=</font> <font color="blue">false</font>;
    m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nFlags <font color="black">=</font> <font color="black">(</font>m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nFlags <font color="black">&</font> ~MNF_ILLDATA<font color="black">)</font> <font color="black">|</font> <font color="black">(</font>m_aPos<font color="black">[</font>iPosVirtual<font color="black">]</font>.nFlags <font color="black">&</font> MNF_ILLDATA<font color="black">)</font>;

    <font color="green">// Prepare insert and adjust offsets</font>
    NodePos node<font color="black">(</font> MNF_WITHNOLINES<font color="black">|</font>MNF_REPLACE <font color="black">)</font>;
    node.strMeta <font color="black">=</font> szContent;
    <font color="blue">int</font> iPosBefore <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> nReplace <font color="black">=</font> x_InsertNew<font color="black">(</font> iPos, iPosBefore, node <font color="black">)</font>;
    
    <font color="green">// Adjust and link in the inserted elements</font>
    x_Adjust<font color="black">(</font> iPosChild, node.nStart <font color="black">)</font>;
    m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.nStart <font color="black">+</font><font color="black">=</font> node.nStart;
    m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemChild <font color="black">=</font> iPosChild;
    <font color="blue">while</font> <font color="black">(</font> iPosChild <font color="black">)</font>
    <font color="black">{</font>
        m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.iElemParent <font color="black">=</font> iPos;
        iPosChild <font color="black">=</font> m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.iElemNext;
    <font color="black">}</font>
    x_ReleasePos<font color="black">(</font> iPosVirtual <font color="black">)</font>;

    <font color="blue">int</font> nAdjust <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>node.strMeta<font color="black">)</font> <font color="black">-</font>nReplace;
    x_Adjust<font color="black">(</font> iPos, nAdjust, <font color="blue">true</font> <font color="black">)</font>;
    m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nLength <font color="black">+</font><font color="black">=</font> nAdjust;

    x_SetPos<font color="black">(</font> m_iPosParent, m_iPos, <font color="maroon">0</font> <font color="black">)</font>;
    <font color="blue">return</font> bWellFormed;
<font color="black">}</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font>x_DocChange<font color="black">(</font> <font color="blue">int</font> nLeft, <font color="blue">int</font> nReplace, <font color="blue">const</font> MCD_STR<font color="black">&</font> strInsert <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Insert strInsert int m_strDoc at nLeft replacing nReplace chars</font>
    <font color="green">// When creating a document, reduce reallocs by reserving string space</font>
    <font color="green">// If realloc needed, allow for 1.5 times the new length</font>
    <font color="green">//</font>
    <font color="blue">int</font> nDocLength <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>m_strDoc<font color="black">)</font>;
    <font color="blue">int</font> nInsLength <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>strInsert<font color="black">)</font>;
    <font color="blue">int</font> nNewLength <font color="black">=</font> nInsLength <font color="black">+</font> nDocLength <font color="black">-</font>nReplace;
    <font color="blue">int</font> nAllocLen <font color="black">=</font> MCD_STRCAPACITY<font color="black">(</font>m_strDoc<font color="black">)</font>;
<font color="blue">#if</font> defined<font color="black">(</font>MCD_STRINSERTREPLACE<font color="black">)</font> <font color="green">// STL, replace method</font>
    <font color="blue">if</font> <font color="black">(</font> nNewLength <font color="black">&#62;</font> nAllocLen <font color="black">)</font>
        MCD_BLDRESERVE<font color="black">(</font> m_strDoc, <font color="black">(</font>nNewLength <font color="black">+</font> nNewLength<font color="black">/</font><font color="maroon">2</font> <font color="black">+</font> <font color="maroon">128</font><font color="black">)</font> <font color="black">)</font>;
    MCD_STRINSERTREPLACE<font color="black">(</font> m_strDoc, nLeft, nReplace, strInsert <font color="black">)</font>;
<font color="blue">#else</font> <font color="green">// MFC, no replace method</font>
    <font color="blue">int</font> nBufferLen <font color="black">=</font> nNewLength;
    <font color="blue">if</font> <font color="black">(</font> nNewLength <font color="black">&#62;</font> nAllocLen <font color="black">)</font>
        nBufferLen <font color="black">+</font><font color="black">=</font> nBufferLen<font color="black">/</font><font color="maroon">2</font> <font color="black">+</font> <font color="maroon">128</font>;
    MCD_CHAR<font color="black">*</font> pDoc <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font> m_strDoc, nBufferLen <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> nInsLength <font color="black">!</font><font color="black">=</font> nReplace <font color="black">&</font><font color="black">&</font> nLeft<font color="black">+</font>nReplace <font color="black">&#60;</font> nDocLength <font color="black">)</font>
        memmove<font color="black">(</font> <font color="black">&</font>pDoc<font color="black">[</font>nLeft<font color="black">+</font>nInsLength<font color="black">]</font>, <font color="black">&</font>pDoc<font color="black">[</font>nLeft<font color="black">+</font>nReplace<font color="black">]</font>, <font color="black">(</font>nDocLength<font color="black">-</font>nLeft<font color="black">-</font>nReplace<font color="black">)</font><font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font>MCD_CHAR<font color="black">)</font> <font color="black">)</font>;
    memcpy<font color="black">(</font> <font color="black">&</font>pDoc<font color="black">[</font>nLeft<font color="black">]</font>, strInsert, nInsLength<font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font>MCD_CHAR<font color="black">)</font> <font color="black">)</font>;
    MCD_RELEASEBUFFER<font color="black">(</font> m_strDoc, pDoc, nNewLength <font color="black">)</font>;
<font color="blue">#endif</font> <font color="green">// MFC, no replace method</font>

<font color="black">}</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font>x_Adjust<font color="black">(</font> <font color="blue">int</font> iPos, <font color="blue">int</font> nShift, <font color="blue">bool</font> bAfterPos <font color="green">/*=false*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Loop through affected elements and adjust indexes</font>
    <font color="green">// Algorithm:</font>
    <font color="green">// 1. update children unless bAfterPos</font>
    <font color="green">//    (if no children or bAfterPos is true, length of iPos not affected)</font>
    <font color="green">// 2. update starts of next siblings and their children</font>
    <font color="green">// 3. go up until there is a next sibling of a parent and update starts</font>
    <font color="green">// 4. step 2</font>
    <font color="blue">int</font> iPosTop <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemParent;
    <font color="blue">bool</font> bPosFirst <font color="black">=</font> bAfterPos; <font color="green">// mark as first to skip its children</font>

    <font color="green">// Stop when we've reached the virtual parent (which has no tags)</font>
    <font color="blue">while</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.StartTagLen<font color="black">(</font><font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Were we at containing parent of affected position?</font>
        <font color="blue">bool</font> bPosTop <font color="black">=</font> <font color="blue">false</font>;
        <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">=</font><font color="black">=</font> iPosTop <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Move iPosTop up one towards root</font>
            iPosTop <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemParent;
            bPosTop <font color="black">=</font> <font color="blue">true</font>;
        <font color="black">}</font>

        <font color="green">// Traverse to the next update position</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> bPosTop <font color="black">&</font><font color="black">&</font> <font color="black">!</font> bPosFirst <font color="black">&</font><font color="black">&</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemChild <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// Depth first</font>
            iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemChild;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext <font color="black">)</font>
        <font color="black">{</font>
            iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            <font color="green">// Look for next sibling of a parent of iPos</font>
            <font color="green">// When going back up, parents have already been done except iPosTop</font>
            <font color="blue">while</font> <font color="black">(</font> <font color="maroon">1</font> <font color="black">)</font>
            <font color="black">{</font>
                iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemParent;
                <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">=</font><font color="black">=</font> iPosTop <font color="black">)</font>
                    <font color="blue">break</font>;
                <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext <font color="black">)</font>
                <font color="black">{</font>
                    iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext;
                    <font color="blue">break</font>;
                <font color="black">}</font>
            <font color="black">}</font>
        <font color="black">}</font>
        bPosFirst <font color="black">=</font> <font color="blue">false</font>;

        <font color="green">// Shift indexes at iPos</font>
        <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">!</font><font color="black">=</font> iPosTop <font color="black">)</font>
            m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart <font color="black">+</font><font color="black">=</font> nShift;
        <font color="blue">else</font>
            m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nLength <font color="black">+</font><font color="black">=</font> nShift;
    <font color="black">}</font>
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_InsertNew<font color="black">(</font> <font color="blue">int</font> iPosParent, <font color="blue">int</font><font color="black">&</font> iPosRel, CMarkup<font color="black">:</font><font color="black">:</font>NodePos<font color="black">&</font> node <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Parent empty tag or tags with no content?</font>
    <font color="blue">bool</font> bEmptyParentTag <font color="black">=</font> iPosParent <font color="black">&</font><font color="black">&</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.IsEmptyElement<font color="black">(</font><font color="black">)</font>;
    <font color="blue">bool</font> bNoContentParentTags <font color="black">=</font> iPosParent <font color="black">&</font><font color="black">&</font> <font color="black">!</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.ContentLen<font color="black">(</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> node.nLength <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Located at a non-element node</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>node.nNodeFlags <font color="black">&</font> MNF_INSERT<font color="black">)</font> <font color="black">)</font>
            node.nStart <font color="black">+</font><font color="black">=</font> node.nLength;
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> iPosRel <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Located at an element</font>
        node.nStart <font color="black">=</font> m_aPos<font color="black">[</font>iPosRel<font color="black">]</font>.nStart;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>node.nNodeFlags <font color="black">&</font> MNF_INSERT<font color="black">)</font> <font color="black">)</font> <font color="green">// follow iPosRel</font>
            node.nStart <font color="black">+</font><font color="black">=</font> m_aPos<font color="black">[</font>iPosRel<font color="black">]</font>.nLength;
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> bEmptyParentTag <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Parent has no separate end tag, so split empty element</font>
        <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.nFlags <font color="black">&</font> MNF_NONENDED <font color="black">)</font>
            node.nStart <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>;
        <font color="blue">else</font>
            node.nStart <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font> <font color="maroon">-1</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> node.nNodeFlags <font color="black">&</font> <font color="black">(</font>MNF_INSERT<font color="black">|</font>MNF_REPLACE<font color="black">)</font> <font color="black">)</font>
            node.nStart <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>;
        <font color="blue">else</font> <font color="green">// before end tag</font>
            node.nStart <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartAfter<font color="black">(</font><font color="black">)</font> <font color="black">-</font>m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.EndTagLen<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// Go up to start of next node, unless its splitting an empty element</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>node.nNodeFlags<font color="black">&</font><font color="black">(</font>MNF_WITHNOLINES<font color="black">|</font>MNF_REPLACE<font color="black">)</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> bEmptyParentTag <font color="black">)</font>
    <font color="black">{</font>
        MCD_PCSZ pDoc <font color="black">=</font> MCD_2PCSZ<font color="black">(</font>m_strDoc<font color="black">)</font>;
        <font color="blue">int</font> nChar <font color="black">=</font> node.nStart;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> x_FindAny<font color="black">(</font>pDoc,nChar<font color="black">)</font> <font color="black">|</font><font color="black">|</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#60;'</font> <font color="black">)</font>
            node.nStart <font color="black">=</font> nChar;
    <font color="black">}</font>

    <font color="green">// Is insert relative to element position? (i.e. not other kind of node)</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> node.nLength <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Modify iPosRel to reflect position before</font>
        <font color="blue">if</font> <font color="black">(</font> iPosRel <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> node.nNodeFlags <font color="black">&</font> MNF_INSERT <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>m_aPos<font color="black">[</font>iPosRel<font color="black">]</font>.nFlags <font color="black">&</font> MNF_FIRST<font color="black">)</font> <font color="black">)</font>
                    iPosRel <font color="black">=</font> m_aPos<font color="black">[</font>iPosRel<font color="black">]</font>.iElemPrev;
                <font color="blue">else</font>
                    iPosRel <font color="black">=</font> <font color="maroon">0</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>node.nNodeFlags <font color="black">&</font> MNF_INSERT<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// If parent has a child, add after last child</font>
            <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild <font color="black">)</font>
                iPosRel <font color="black">=</font> m_aPos<font color="black">[</font>m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild<font color="black">]</font>.iElemPrev;
        <font color="black">}</font>
    <font color="black">}</font>

    <font color="green">// Get node length (used only by x_AddNode)</font>
    node.nLength <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>node.strMeta<font color="black">)</font>;

    <font color="green">// Prepare end of lines</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font><font color="black">!</font> <font color="black">(</font>node.nNodeFlags <font color="black">&</font> MNF_WITHNOLINES<font color="black">)</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>bEmptyParentTag <font color="black">|</font><font color="black">|</font> bNoContentParentTags<font color="black">)</font> <font color="black">)</font>
        node.nStart <font color="black">+</font><font color="black">=</font> x_EOLLEN;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>node.nNodeFlags <font color="black">&</font> MNF_WITHNOLINES<font color="black">)</font> <font color="black">)</font>
        node.strMeta <font color="black">+</font><font color="black">=</font> x_EOL;

    <font color="green">// Calculate insert offset and replace length</font>
    <font color="blue">int</font> nReplace <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> nInsertAt <font color="black">=</font> node.nStart;
    <font color="blue">if</font> <font color="black">(</font> bEmptyParentTag <font color="black">)</font>
    <font color="black">{</font>
        MCD_STR strTagName <font color="black">=</font> x_GetTagName<font color="black">(</font> iPosParent <font color="black">)</font>;
        MCD_STR strFormat;
        <font color="blue">if</font> <font color="black">(</font> node.nNodeFlags <font color="black">&</font> MNF_WITHNOLINES <font color="black">)</font>
            strFormat <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#62;"</font><font color="black">)</font>;
        <font color="blue">else</font>
            strFormat <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#62;"</font><font color="black">)</font> x_EOL;
        strFormat <font color="black">+</font><font color="black">=</font> node.strMeta;
        strFormat <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;/"</font><font color="black">)</font>;
        strFormat <font color="black">+</font><font color="black">=</font> strTagName;
        node.strMeta <font color="black">=</font> strFormat;
        <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.nFlags <font color="black">&</font> MNF_NONENDED <font color="black">)</font>
        <font color="black">{</font>
            nInsertAt <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartAfter<font color="black">(</font><font color="black">)</font> <font color="maroon">-1</font>;
            nReplace <font color="black">=</font> <font color="maroon">0</font>;
            m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.nFlags ^<font color="black">=</font> MNF_NONENDED;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            nInsertAt <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartAfter<font color="black">(</font><font color="black">)</font> <font color="maroon">-2</font>;
            nReplace <font color="black">=</font> <font color="maroon">1</font>;
            m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.AdjustStartTagLen<font color="black">(</font> <font color="maroon">-1</font> <font color="black">)</font>;
        <font color="black">}</font>
        m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.SetEndTagLen<font color="black">(</font> <font color="maroon">3</font> <font color="black">+</font> MCD_STRLENGTH<font color="black">(</font>strTagName<font color="black">)</font> <font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> node.nNodeFlags <font color="black">&</font> MNF_REPLACE <font color="black">)</font>
        <font color="black">{</font>
            nInsertAt <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>;
            nReplace <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.ContentLen<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> bNoContentParentTags <font color="black">)</font>
        <font color="black">{</font>
            node.strMeta <font color="black">=</font> x_EOL <font color="black">+</font> node.strMeta;
            nInsertAt <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    x_DocChange<font color="black">(</font> nInsertAt, nReplace, node.strMeta <font color="black">)</font>;
    <font color="blue">return</font> nReplace;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_AddElem<font color="black">(</font> MCD_PCSZ pName, <font color="blue">int</font> nValue, <font color="blue">int</font> nFlags <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Convert integer to string</font>
    MCD_CHAR szVal<font color="black">[</font><font color="maroon">25</font><font color="black">]</font>;
    MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szVal<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"%d"</font><font color="black">)</font>, nValue <font color="black">)</font>;
    <font color="blue">return</font> x_AddElem<font color="black">(</font> pName, szVal, nFlags <font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_AddElem<font color="black">(</font> MCD_PCSZ pName, MCD_PCSZ pValue, <font color="blue">int</font> nFlags <font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_CHILD <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Adding a child element under main position</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> m_iPos <font color="black">)</font>
            <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>

    <font color="green">// Locate where to add element relative to current node</font>
    NodePos node<font color="black">(</font> nFlags <font color="black">)</font>;
    <font color="blue">int</font> iPosParent, iPosBefore;
    <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_CHILD <font color="black">)</font>
    <font color="black">{</font>
        iPosParent <font color="black">=</font> m_iPos;
        iPosBefore <font color="black">=</font> m_iPosChild;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        iPosParent <font color="black">=</font> m_iPosParent;
        iPosBefore <font color="black">=</font> m_iPos;
        node.nStart <font color="black">=</font> m_nNodeOffset;
        node.nLength <font color="black">=</font> m_nNodeLength;
    <font color="black">}</font>

    <font color="green">// Cannot have data in non-ended element</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font>nFlags<font color="black">&</font>MNF_WITHNOEND<font color="black">)</font> <font color="black">&</font><font color="black">&</font> pValue <font color="black">&</font><font color="black">&</font> pValue<font color="black">[</font><font color="maroon">0</font><font color="black">]</font> <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;

    <font color="green">// Allocate ElemPos structure for this element</font>
    <font color="blue">int</font> iPos <font color="black">=</font> x_GetFreePos<font color="black">(</font><font color="black">)</font>;

    <font color="green">// Create string for insert</font>
    <font color="green">// If no pValue is specified, an empty element is created</font>
    <font color="green">// i.e. either &#60;NAME&#62;value&#60;/NAME&#62; or &#60;NAME/&#62;</font>
    <font color="green">//</font>
    ElemPos<font color="black">*</font> pElem <font color="black">=</font> <font color="black">&</font>m_aPos<font color="black">[</font>iPos<font color="black">]</font>;
    <font color="blue">int</font> nLenName <font color="black">=</font> MCD_PSZLEN<font color="black">(</font>pName<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> pValue <font color="black">|</font><font color="black">|</font> <font color="black">!</font> pValue<font color="black">[</font><font color="maroon">0</font><font color="black">]</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// &#60;NAME/&#62; empty element</font>
        node.strMeta <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;"</font><font color="black">)</font>;
        node.strMeta <font color="black">+</font><font color="black">=</font> pName;
        <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_WITHNOEND <font color="black">)</font>
        <font color="black">{</font>
            node.strMeta <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#62;"</font><font color="black">)</font>;
            pElem<font color="black">-</font><font color="black">&#62;</font>SetStartTagLen<font color="black">(</font> nLenName <font color="black">+</font> <font color="maroon">2</font> <font color="black">)</font>;
            pElem<font color="black">-</font><font color="black">&#62;</font>nLength <font color="black">=</font> nLenName <font color="black">+</font> <font color="maroon">2</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_WITHXHTMLSPACE <font color="black">)</font>
            <font color="black">{</font>
                node.strMeta <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">" /&#62;"</font><font color="black">)</font>;
                pElem<font color="black">-</font><font color="black">&#62;</font>SetStartTagLen<font color="black">(</font> nLenName <font color="black">+</font> <font color="maroon">4</font> <font color="black">)</font>;
                pElem<font color="black">-</font><font color="black">&#62;</font>nLength <font color="black">=</font> nLenName <font color="black">+</font> <font color="maroon">4</font>;
            <font color="black">}</font>
            <font color="blue">else</font>
            <font color="black">{</font>
                node.strMeta <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"/&#62;"</font><font color="black">)</font>;
                pElem<font color="black">-</font><font color="black">&#62;</font>SetStartTagLen<font color="black">(</font> nLenName <font color="black">+</font> <font color="maroon">3</font> <font color="black">)</font>;
                pElem<font color="black">-</font><font color="black">&#62;</font>nLength <font color="black">=</font> nLenName <font color="black">+</font> <font color="maroon">3</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        pElem<font color="black">-</font><font color="black">&#62;</font>SetEndTagLen<font color="black">(</font> <font color="maroon">0</font> <font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="green">// &#60;NAME&#62;value&#60;/NAME&#62;</font>
        MCD_STR strValue;
        <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_WITHCDATA <font color="black">)</font>
            strValue <font color="black">=</font> x_EncodeCDATASection<font color="black">(</font> pValue <font color="black">)</font>;
        <font color="blue">else</font>
            strValue <font color="black">=</font> EscapeText<font color="black">(</font> pValue, nFlags <font color="black">)</font>;
        <font color="blue">int</font> nLenValue <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>strValue<font color="black">)</font>;
        node.strMeta <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;"</font><font color="black">)</font>;
        node.strMeta <font color="black">+</font><font color="black">=</font> pName;
        node.strMeta <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#62;"</font><font color="black">)</font>;
        node.strMeta <font color="black">+</font><font color="black">=</font> strValue;
        node.strMeta <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#60;/"</font><font color="black">)</font>;
        node.strMeta <font color="black">+</font><font color="black">=</font> pName;
        node.strMeta <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"&#62;"</font><font color="black">)</font>;
        pElem<font color="black">-</font><font color="black">&#62;</font>SetEndTagLen<font color="black">(</font> nLenName <font color="black">+</font> <font color="maroon">3</font> <font color="black">)</font>;
        pElem<font color="black">-</font><font color="black">&#62;</font>nLength <font color="black">=</font> nLenName <font color="black">*</font> <font color="maroon">2</font> <font color="black">+</font> nLenValue <font color="black">+</font> <font color="maroon">5</font>;
        pElem<font color="black">-</font><font color="black">&#62;</font>SetStartTagLen<font color="black">(</font> nLenName <font color="black">+</font> <font color="maroon">2</font> <font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// Insert</font>
    <font color="blue">int</font> nReplace <font color="black">=</font> x_InsertNew<font color="black">(</font> iPosParent, iPosBefore, node <font color="black">)</font>;

    pElem<font color="black">-</font><font color="black">&#62;</font>nStart <font color="black">=</font> node.nStart;
    pElem<font color="black">-</font><font color="black">&#62;</font>iElemChild <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_WITHNOEND <font color="black">)</font>
        pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">=</font> MNF_NONENDED;
    <font color="blue">else</font>
        pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">=</font> <font color="maroon">0</font>;
    x_LinkElem<font color="black">(</font> iPosParent, iPosBefore, iPos <font color="black">)</font>;

    x_Adjust<font color="black">(</font> iPos, MCD_STRLENGTH<font color="black">(</font>node.strMeta<font color="black">)</font> <font color="black">-</font>nReplace <font color="black">)</font>;

    <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_CHILD <font color="black">)</font>
        x_SetPos<font color="black">(</font> m_iPosParent, iPosParent, iPos <font color="black">)</font>;
    <font color="blue">else</font>
        x_SetPos<font color="black">(</font> iPosParent, iPos, <font color="maroon">0</font> <font color="black">)</font>;
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>

MCD_STR CMarkup<font color="black">:</font><font color="black">:</font>x_GetSubDoc<font color="black">(</font> <font color="blue">int</font> iPos <font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">int</font> nStart <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart;
        <font color="blue">int</font> nNext <font color="black">=</font> nStart <font color="black">+</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nLength;
        MCD_PCSZ pDoc <font color="black">=</font> MCD_2PCSZ<font color="black">(</font>m_strDoc<font color="black">)</font>;
        <font color="blue">int</font> nChar <font color="black">=</font> nNext;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> x_FindAny<font color="black">(</font>pDoc,nChar<font color="black">)</font> <font color="black">|</font><font color="black">|</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#60;'</font> <font color="black">)</font>
            nNext <font color="black">=</font> nChar;
        <font color="blue">return</font> MCD_STRMID<font color="black">(</font> m_strDoc, nStart, nNext <font color="black">-</font>nStart <font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_AddSubDoc<font color="black">(</font> MCD_PCSZ pSubDoc, <font color="blue">int</font> nFlags <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Add subdocument, parse, and modify positions of affected elements</font>
    <font color="green">//</font>
    NodePos node<font color="black">(</font> nFlags <font color="black">)</font>;
    <font color="blue">int</font> iPosParent, iPosBefore;
    <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_CHILD <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Add a subdocument under main position, before or after child</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> m_iPos <font color="black">)</font>
            <font color="blue">return</font> <font color="blue">false</font>;
        iPosParent <font color="black">=</font> m_iPos;
        iPosBefore <font color="black">=</font> m_iPosChild;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="green">// Add a subdocument under parent position, before or after main</font>
        iPosParent <font color="black">=</font> m_iPosParent;
        iPosBefore <font color="black">=</font> m_iPos;
        node.nStart <font color="black">=</font> m_nNodeOffset;
        node.nLength <font color="black">=</font> m_nNodeLength;
    <font color="black">}</font>

    <font color="green">// Parse subdocument</font>
    <font color="blue">bool</font> bWellFormed <font color="black">=</font> <font color="blue">true</font>;
    TokenPos token<font color="black">(</font> pSubDoc, m_nDocFlags <font color="black">)</font>;
    <font color="blue">int</font> iPosVirtual <font color="black">=</font> x_GetFreePos<font color="black">(</font><font color="black">)</font>;
    m_aPos<font color="black">[</font>iPosVirtual<font color="black">]</font>.ClearVirtualParent<font color="black">(</font><font color="black">)</font>;
    m_aPos<font color="black">[</font>iPosVirtual<font color="black">]</font>.SetLevel<font color="black">(</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.Level<font color="black">(</font><font color="black">)</font> <font color="black">+</font> <font color="maroon">1</font> <font color="black">)</font>;
    <font color="blue">int</font> iPos <font color="black">=</font> x_ParseElem<font color="black">(</font> iPosVirtual, token <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">(</font><font color="black">!</font>iPos<font color="black">)</font> <font color="black">|</font><font color="black">|</font> m_aPos<font color="black">[</font>iPosVirtual<font color="black">]</font>.nFlags <font color="black">&</font> MNF_ILLFORMED <font color="black">)</font>
        bWellFormed <font color="black">=</font> <font color="blue">false</font>;
    <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPosVirtual<font color="black">]</font>.nFlags <font color="black">&</font> MNF_ILLDATA <font color="black">)</font>
        m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.nFlags <font color="black">|</font><font color="black">=</font> MNF_ILLDATA;

    <font color="green">// Extract subdocument without leading/trailing nodes</font>
    <font color="blue">int</font> nExtractStart <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> iPosLast <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemPrev;
    <font color="blue">if</font> <font color="black">(</font> bWellFormed <font color="black">)</font>
    <font color="black">{</font>
        nExtractStart <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart;
        <font color="blue">int</font> nExtractLength <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nLength;
        <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">!</font><font color="black">=</font> iPosLast <font color="black">)</font>
        <font color="black">{</font>
            nExtractLength <font color="black">=</font> m_aPos<font color="black">[</font>iPosLast<font color="black">]</font>.nStart <font color="black">-</font>nExtractStart <font color="black">+</font> m_aPos<font color="black">[</font>iPosLast<font color="black">]</font>.nLength;
            bWellFormed <font color="black">=</font> <font color="blue">false</font>; <font color="green">// treat as subdoc here, but return not well-formed</font>
        <font color="black">}</font>
        MCD_STRASSIGN<font color="black">(</font>node.strMeta,<font color="black">&</font>pSubDoc<font color="black">[</font>nExtractStart<font color="black">]</font>,nExtractLength<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        node.strMeta <font color="black">=</font> pSubDoc;
        node.nNodeFlags <font color="black">|</font><font color="black">=</font> MNF_WITHNOLINES;
    <font color="black">}</font>

    <font color="green">// Insert</font>
    <font color="blue">int</font> nReplace <font color="black">=</font> x_InsertNew<font color="black">(</font> iPosParent, iPosBefore, node <font color="black">)</font>;

    <font color="green">// Adjust and link in the inserted elements</font>
    <font color="green">// iPosVirtual will stop it from affecting rest of document</font>
    <font color="blue">int</font> nAdjust <font color="black">=</font> node.nStart <font color="black">-</font>nExtractStart;
    <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">&</font><font color="black">&</font> nAdjust <font color="black">)</font>
    <font color="black">{</font>
        x_Adjust<font color="black">(</font> iPos, nAdjust <font color="black">)</font>;
        m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart <font color="black">+</font><font color="black">=</font> nAdjust;
    <font color="black">}</font>
    <font color="blue">int</font> iPosChild <font color="black">=</font> iPos;
    <font color="blue">while</font> <font color="black">(</font> iPosChild <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">int</font> iPosNext <font color="black">=</font> m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.iElemNext;
        x_LinkElem<font color="black">(</font> iPosParent, iPosBefore, iPosChild <font color="black">)</font>;
        iPosBefore <font color="black">=</font> iPosChild;
        iPosChild <font color="black">=</font> iPosNext;
    <font color="black">}</font>
    x_ReleasePos<font color="black">(</font> iPosVirtual <font color="black">)</font>;

    <font color="green">// Now adjust remainder of document</font>
    x_Adjust<font color="black">(</font> iPosLast, MCD_STRLENGTH<font color="black">(</font>node.strMeta<font color="black">)</font> <font color="black">-</font>nReplace, <font color="blue">true</font> <font color="black">)</font>;

    <font color="green">// Set position to top element of subdocument</font>
    <font color="blue">if</font> <font color="black">(</font> nFlags <font color="black">&</font> MNF_CHILD <font color="black">)</font>
        x_SetPos<font color="black">(</font> m_iPosParent, iPosParent, iPos <font color="black">)</font>;
    <font color="blue">else</font> <font color="green">// Main</font>
        x_SetPos<font color="black">(</font> m_iPosParent, iPos, <font color="maroon">0</font> <font color="black">)</font>;
    <font color="blue">return</font> bWellFormed;
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_RemoveElem<font color="black">(</font> <font color="blue">int</font> iPos <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Remove element and all contained elements</font>
    <font color="green">// Return new position</font>
    <font color="green">//</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> iPos <font color="black">)</font>
        <font color="blue">return</font> <font color="maroon">0</font>;

    <font color="green">// Determine whether any whitespace up to next tag</font>
    <font color="blue">int</font> nAfterEnd <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.StartAfter<font color="black">(</font><font color="black">)</font>;
    MCD_PCSZ pDoc <font color="black">=</font> MCD_2PCSZ<font color="black">(</font>m_strDoc<font color="black">)</font>;
    <font color="blue">int</font> nChar <font color="black">=</font> nAfterEnd;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> x_FindAny<font color="black">(</font>pDoc,nChar<font color="black">)</font> <font color="black">|</font><font color="black">|</font> pDoc<font color="black">[</font>nChar<font color="black">]</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#60;'</font> <font color="black">)</font>
        nAfterEnd <font color="black">=</font> nChar;

    <font color="green">// Remove from document, adjust affected indexes, and unlink</font>
    <font color="blue">int</font> nLen <font color="black">=</font> nAfterEnd <font color="black">-</font>m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart;
    x_DocChange<font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart, nLen, MCD_STR<font color="black">(</font><font color="black">)</font> <font color="black">)</font>;
    x_Adjust<font color="black">(</font> iPos, <font color="black">-</font>nLen, <font color="blue">true</font> <font color="black">)</font>;
    <font color="blue">int</font> iPosPrev <font color="black">=</font> x_UnlinkElem<font color="black">(</font> iPos <font color="black">)</font>;
    x_CheckSavedPos<font color="black">(</font><font color="black">)</font>;
    <font color="blue">return</font> iPosPrev;
<font color="black">}</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font>x_LinkElem<font color="black">(</font> <font color="blue">int</font> iPosParent, <font color="blue">int</font> iPosBefore, <font color="blue">int</font> iPos <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Link in element, and initialize nFlags, and iElem indexes</font>
    ElemPos<font color="black">*</font> pElem <font color="black">=</font> <font color="black">&</font>m_aPos<font color="black">[</font>iPos<font color="black">]</font>;
    pElem<font color="black">-</font><font color="black">&#62;</font>iElemParent <font color="black">=</font> iPosParent;
    <font color="blue">if</font> <font color="black">(</font> iPosBefore <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Link in after iPosBefore</font>
        pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">&</font><font color="black">=</font> ~MNF_FIRST;
        pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext <font color="black">=</font> m_aPos<font color="black">[</font>iPosBefore<font color="black">]</font>.iElemNext;
        <font color="blue">if</font> <font color="black">(</font> pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext <font color="black">)</font>
            m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext<font color="black">]</font>.iElemPrev <font color="black">=</font> iPos;
        <font color="blue">else</font>
            m_aPos<font color="black">[</font>m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild<font color="black">]</font>.iElemPrev <font color="black">=</font> iPos;
        m_aPos<font color="black">[</font>iPosBefore<font color="black">]</font>.iElemNext <font color="black">=</font> iPos;
        pElem<font color="black">-</font><font color="black">&#62;</font>iElemPrev <font color="black">=</font> iPosBefore;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        <font color="green">// Link in as first child</font>
        pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">|</font><font color="black">=</font> MNF_FIRST;
        <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild <font color="black">)</font>
        <font color="black">{</font>
            pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild;
            pElem<font color="black">-</font><font color="black">&#62;</font>iElemPrev <font color="black">=</font> m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext<font color="black">]</font>.iElemPrev;
            m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext<font color="black">]</font>.iElemPrev <font color="black">=</font> iPos;
            m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext<font color="black">]</font>.nFlags ^<font color="black">=</font> MNF_FIRST;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext <font color="black">=</font> <font color="maroon">0</font>;
            pElem<font color="black">-</font><font color="black">&#62;</font>iElemPrev <font color="black">=</font> iPos;
        <font color="black">}</font>
        m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild <font color="black">=</font> iPos;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font> iPosParent <font color="black">)</font>
        pElem<font color="black">-</font><font color="black">&#62;</font>SetLevel<font color="black">(</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.Level<font color="black">(</font><font color="black">)</font> <font color="black">+</font> <font color="maroon">1</font> <font color="black">)</font>;
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_UnlinkElem<font color="black">(</font> <font color="blue">int</font> iPos <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Fix links to remove element and mark as deleted</font>
    <font color="green">// return previous position or zero if none</font>
    ElemPos<font color="black">*</font> pElem <font color="black">=</font> <font color="black">&</font>m_aPos<font color="black">[</font>iPos<font color="black">]</font>;

    <font color="green">// Find previous sibling and bypass removed element</font>
    <font color="blue">int</font> iPosPrev <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">if</font> <font color="black">(</font> pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">&</font> MNF_FIRST <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext <font color="black">)</font> <font color="green">// set next as first child</font>
        <font color="black">{</font>
            m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemParent<font color="black">]</font>.iElemChild <font color="black">=</font> pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext;
            m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext<font color="black">]</font>.iElemPrev <font color="black">=</font> pElem<font color="black">-</font><font color="black">&#62;</font>iElemPrev;
            m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext<font color="black">]</font>.nFlags <font color="black">|</font><font color="black">=</font> MNF_FIRST;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="green">// no children remaining</font>
            m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemParent<font color="black">]</font>.iElemChild <font color="black">=</font> <font color="maroon">0</font>;
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
        iPosPrev <font color="black">=</font> pElem<font color="black">-</font><font color="black">&#62;</font>iElemPrev;
        m_aPos<font color="black">[</font>iPosPrev<font color="black">]</font>.iElemNext <font color="black">=</font> pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext;
        <font color="blue">if</font> <font color="black">(</font> pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext <font color="black">)</font>
            m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemNext<font color="black">]</font>.iElemPrev <font color="black">=</font> iPosPrev;
        <font color="blue">else</font>
            m_aPos<font color="black">[</font>m_aPos<font color="black">[</font>pElem<font color="black">-</font><font color="black">&#62;</font>iElemParent<font color="black">]</font>.iElemChild<font color="black">]</font>.iElemPrev <font color="black">=</font> iPosPrev;
    <font color="black">}</font>
    x_ReleaseSubDoc<font color="black">(</font> iPos <font color="black">)</font>;
    <font color="blue">return</font> iPosPrev;
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_ReleasePos<font color="black">(</font> <font color="blue">int</font> iPos <font color="black">)</font>
<font color="black">{</font>
    <font color="blue">int</font> iPosNext <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext;
    m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemNext <font color="black">=</font> m_iPosDeleted;
    m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nFlags <font color="black">=</font> MNF_DELETED;
    m_iPosDeleted <font color="black">=</font> iPos;
    <font color="blue">return</font> iPosNext;
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_ReleaseSubDoc<font color="black">(</font> <font color="blue">int</font> iPos <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Mark position structures as deleted by depth first traversal</font>
    <font color="green">// Tricky because iElemNext used in traversal is overwritten for linked list of deleted</font>
    <font color="green">// Return value is what iElemNext was before being overwritten</font>
    <font color="green">//</font>
    <font color="blue">int</font> iPosNext <font color="black">=</font> <font color="maroon">0</font>, iPosTop <font color="black">=</font> iPos;
    <font color="blue">while</font> <font color="black">(</font> <font color="maroon">1</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemChild <font color="black">)</font>
            iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemChild;
        <font color="blue">else</font>
        <font color="black">{</font>
            <font color="blue">while</font> <font color="black">(</font> <font color="maroon">1</font> <font color="black">)</font>
            <font color="black">{</font>
                iPosNext <font color="black">=</font> x_ReleasePos<font color="black">(</font> iPos <font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> iPosNext <font color="black">|</font><font color="black">|</font> iPos <font color="black">=</font><font color="black">=</font> iPosTop <font color="black">)</font>
                    <font color="blue">break</font>;
                iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.iElemParent;
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">=</font><font color="black">=</font> iPosTop <font color="black">)</font>
                <font color="blue">break</font>;
            iPos <font color="black">=</font> iPosNext;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> iPosNext;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_GetMap<font color="black">(</font> SavedPosMap<font color="black">*</font><font color="black">&</font> pMap, <font color="blue">int</font> nMap, <font color="blue">int</font> nMapSize <font color="green">/*=7*/</font> <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Find or create map, returns true if map(s) created</font>
    SavedPosMap<font color="black">*</font><font color="black">*</font> ppMaps <font color="black">=</font> m_SavedPosMapArray.pMaps;
    <font color="blue">int</font> nMapIndex <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">if</font> <font color="black">(</font> ppMaps <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Length of array is unknown, so loop through maps</font>
        <font color="blue">while</font> <font color="black">(</font> nMapIndex <font color="black">&#60;</font><font color="black">=</font> nMap <font color="black">)</font>
        <font color="black">{</font>
            pMap <font color="black">=</font> ppMaps<font color="black">[</font>nMapIndex<font color="black">]</font>;
            <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> pMap <font color="black">)</font>
                <font color="blue">break</font>;
            <font color="blue">if</font> <font color="black">(</font> nMapIndex <font color="black">=</font><font color="black">=</font> nMap <font color="black">)</font>
                <font color="blue">return</font> <font color="blue">false</font>; <font color="green">// not created</font>
            <font color="black">+</font><font color="black">+</font>nMapIndex;
        <font color="black">}</font>
        nMapIndex <font color="black">=</font> <font color="maroon">0</font>;
    <font color="black">}</font>

    <font color="green">// Create map(s)</font>
    <font color="green">// If you access map 1 before map 0 created, then 2 maps will be created</font>
    m_SavedPosMapArray.pMaps <font color="black">=</font> <font color="blue">new</font> SavedPosMap<font color="black">*</font><font color="black">[</font>nMap<font color="black">+</font><font color="maroon">2</font><font color="black">]</font>;
    <font color="blue">if</font> <font color="black">(</font> ppMaps <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">while</font> <font color="black">(</font> ppMaps<font color="black">[</font>nMapIndex<font color="black">]</font> <font color="black">)</font>
        <font color="black">{</font>
            m_SavedPosMapArray.pMaps<font color="black">[</font>nMapIndex<font color="black">]</font> <font color="black">=</font> ppMaps<font color="black">[</font>nMapIndex<font color="black">]</font>;
            <font color="black">+</font><font color="black">+</font>nMapIndex;
        <font color="black">}</font>
        <font color="blue">delete</font><font color="black">[</font><font color="black">]</font> ppMaps;
    <font color="black">}</font>
    ppMaps <font color="black">=</font> m_SavedPosMapArray.pMaps;
    <font color="blue">while</font> <font color="black">(</font> nMapIndex <font color="black">&#60;</font><font color="black">=</font> nMap <font color="black">)</font>
    <font color="black">{</font>
        ppMaps<font color="black">[</font>nMapIndex<font color="black">]</font> <font color="black">=</font> <font color="blue">new</font> SavedPosMap<font color="black">(</font> nMapSize <font color="black">)</font>;
        <font color="black">+</font><font color="black">+</font>nMapIndex;
    <font color="black">}</font>
    ppMaps<font color="black">[</font>nMapIndex<font color="black">]</font> <font color="black">=</font> NULL;
    pMap <font color="black">=</font> ppMaps<font color="black">[</font>nMap<font color="black">]</font>;
    <font color="blue">return</font> <font color="blue">true</font>; <font color="green">// map(s) created</font>
<font color="black">}</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font>x_CheckSavedPos<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Remove any saved positions now pointing to deleted elements</font>
    <font color="green">// Must be done as part of element removal before position reassigned</font>
    <font color="blue">if</font> <font color="black">(</font> m_SavedPosMapArray.pMaps <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">int</font> nMap <font color="black">=</font> <font color="maroon">0</font>;
        <font color="blue">while</font> <font color="black">(</font> m_SavedPosMapArray.pMaps<font color="black">[</font>nMap<font color="black">]</font> <font color="black">)</font>
        <font color="black">{</font>
            SavedPosMap<font color="black">*</font> pMap <font color="black">=</font> m_SavedPosMapArray.pMaps<font color="black">[</font>nMap<font color="black">]</font>;
            <font color="blue">for</font> <font color="black">(</font> <font color="blue">int</font> nSlot <font color="black">=</font> <font color="maroon">0</font>; nSlot <font color="black">&#60;</font> pMap<font color="black">-</font><font color="black">&#62;</font>nMapSize; <font color="black">+</font><font color="black">+</font>nSlot <font color="black">)</font>
            <font color="black">{</font>
                SavedPos<font color="black">*</font> pSavedPos <font color="black">=</font> pMap<font color="black">-</font><font color="black">&#62;</font>pTable<font color="black">[</font>nSlot<font color="black">]</font>;
                <font color="blue">if</font> <font color="black">(</font> pSavedPos <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">int</font> nOffset <font color="black">=</font> <font color="maroon">0</font>;
                    <font color="blue">int</font> nSavedPosCount <font color="black">=</font> <font color="maroon">0</font>;
                    <font color="blue">while</font> <font color="black">(</font> <font color="maroon">1</font> <font color="black">)</font>
                    <font color="black">{</font>
                        <font color="blue">if</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_USED <font color="black">)</font>
                        <font color="black">{</font>
                            <font color="blue">int</font> iPos <font color="black">=</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.iPos;
                            <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nFlags <font color="black">&</font> MNF_DELETED<font color="black">)</font> <font color="black">)</font>
                            <font color="black">{</font>
                                <font color="blue">if</font> <font color="black">(</font> nSavedPosCount <font color="black">&#60;</font> nOffset <font color="black">)</font>
                                <font color="black">{</font>
                                    pSavedPos<font color="black">[</font>nSavedPosCount<font color="black">]</font> <font color="black">=</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>;
                                    pSavedPos<font color="black">[</font>nSavedPosCount<font color="black">]</font>.nSavedPosFlags <font color="black">&</font><font color="black">=</font> ~SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST;
                                <font color="black">}</font>
                                <font color="black">+</font><font color="black">+</font>nSavedPosCount;
                            <font color="black">}</font>
                        <font color="black">}</font>
                        <font color="blue">if</font> <font color="black">(</font> pSavedPos<font color="black">[</font>nOffset<font color="black">]</font>.nSavedPosFlags <font color="black">&</font> SavedPos<font color="black">:</font><font color="black">:</font>SPM_LAST <font color="black">)</font>
                        <font color="black">{</font>
                            <font color="blue">while</font> <font color="black">(</font> nSavedPosCount <font color="black">&#60;</font><font color="black">=</font> nOffset <font color="black">)</font>
                                pSavedPos<font color="black">[</font>nSavedPosCount<font color="black">+</font><font color="black">+</font><font color="black">]</font>.nSavedPosFlags <font color="black">&</font><font color="black">=</font> ~SavedPos<font color="black">:</font><font color="black">:</font>SPM_USED;
                            <font color="blue">break</font>;
                        <font color="black">}</font>
                        <font color="black">+</font><font color="black">+</font>nOffset;
                    <font color="black">}</font>
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="black">+</font><font color="black">+</font>nMap;
        <font color="black">}</font>
    <font color="black">}</font>
<font color="black">}</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font>x_AdjustForNode<font color="black">(</font> <font color="blue">int</font> iPosParent, <font color="blue">int</font> iPos, <font color="blue">int</font> nShift <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Adjust affected indexes</font>
    <font color="blue">bool</font> bAfterPos <font color="black">=</font> <font color="blue">true</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> iPos <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Change happened before or at first element under iPosParent</font>
        <font color="green">// If there are any children of iPosParent, adjust from there</font>
        <font color="green">// otherwise start at parent and adjust from there</font>
        iPos <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild;
        <font color="blue">if</font> <font color="black">(</font> iPos <font color="black">)</font>
        <font color="black">{</font>
            m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart <font color="black">+</font><font color="black">=</font> nShift;
            bAfterPos <font color="black">=</font> <font color="blue">false</font>;
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            iPos <font color="black">=</font> iPosParent;
            m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nLength <font color="black">+</font><font color="black">=</font> nShift;
        <font color="black">}</font>
    <font color="black">}</font>
    x_Adjust<font color="black">(</font> iPos, nShift, bAfterPos <font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_AddNode<font color="black">(</font> <font color="blue">int</font> nNodeType, MCD_PCSZ pText, <font color="blue">int</font> nNodeFlags <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Only comments, DTDs, and processing instructions are followed by CRLF</font>
    <font color="green">// Other nodes are usually concerned with mixed content, so no CRLF</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> <font color="black">(</font>nNodeType <font color="black">&</font> <font color="black">(</font>MNT_PROCESSING_INSTRUCTION<font color="black">|</font>MNT_COMMENT<font color="black">|</font>MNT_DOCUMENT_TYPE<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
        nNodeFlags <font color="black">|</font><font color="black">=</font> MNF_WITHNOLINES;

    <font color="green">// Add node of nNodeType after current node position</font>
    NodePos node<font color="black">(</font> nNodeFlags <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> x_CreateNode<font color="black">(</font>node.strMeta, nNodeType, pText<font color="black">)</font> <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;

    <font color="green">// Locate where to add node relative to current node</font>
    <font color="blue">int</font> iPosBefore <font color="black">=</font> m_iPos;
    <font color="blue">int</font> iPosParent <font color="black">=</font> m_iPosParent;
    node.nStart <font color="black">=</font> m_nNodeOffset;
    node.nLength <font color="black">=</font> m_nNodeLength;
    node.nNodeType <font color="black">=</font> nNodeType;

    <font color="blue">int</font> nReplace <font color="black">=</font> x_InsertNew<font color="black">(</font> iPosParent, iPosBefore, node <font color="black">)</font>;

    <font color="green">// If its a new element, create an ElemPos</font>
    <font color="blue">int</font> iPos <font color="black">=</font> iPosBefore;
    <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Set indexes</font>
        iPos <font color="black">=</font> x_GetFreePos<font color="black">(</font><font color="black">)</font>;
        ElemPos<font color="black">*</font> pElem <font color="black">=</font> <font color="black">&</font>m_aPos<font color="black">[</font>iPos<font color="black">]</font>;
        pElem<font color="black">-</font><font color="black">&#62;</font>nStart <font color="black">=</font> node.nStart;
        pElem<font color="black">-</font><font color="black">&#62;</font>SetStartTagLen<font color="black">(</font> node.nLength <font color="black">)</font>;
        pElem<font color="black">-</font><font color="black">&#62;</font>SetEndTagLen<font color="black">(</font> <font color="maroon">0</font> <font color="black">)</font>;
        pElem<font color="black">-</font><font color="black">&#62;</font>nLength <font color="black">=</font> node.nLength;
        node.nStart <font color="black">=</font> <font color="maroon">0</font>;
        node.nLength <font color="black">=</font> <font color="maroon">0</font>;
        pElem<font color="black">-</font><font color="black">&#62;</font>iElemChild <font color="black">=</font> <font color="maroon">0</font>;
        pElem<font color="black">-</font><font color="black">&#62;</font>nFlags <font color="black">=</font> <font color="maroon">0</font>;
        x_LinkElem<font color="black">(</font> iPosParent, iPosBefore, iPos <font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// Need to adjust element positions after iPos</font>
    x_AdjustForNode<font color="black">(</font> iPosParent, iPos, MCD_STRLENGTH<font color="black">(</font>node.strMeta<font color="black">)</font> <font color="black">-</font>nReplace <font color="black">)</font>;

    <font color="green">// Set current position</font>
    m_iPos <font color="black">=</font> iPos;
    m_iPosChild <font color="black">=</font> <font color="maroon">0</font>;
    m_nNodeOffset <font color="black">=</font> node.nStart;
    m_nNodeLength <font color="black">=</font> node.nLength;
    m_nNodeType <font color="black">=</font> nNodeType;
    MARKUP_SETDEBUGSTATE;
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font>x_RemoveNode<font color="black">(</font> <font color="blue">int</font> iPosParent, <font color="blue">int</font><font color="black">&</font> iPos, <font color="blue">int</font><font color="black">&</font> nNodeType, <font color="blue">int</font><font color="black">&</font> nNodeOffset, <font color="blue">int</font><font color="black">&</font> nNodeLength <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Remove node and return new position</font>
    <font color="green">//</font>
    <font color="blue">int</font> iPosPrev <font color="black">=</font> iPos;

    <font color="green">// Removing an element?</font>
    <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
    <font color="black">{</font>
        nNodeOffset <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nStart;
        nNodeLength <font color="black">=</font> m_aPos<font color="black">[</font>iPos<font color="black">]</font>.nLength;
        iPosPrev <font color="black">=</font> x_UnlinkElem<font color="black">(</font> iPos <font color="black">)</font>;
        x_CheckSavedPos<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>

    <font color="green">// Find previous node type, offset and length</font>
    <font color="blue">int</font> nPrevOffset <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">if</font> <font color="black">(</font> iPosPrev <font color="black">)</font>
        nPrevOffset <font color="black">=</font> m_aPos<font color="black">[</font>iPosPrev<font color="black">]</font>.StartAfter<font color="black">(</font><font color="black">)</font>;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> iPosParent <font color="black">)</font>
        nPrevOffset <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>;
    TokenPos token<font color="black">(</font> m_strDoc, m_nDocFlags <font color="black">)</font>;
    NodePos node;
    token.nNext <font color="black">=</font> nPrevOffset;
    <font color="blue">int</font> nPrevType <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">while</font> <font color="black">(</font> token.nNext <font color="black">&#60;</font> nNodeOffset <font color="black">)</font>
    <font color="black">{</font>
        nPrevOffset <font color="black">=</font> token.nNext;
        nPrevType <font color="black">=</font> x_ParseNode<font color="black">(</font> token, node <font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">int</font> nPrevLength <font color="black">=</font> nNodeOffset <font color="black">-</font>nPrevOffset;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> nPrevLength <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Previous node is iPosPrev element</font>
        nPrevOffset <font color="black">=</font> <font color="maroon">0</font>;
        <font color="blue">if</font> <font color="black">(</font> iPosPrev <font color="black">)</font>
            nPrevType <font color="black">=</font> MNT_ELEMENT;
    <font color="black">}</font>

    <font color="green">// Remove node from document</font>
    x_DocChange<font color="black">(</font> nNodeOffset, nNodeLength, MCD_STR<font color="black">(</font><font color="black">)</font> <font color="black">)</font>;
    x_AdjustForNode<font color="black">(</font> iPosParent, iPosPrev, <font color="black">-</font>nNodeLength <font color="black">)</font>;

    <font color="green">// Was removed node a lone end tag?</font>
    <font color="blue">if</font> <font color="black">(</font> nNodeType <font color="black">=</font><font color="black">=</font> MNT_LONE_END_TAG <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// See if we can unset parent MNF_ILLDATA flag</font>
        token.nNext <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.StartContent<font color="black">(</font><font color="black">)</font>;
        <font color="blue">int</font> nEndOfContent <font color="black">=</font> token.nNext <font color="black">+</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.ContentLen<font color="black">(</font><font color="black">)</font>;
        <font color="blue">int</font> iPosChild <font color="black">=</font> m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.iElemChild;
        <font color="blue">while</font> <font color="black">(</font> token.nNext <font color="black">&#60;</font> nEndOfContent <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> x_ParseNode<font color="black">(</font>token,node<font color="black">)</font> <font color="black">&#60;</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
                <font color="blue">break</font>;
            <font color="blue">if</font> <font color="black">(</font> node.nNodeType <font color="black">=</font><font color="black">=</font> MNT_ELEMENT <font color="black">)</font>
            <font color="black">{</font>
                token.nNext <font color="black">=</font> m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.StartAfter<font color="black">(</font><font color="black">)</font>;
                iPosChild <font color="black">=</font> m_aPos<font color="black">[</font>iPosChild<font color="black">]</font>.iElemNext;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font> token.nNext <font color="black">=</font><font color="black">=</font> nEndOfContent <font color="black">)</font>
            m_aPos<font color="black">[</font>iPosParent<font color="black">]</font>.nFlags <font color="black">&</font><font color="black">=</font> ~MNF_ILLDATA;
    <font color="black">}</font>

    nNodeType <font color="black">=</font> nPrevType;
    nNodeOffset <font color="black">=</font> nPrevOffset;
    nNodeLength <font color="black">=</font> nPrevLength;
    iPos <font color="black">=</font> iPosPrev;
<font color="black">}</font>

<font color="green">// Encoding names</font>
<font color="green">// This is a precompiled ASCII hash table for speed and minimum memory requirement</font>
<font color="green">// Each entry consists of a 2 digit name length, 5 digit code page, and the encoding name</font>
<font color="green">// Each table slot can have multiple entries, table size 150 was chosen for even distribution</font>
<font color="green">//</font>
MCD_PCSZ EncodingNameTable<font color="black">[</font><font color="maroon">150</font><font color="black">]</font> <font color="black">=</font>
<font color="black">{</font>
    MCD_T<font color="black">(</font><font color="maroon">"2701148x-ebcdic-international-euro1028599iso_8859-9"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0828596ecma-1141420284x-ebcdic-spain"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0751949cseuckr1420127ansi_x3.4-19681420127ansi_x3.4-1986"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1410001x-mac-japanese"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0500936cn-gb0828597ecma-118"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0600932x-sjis"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0228591l1"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0228592l20300936gbk0300437437"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1420280x-ebcdic-italy0228593l3"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0628596arabic0228594l42701142x-ebcdic-denmarknorway-euro"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0228595l5"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0700950cn-big50900932shift-jis"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0800936csgb23120228605l9"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0920127iso646-us"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0600850ibm850"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0800949ksc_56010600437ibm437"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0600852ibm8520600861ibm861"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0620127ibm367"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1420002x-chinese-eten0320866koi0600737ibm737"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1410007x-mac-cyrillic1601146x-ebcdic-uk-euro1320107x-ia5-swedish0628591ibm819"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0600775ibm775"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0600866ibm8662750937x-ebcdic-traditionalchinese0600857ibm8571020127iso-ir-6us"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1710002x-mac-chinesetrad"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0600869ibm869"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0500437cspc8"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0551932x-euc1250221_iso-2022-jp1000932csshiftjis"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"2000875x-ebcdic-greekmodern3350939x-ebcdic-japaneseandjapaneselatin0601200utf-16"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1320838x-ebcdic-thai"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1028591iso-ir-100"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0800708asmo-7081028594iso-ir-1101028592iso-ir-101"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0628598hebrew"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1057003x-iscii-be"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1901145x-ebcdic-spain-euro1620127iso_646.irv:1991"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1057002x-iscii-de0600949korean"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1628596csisolatinarabic1710008x-mac-chinesesimp"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028595iso-ir-1440520866koi8r1028597iso-ir-1261057008x-iscii-ka"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028596iso-ir-1272420880x-ebcdic-cyrillicrussian1028593iso-ir-109"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1000936gb_2312-801057009x-iscii-ma1128605iso_8859-15"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028598iso-ir-138"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1901144x-ebcdic-italy-euro1028599iso-ir-1480928591iso8859-1"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0928592iso8859-21057011x-iscii-pa1000949iso-ir-1490820127us-ascii"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1220106x-ia5-german"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"2320833x-ebcdic-koreanextended1057006x-iscii-as"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1057004x-iscii-ta"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1000932x-ms-cp932"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0800936gb2312800721866koi8-ru"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1057005x-iscii-te1300949csksc56011987"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0400950big52650935x-ebcdic-simplifiedchinese1057010x-iscii-gu"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0500775cp5000628598visual3321025x-ebcdic-cyrillicserbianbulgarian"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1150221csiso2022jp1765000unicode-1-1-utf-7"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1765001unicode-1-1-utf-81765001unicode-2-0-utf-8"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"4551932extended_unix_code_packed_format_for_japanese0900932shift_jis"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1057007x-iscii-or1150225csiso2022kr"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1951932cseucpkdfmtjapanese0501361johab0910000macintosh"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0829001x-europa1620273x-ebcdic-germany"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1628598csisolatinhebrew"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1320000x-chinese-cns0500437cp437"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0500852cp8520500870cp870"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0520127ascii0520127cp367"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1500420x-ebcdic-arabic"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0528591cp819"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0700720dos-720"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1210004x-mac-arabic0500866cp8660700949ksc5601"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0528597greek1965000x-unicode-2-0-utf-7"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1400949ks_c_5601-19871965001x-unicode-2-0-utf-8"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0420866koi82520290x-ebcdic-japanesekatakana1400949ks_c_5601-1989"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1128592csisolatin20700862dos-862"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1100437codepage4370201252us"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1128594csisolatin40700874tis-620"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1128595csisolatin50700874dos-874"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1501143x-ebcdic-france1200037ebcdic-cp-us1520108x-ia5-norwegian"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1820873x-ebcdic-icelandic"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1150220iso-2022-jp1100874windows-874"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0620866koi8-r"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0800950x-x-big51510079x-mac-icelandic"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"2220278x-ebcdic-finlandsweden2850933x-ebcdic-japaneseanduscanada1620905x-ebcdic-turkish1150225iso-2022-kr"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0621866koi8-u"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1028591iso-8859-1"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028592iso-8859-21310081x-mac-turkish"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0828597elot_9280800932ms_kanji1028593iso-8859-30801252iso-ir-6"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028594iso-8859-40528593csiso1565000csunicode11utf7"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028595iso-8859-5"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1028596iso-8859-6"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028597iso-8859-73250933x-ebcdic-koreanandkoreanextended"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1238598iso-8859-8-i1028598iso-8859-81520424x-ebcdic-hebrew1650222_iso-2022-jp$sio"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0900936gb2312-801028599iso-8859-91101201unicodefffe"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0600936gb2312"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1210005x-mac-hebrew"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"2101143x-ebcdic-germany-euro1210003x-mac-korean"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0720866cskoi8r1528597csisolatingreek"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1500936csiso58gb2312800828595cyrillic"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0601026cp1026"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0810029x-mac-ce0900949ks_c_5601"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0601256cp12561052936hz-gb-23121528591iso_8859-1:1987"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1528592iso_8859-2:1987"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1000936csgb2312802450930x-ebcdic-japaneseandkana"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1528593iso_8859-3:19880520105x-ia5"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1528594iso_8859-4:19880651936euc-cn"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1528596iso_8859-6:19871528595iso_8859-5:19882220277x-ebcdic-denmarknorway"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0600950csbig51528597iso_8859-7:19872001147x-ebcdic-france-euro"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1201250windows-12502301149x-ebcdic-icelandic-euro"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1201251windows-12511528598iso_8859-8:1988"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0801250x-cp12501201252windows-1252"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0801251x-cp12511201253windows-12531400949ks_c_5601_19871528599iso_8859-9:1989"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"2701143x-ebcdic-finlandsweden-euro1201254windows-1254"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1201255windows-1255"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1201256windows-12560651932euc-jp"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1201257windows-12570738598logical"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0628597greek81201258windows-1258"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"0600949euc-kr"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0700936chinese0565000utf-70720127csascii0628591latin1"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0628592latin20851936x-euc-cn1120285x-ebcdic-uk0565001utf-8"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0628593latin3"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0628594latin41420423x-ebcdic-greek1901140x-ebcdic-cp-us-euro"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0628599latin5"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1828595csisolatincyrillic"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1110006x-mac-greek1100874iso-8859-11"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028591iso_8859-10601252x-ansi"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028592iso_8859-20628605latin90701200unicode"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028593iso_8859-3"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028594iso_8859-40851932x-euc-jp1128605iso-8859-15"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028595iso_8859-5"</font><font color="black">)</font>,MCD_T<font color="black">(</font><font color="maroon">"1028596iso_8859-6"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"1028597iso_8859-7"</font><font color="black">)</font>,
    MCD_T<font color="black">(</font><font color="maroon">"0900936iso-ir-581028598iso_8859-81201255iso_8859-8-i1200932cswindows31j"</font><font color="black">)</font>
<font color="black">}</font>;

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_GetEncodingCodePage<font color="black">(</font> MCD_CSTR pszEncoding <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// redo for completeness, the iconv set, UTF-32, and uppercase</font>

    <font color="green">// Lookup strEncoding in EncodingNameTable and return Windows code page</font>
    <font color="blue">int</font> nCodePage <font color="black">=</font> <font color="maroon">-1</font>;
    <font color="blue">int</font> nEncLen <font color="black">=</font> MCD_PSZLEN<font color="black">(</font> pszEncoding <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> nEncLen <font color="black">)</font>
        nCodePage <font color="black">=</font> MCD_ACP;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> MCD_PSZNCMP<font color="black">(</font>pszEncoding,MCD_T<font color="black">(</font><font color="maroon">"UTF-32"</font><font color="black">)</font>,<font color="maroon">6</font><font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
        nCodePage <font color="black">=</font> MCD_UTF32;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nEncLen <font color="black">&#60;</font> <font color="maroon">100</font> <font color="black">)</font>
    <font color="black">{</font>
        MCD_CHAR szEncodingLower<font color="black">[</font><font color="maroon">100</font><font color="black">]</font>;
        <font color="blue">for</font> <font color="black">(</font> <font color="blue">int</font> nEncChar<font color="black">=</font><font color="maroon">0</font>; nEncChar<font color="black">&#60;</font>nEncLen; <font color="black">+</font><font color="black">+</font>nEncChar <font color="black">)</font>
        <font color="black">{</font>
            MCD_CHAR cEncChar <font color="black">=</font> pszEncoding<font color="black">[</font>nEncChar<font color="black">]</font>;
            szEncodingLower<font color="black">[</font>nEncChar<font color="black">]</font> <font color="black">=</font> <font color="black">(</font>cEncChar<font color="black">&#62;</font><font color="black">=</font><font color="maroon">'A'</font> <font color="black">&</font><font color="black">&</font> cEncChar<font color="black">&#60;</font><font color="black">=</font><font color="maroon">'Z'</font><font color="black">)</font>? <font color="black">(</font>MCD_CHAR<font color="black">)</font><font color="black">(</font>cEncChar<font color="black">+</font><font color="black">(</font><font color="maroon">'a'</font><font color="black">-</font><font color="maroon">'A'</font><font color="black">)</font><font color="black">)</font> <font color="black">:</font> cEncChar;
        <font color="black">}</font>
        szEncodingLower<font color="black">[</font>nEncLen<font color="black">]</font> <font color="black">=</font> <font color="maroon">'\0'</font>;
        MCD_PCSZ pEntry <font color="black">=</font> EncodingNameTable<font color="black">[</font>x_Hash<font color="black">(</font>szEncodingLower,<font color="blue">sizeof</font><font color="black">(</font>EncodingNameTable<font color="black">)</font><font color="black">/</font><font color="blue">sizeof</font><font color="black">(</font>MCD_PCSZ<font color="black">)</font><font color="black">)</font><font color="black">]</font>;
        <font color="blue">while</font> <font color="black">(</font> <font color="black">*</font>pEntry <font color="black">)</font>
        <font color="black">{</font>
            <font color="green">// e.g. entry: 0565001utf-8 means length 05, code page 65001, encoding name utf-8</font>
            <font color="blue">int</font> nEntryLen <font color="black">=</font> <font color="black">(</font><font color="black">*</font>pEntry <font color="black">-</font><font color="maroon">'0'</font><font color="black">)</font> <font color="black">*</font> <font color="maroon">10</font>;
            <font color="black">+</font><font color="black">+</font>pEntry;
            nEntryLen <font color="black">+</font><font color="black">=</font> <font color="black">(</font><font color="black">*</font>pEntry <font color="black">-</font><font color="maroon">'0'</font><font color="black">)</font>;
            <font color="black">+</font><font color="black">+</font>pEntry;
            MCD_PCSZ pCodePage <font color="black">=</font> pEntry;
            pEntry <font color="black">+</font><font color="black">=</font> <font color="maroon">5</font>;
            <font color="blue">if</font> <font color="black">(</font> nEntryLen <font color="black">=</font><font color="black">=</font> nEncLen <font color="black">&</font><font color="black">&</font> MCD_PSZNCMP<font color="black">(</font>szEncodingLower,pEntry,nEntryLen<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// Convert digits to integer up to code name which always starts with alpha </font>
                nCodePage <font color="black">=</font> MCD_PSZTOL<font color="black">(</font> pCodePage, NULL, <font color="maroon">10</font> <font color="black">)</font>;
                <font color="blue">break</font>;
            <font color="black">}</font>
            pEntry <font color="black">+</font><font color="black">=</font> nEntryLen;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> nCodePage;
<font color="black">}</font>

<font color="blue">#if</font> <font color="black">!</font> defined<font color="black">(</font>MARKUP_WCHAR<font color="black">)</font>
<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_CanConvert<font color="black">(</font> MCD_CSTR pszToEncoding, MCD_CSTR pszFromEncoding <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Return true if MB to MB conversion is possible</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_ICONV<font color="black">)</font>
    <font color="green">// iconv_open should fail if either encoding not supported or one is alias for other</font>
    <font color="blue">char</font> szTo<font color="black">[</font><font color="maroon">100</font><font color="black">]</font>, szFrom<font color="black">[</font><font color="maroon">100</font><font color="black">]</font>;
    iconv_t cd <font color="black">=</font> iconv_open<font color="black">(</font> x_IConvName<font color="black">(</font>szTo,pszToEncoding<font color="black">)</font>, x_IConvName<font color="black">(</font>szFrom,pszFromEncoding<font color="black">)</font> <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> cd <font color="black">=</font><font color="black">=</font> <font color="black">(</font>iconv_t<font color="black">)</font><font color="maroon">-1</font> <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;
    iconv_close<font color="black">(</font>cd<font color="black">)</font>;
<font color="blue">#else</font>
    <font color="blue">int</font> nToCP <font color="black">=</font> x_GetEncodingCodePage<font color="black">(</font> pszToEncoding <font color="black">)</font>;
    <font color="blue">int</font> nFromCP <font color="black">=</font> x_GetEncodingCodePage<font color="black">(</font> pszFromEncoding <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">|</font><font color="black">|</font> nFromCP <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WINCONV<font color="black">)</font>
    <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_ACP <font color="black">|</font><font color="black">|</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_ACP <font color="black">)</font> <font color="green">// either ACP ANSI?</font>
    <font color="black">{</font>
        <font color="blue">int</font> nACP <font color="black">=</font> GetACP<font color="black">(</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_ACP <font color="black">)</font>
            nToCP <font color="black">=</font> nACP;
        <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_ACP <font color="black">)</font>
            nFromCP <font color="black">=</font> nACP;
    <font color="black">}</font>
<font color="blue">#else</font> <font color="green">// no conversion API, but we can do AToUTF8 and UTF8ToA</font>
    <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">!</font><font color="black">=</font> MCD_UTF8 <font color="black">&</font><font color="black">&</font> nFromCP <font color="black">!</font><font color="black">=</font> MCD_UTF8 <font color="black">)</font> <font color="green">// either UTF-8?</font>
        <font color="blue">return</font> <font color="blue">false</font>;
<font color="blue">#endif</font> <font color="green">// no conversion API</font>
    <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> nFromCP <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;
<font color="blue">#endif</font> <font color="green">// not ICONV</font>
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// not WCHAR</font>

<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_ICONV<font color="black">)</font>
<font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> CMarkup<font color="black">:</font><font color="black">:</font>x_IConvName<font color="black">(</font> <font color="blue">char</font><font color="black">*</font> szEncoding, MCD_CSTR pszEncoding <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Make upper case char-based name from strEncoding which consists only of characters in the ASCII range</font>
    <font color="blue">int</font> nEncChar <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">while</font> <font color="black">(</font> pszEncoding<font color="black">[</font>nEncChar<font color="black">]</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">char</font> cEncChar <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">)</font>pszEncoding<font color="black">[</font>nEncChar<font color="black">]</font>;
        szEncoding<font color="black">[</font>nEncChar<font color="black">]</font> <font color="black">=</font> <font color="black">(</font>cEncChar<font color="black">&#62;</font><font color="black">=</font><font color="maroon">'a'</font> <font color="black">&</font><font color="black">&</font> cEncChar<font color="black">&#60;</font><font color="black">=</font><font color="maroon">'z'</font><font color="black">)</font>? <font color="black">(</font>cEncChar<font color="black">-</font><font color="black">(</font><font color="maroon">'a'</font><font color="black">-</font><font color="maroon">'A'</font><font color="black">)</font><font color="black">)</font> <font color="black">:</font> cEncChar;
        <font color="black">+</font><font color="black">+</font>nEncChar;
    <font color="black">}</font>
    szEncoding<font color="black">[</font>nEncChar<font color="black">]</font> <font color="black">=</font> <font color="maroon">'\0'</font>;
    <font color="blue">return</font> szEncoding;
<font color="black">}</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_IConv<font color="black">(</font> ConvertEncoding<font color="black">&</font> convert, <font color="blue">void</font><font color="black">*</font> pTo, <font color="blue">int</font> nToCharSize, <font color="blue">int</font> nFromCharSize <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// Converts from any MB/UTF-8 to MB/UTF-8</font>
    <font color="blue">char</font> szTo<font color="black">[</font><font color="maroon">100</font><font color="black">]</font>, szFrom<font color="black">[</font><font color="maroon">100</font><font color="black">]</font>;
    iconv_t cd <font color="black">=</font> iconv_open<font color="black">(</font> x_IConvName<font color="black">(</font>szTo,convert.strToEncoding<font color="black">)</font>, x_IConvName<font color="black">(</font>szFrom,convert.strFromEncoding<font color="black">)</font> <font color="black">)</font>;
    <font color="blue">int</font> nToLenBytes <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">if</font> <font color="black">(</font> cd <font color="black">!</font><font color="black">=</font> <font color="black">(</font>iconv_t<font color="black">)</font><font color="maroon">-1</font> <font color="black">)</font>
    <font color="black">{</font>
        size_t nFromLenRemaining <font color="black">=</font> <font color="black">(</font>size_t<font color="black">)</font>convert.nFromLen <font color="black">*</font> nFromCharSize;
        size_t nToCountRemaining <font color="black">=</font> <font color="black">(</font>size_t<font color="black">)</font>convert.nToCount <font color="black">*</font> nToCharSize;
        size_t nToCountRemainingBefore;
        <font color="blue">char</font><font color="black">*</font> pToChar <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>pTo;
        <font color="blue">char</font><font color="black">*</font> pFromChar <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>convert.pFrom;
        <font color="blue">char</font><font color="black">*</font> pToTempBuffer <font color="black">=</font> NULL;
        <font color="blue">const</font> size_t nTempBufferSize <font color="black">=</font> <font color="maroon">2048</font>;
        size_t nResult;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> pTo <font color="black">)</font>
        <font color="black">{</font>
            pToTempBuffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>nTempBufferSize<font color="black">]</font>;
            pToChar <font color="black">=</font> pToTempBuffer;
            nToCountRemaining <font color="black">=</font> nTempBufferSize;
        <font color="black">}</font>
        <font color="blue">while</font> <font color="black">(</font> nFromLenRemaining <font color="black">)</font>
        <font color="black">{</font>
            nToCountRemainingBefore <font color="black">=</font> nToCountRemaining;
            nResult <font color="black">=</font> iconv<font color="black">(</font> cd, <font color="black">&</font>pFromChar, <font color="black">&</font>nFromLenRemaining, <font color="black">&</font>pToChar, <font color="black">&</font>nToCountRemaining <font color="black">)</font>;
            nToLenBytes <font color="black">+</font><font color="black">=</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">(</font>nToCountRemainingBefore <font color="black">-</font>nToCountRemaining<font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> nResult <font color="black">=</font><font color="black">=</font> <font color="black">(</font>size_t<font color="black">)</font><font color="maroon">-1</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// Bypass bad char, question mark denotes problem in source string</font>
                pFromChar <font color="black">+</font><font color="black">=</font> nFromCharSize;
                nFromLenRemaining <font color="black">-</font><font color="black">=</font> nFromCharSize;
                <font color="blue">if</font> <font color="black">(</font> nToCharSize <font color="black">=</font><font color="black">=</font> <font color="maroon">1</font> <font color="black">)</font>
                    <font color="black">*</font>pToChar <font color="black">=</font> <font color="maroon">'?'</font>;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nToCharSize <font color="black">=</font><font color="black">=</font> <font color="maroon">2</font> <font color="black">)</font>
                    <font color="black">*</font><font color="black">(</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>pToChar<font color="black">)</font> <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">)</font><font color="maroon">'?'</font>;
                <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nToCharSize <font color="black">=</font><font color="black">=</font> <font color="maroon">4</font> <font color="black">)</font>
                    <font color="black">*</font><font color="black">(</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font><font color="black">)</font>pToChar<font color="black">)</font> <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font><font color="maroon">'?'</font>;
                pToChar <font color="black">+</font><font color="black">=</font> nToCharSize;
                nToCountRemaining <font color="black">-</font><font color="black">=</font> nToCharSize;
            <font color="black">}</font>
            <font color="blue">else</font>
                convert.nFailedChars <font color="black">+</font><font color="black">=</font> nResult;
            <font color="blue">if</font> <font color="black">(</font> pToTempBuffer <font color="black">&</font><font color="black">&</font> nToCountRemaining <font color="black">&#60;</font> <font color="maroon">10</font> <font color="black">)</font>
            <font color="black">{</font>
                nToCountRemaining <font color="black">=</font> nTempBufferSize;
                pToChar <font color="black">=</font> pToTempBuffer;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font> pToTempBuffer <font color="black">)</font>
            <font color="blue">delete</font><font color="black">[</font><font color="black">]</font> pToTempBuffer;
        iconv_close<font color="black">(</font>cd<font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> nToLenBytes <font color="black">/</font> nToCharSize;
<font color="black">}</font>
<font color="blue">#endif</font>

<font color="blue">int</font> CMarkup<font color="black">:</font><font color="black">:</font>x_ConvertEncoding<font color="black">(</font> ConvertEncoding<font color="black">&</font> convert, <font color="blue">void</font><font color="black">*</font> pTo <font color="black">)</font>
<font color="black">{</font>
    <font color="green">// If pTo is not NULL, it must be large enough to hold result, length of result is returned</font>
    <font color="green">// convert.nFailedChars will be set to &#62;0 if characters not supported in strToEncoding</font>
    <font color="blue">int</font> nToLen <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> nToCP <font color="black">=</font> x_GetEncodingCodePage<font color="black">(</font> convert.strToEncoding <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
        nToCP <font color="black">=</font> MCD_ACP;
    <font color="blue">int</font> nFromCP <font color="black">=</font> x_GetEncodingCodePage<font color="black">(</font> convert.strFromEncoding <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
        nFromCP <font color="black">=</font> MCD_ACP;
    convert.nFailedChars <font color="black">=</font> <font color="maroon">0</font>;

<font color="blue">#if</font> <font color="black">!</font> defined<font color="black">(</font>MARKUP_WINCONV<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">!</font> defined<font color="black">(</font>MARKUP_ICONV<font color="black">)</font>
    <font color="green">// Only non-Unicode encoding supported is locale charset, must call setlocale</font>
    <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">!</font><font color="black">=</font> MCD_UTF8 <font color="black">&</font><font color="black">&</font> nToCP <font color="black">!</font><font color="black">=</font> MCD_UTF16 <font color="black">&</font><font color="black">&</font> nToCP <font color="black">!</font><font color="black">=</font> MCD_UTF32 <font color="black">)</font>
        nToCP <font color="black">=</font> MCD_ACP;
    <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">!</font><font color="black">=</font> MCD_UTF8 <font color="black">&</font><font color="black">&</font> nFromCP <font color="black">!</font><font color="black">=</font> MCD_UTF16 <font color="black">&</font><font color="black">&</font> nFromCP <font color="black">!</font><font color="black">=</font> MCD_UTF32 <font color="black">)</font>
        nFromCP <font color="black">=</font> MCD_ACP;
    <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_ACP <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> pA <font color="black">=</font> <font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">)</font>convert.pFrom;
        <font color="blue">int</font> nALenRemaining <font color="black">=</font> convert.nFromLen;
        <font color="blue">int</font> nCharLen;
        wchar_t wcChar;
        <font color="blue">char</font><font color="black">*</font> pU <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>pTo;
        <font color="blue">while</font> <font color="black">(</font> nALenRemaining <font color="black">)</font>
        <font color="black">{</font>
            nCharLen <font color="black">=</font> mbtowc<font color="black">(</font> <font color="black">&</font>wcChar, pA, nALenRemaining <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> nCharLen <font color="black">&#60;</font> <font color="maroon">1</font> <font color="black">)</font>
            <font color="black">{</font>
                wcChar <font color="black">=</font> <font color="black">(</font>wchar_t<font color="black">)</font><font color="maroon">'?'</font>;
                nCharLen <font color="black">=</font> <font color="maroon">1</font>;
            <font color="black">}</font>
            pA <font color="black">+</font><font color="black">=</font> nCharLen;
            nALenRemaining <font color="black">-</font><font color="black">=</font> nCharLen;
            <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_UTF8 <font color="black">)</font>
                EncodeCharUTF8<font color="black">(</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font>wcChar, pU, nToLen <font color="black">)</font>;
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_UTF16 <font color="black">)</font>
                EncodeCharUTF16<font color="black">(</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font>wcChar, <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>pU, nToLen <font color="black">)</font>;
            <font color="blue">else</font> <font color="green">// UTF32</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> pU <font color="black">)</font>
                    <font color="black">(</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font><font color="black">)</font>pU<font color="black">)</font><font color="black">[</font>nToLen<font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font>wcChar;
                <font color="black">+</font><font color="black">+</font>nToLen;
            <font color="black">}</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_ACP <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">union</font> pUnicodeUnion <font color="black">{</font> <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> p8; <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> p16; <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font> p32; <font color="black">}</font> pU;
        pU.p8 <font color="black">=</font> <font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">)</font>convert.pFrom;
        <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> pUEnd <font color="black">=</font> pU.p8 <font color="black">+</font> convert.nFromLen;
        <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_UTF16 <font color="black">)</font>
            pUEnd <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font><font color="black">(</font> pU.p16 <font color="black">+</font> convert.nFromLen <font color="black">)</font>;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_UTF32 <font color="black">)</font>
            pUEnd <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font><font color="black">(</font> pU.p32 <font color="black">+</font> convert.nFromLen <font color="black">)</font>;
        <font color="blue">int</font> nCharLen;
        <font color="blue">char</font><font color="black">*</font> pA <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>pTo;
        <font color="blue">char</font> szA<font color="black">[</font><font color="maroon">8</font><font color="black">]</font>;
        <font color="blue">int</font> nUChar;
        <font color="blue">while</font> <font color="black">(</font> pU.p8 <font color="black">!</font><font color="black">=</font> pUEnd <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_UTF8 <font color="black">)</font>
                nUChar <font color="black">=</font> DecodeCharUTF8<font color="black">(</font> pU.p8, pUEnd <font color="black">)</font>;
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_UTF16 <font color="black">)</font>
                nUChar <font color="black">=</font> DecodeCharUTF16<font color="black">(</font> pU.p16, <font color="black">(</font><font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>pUEnd <font color="black">)</font>;
            <font color="blue">else</font> <font color="green">// UTF32</font>
                nUChar <font color="black">=</font> <font color="black">*</font><font color="black">(</font>pU.p32<font color="black">)</font><font color="black">+</font><font color="black">+</font>;
            <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
                nCharLen <font color="black">=</font> <font color="maroon">-2</font>;
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">&</font> ~<font color="maroon">0xffff</font> <font color="black">)</font>
                nCharLen <font color="black">=</font> <font color="maroon">-1</font>;
            <font color="blue">else</font>
                nCharLen <font color="black">=</font> wctomb<font color="black">(</font> pA?pA<font color="black">:</font>szA, <font color="black">(</font>wchar_t<font color="black">)</font>nUChar <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> nCharLen <font color="black">&#60;</font> <font color="maroon">0</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> nCharLen <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
                    <font color="black">+</font><font color="black">+</font>convert.nFailedChars;
                nCharLen <font color="black">=</font> <font color="maroon">1</font>;
                <font color="blue">if</font> <font color="black">(</font> pA <font color="black">)</font>
                    <font color="black">*</font>pA <font color="black">=</font> <font color="maroon">'?'</font>;
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font> pA <font color="black">)</font>
                pA <font color="black">+</font><font color="black">=</font> nCharLen;
            nToLen <font color="black">+</font><font color="black">=</font> nCharLen;
        <font color="black">}</font>
    <font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// not WINCONV and not ICONV</font>

    <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_UTF32 <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font> p32 <font color="black">=</font> <font color="black">(</font><font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font><font color="black">)</font>convert.pFrom;
        <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font> p32End <font color="black">=</font> p32 <font color="black">+</font> convert.nFromLen;
        <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_UTF8 <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">char</font><font color="black">*</font> p8 <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>pTo;
            <font color="blue">while</font> <font color="black">(</font> p32 <font color="black">!</font><font color="black">=</font> p32End <font color="black">)</font>
                EncodeCharUTF8<font color="black">(</font> <font color="black">*</font>p32<font color="black">+</font><font color="black">+</font>, p8, nToLen <font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_UTF16 <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> p16 <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>pTo;
            <font color="blue">while</font> <font color="black">(</font> p32 <font color="black">!</font><font color="black">=</font> p32End <font color="black">)</font>
                EncodeCharUTF16<font color="black">(</font> <font color="black">(</font><font color="blue">int</font><font color="black">)</font><font color="black">*</font>p32<font color="black">+</font><font color="black">+</font>, p16, nToLen <font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="green">// to ANSI</font>
        <font color="black">{</font>
            <font color="green">// WINCONV not supported for 32To8, since only used for sizeof(wchar_t) == 4</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_ICONV<font color="black">)</font>
            nToLen <font color="black">=</font> x_IConv<font color="black">(</font> convert, pTo, <font color="maroon">1</font>, <font color="maroon">4</font> <font color="black">)</font>;
<font color="blue">#endif</font> <font color="green">// ICONV</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_UTF16 <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// UTF16To8 will be deprecated since weird output buffer size sensitivity not worth implementing here</font>
        <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> p16 <font color="black">=</font> <font color="black">(</font><font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>convert.pFrom;
        <font color="blue">const</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> p16End <font color="black">=</font> p16 <font color="black">+</font> convert.nFromLen;
        <font color="blue">int</font> nUChar;
        <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_UTF32 <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font> p32 <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font><font color="black">)</font>pTo;
            <font color="blue">while</font> <font color="black">(</font> p16 <font color="black">!</font><font color="black">=</font> p16End <font color="black">)</font>
            <font color="black">{</font>
                nUChar <font color="black">=</font> DecodeCharUTF16<font color="black">(</font> p16, p16End <font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
                    nUChar <font color="black">=</font> <font color="maroon">'?'</font>;
                <font color="blue">if</font> <font color="black">(</font> p32 <font color="black">)</font>
                    p32<font color="black">[</font>nToLen<font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font>nUChar;
                <font color="black">+</font><font color="black">+</font>nToLen;
            <font color="black">}</font>
        <font color="black">}</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WINCONV<font color="black">)</font>
        <font color="blue">else</font> <font color="green">// to UTF-8 or other multi-byte</font>
        <font color="black">{</font>
            nToLen <font color="black">=</font> WideCharToMultiByte<font color="black">(</font>nToCP,<font color="maroon">0</font>,<font color="black">(</font><font color="blue">const</font> wchar_t<font color="black">*</font><font color="black">)</font>convert.pFrom,convert.nFromLen,<font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>pTo,
                    convert.nToCount?convert.nToCount<font color="black">+</font><font color="maroon">1</font><font color="black">:</font><font color="maroon">0</font>,NULL,
                    <font color="black">(</font>nToCP<font color="black">=</font><font color="black">=</font>CP_UTF8<font color="black">)</font>?NULL<font color="black">:</font><font color="black">&</font>convert.nFailedChars<font color="black">)</font>; <font color="green">// fails with lpUsedDefaultChar and CP_UTF8</font>
        <font color="black">}</font>
<font color="blue">#else</font> <font color="green">// not WINCONV</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_UTF8 <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">char</font><font color="black">*</font> p8 <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>pTo;
            <font color="blue">while</font> <font color="black">(</font> p16 <font color="black">!</font><font color="black">=</font> p16End <font color="black">)</font>
            <font color="black">{</font>
                nUChar <font color="black">=</font> DecodeCharUTF16<font color="black">(</font> p16, p16End <font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
                    nUChar <font color="black">=</font> <font color="maroon">'?'</font>;
                EncodeCharUTF8<font color="black">(</font> nUChar, p8, nToLen <font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="green">// to ANSI</font>
        <font color="black">{</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_ICONV<font color="black">)</font>
            nToLen <font color="black">=</font> x_IConv<font color="black">(</font> convert, pTo, <font color="maroon">1</font>, <font color="maroon">2</font> <font color="black">)</font>;
<font color="blue">#endif</font> <font color="green">// ICONV</font>
        <font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// not WINCONV</font>
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_UTF16  <font color="black">)</font> <font color="green">// to UTF-16 from UTF-8/ANSI</font>
    <font color="black">{</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WINCONV<font color="black">)</font>
        nToLen <font color="black">=</font> MultiByteToWideChar<font color="black">(</font>nFromCP,<font color="maroon">0</font>,<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">)</font>convert.pFrom,convert.nFromLen,<font color="black">(</font>wchar_t<font color="black">*</font><font color="black">)</font>pTo,convert.nToCount<font color="black">)</font>;
<font color="blue">#else</font> <font color="green">// not WINCONV</font>
        <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_UTF8 <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> p8 <font color="black">=</font> <font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">)</font>convert.pFrom;
            <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> p8End <font color="black">=</font> p8 <font color="black">+</font> convert.nFromLen;
            <font color="blue">int</font> nUChar;
            <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> p16 <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>pTo;
            <font color="blue">while</font> <font color="black">(</font> p8 <font color="black">!</font><font color="black">=</font> p8End <font color="black">)</font>
            <font color="black">{</font>
                nUChar <font color="black">=</font> DecodeCharUTF8<font color="black">(</font> p8, p8End <font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
                    nUChar <font color="black">=</font> <font color="maroon">'?'</font>;
                <font color="blue">if</font> <font color="black">(</font> p16 <font color="black">)</font>
                    p16<font color="black">[</font>nToLen<font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">)</font>nUChar;
                <font color="black">+</font><font color="black">+</font>nToLen;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="green">// from ANSI</font>
        <font color="black">{</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_ICONV<font color="black">)</font>
            nToLen <font color="black">=</font> x_IConv<font color="black">(</font> convert, pTo, <font color="maroon">2</font>, <font color="maroon">1</font> <font color="black">)</font>;
<font color="blue">#endif</font> <font color="green">// ICONV</font>
        <font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// not WINCONV</font>
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nToCP <font color="black">=</font><font color="black">=</font> MCD_UTF32  <font color="black">)</font> <font color="green">// to UTF-32 from UTF-8/ANSI</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> nFromCP <font color="black">=</font><font color="black">=</font> MCD_UTF8 <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> p8 <font color="black">=</font> <font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">)</font>convert.pFrom;
            <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> p8End <font color="black">=</font> p8 <font color="black">+</font> convert.nFromLen;
            <font color="blue">int</font> nUChar;
            <font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font> p32 <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">*</font><font color="black">)</font>pTo;
            <font color="blue">while</font> <font color="black">(</font> p8 <font color="black">!</font><font color="black">=</font> p8End <font color="black">)</font>
            <font color="black">{</font>
                nUChar <font color="black">=</font> DecodeCharUTF8<font color="black">(</font> p8, p8End <font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> nUChar <font color="black">=</font><font color="black">=</font> <font color="maroon">-1</font> <font color="black">)</font>
                    nUChar <font color="black">=</font> <font color="maroon">'?'</font>;
                <font color="blue">if</font> <font color="black">(</font> p32 <font color="black">)</font>
                    p32<font color="black">[</font>nToLen<font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font>nUChar;
                <font color="black">+</font><font color="black">+</font>nToLen;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font> <font color="green">// from ANSI</font>
        <font color="black">{</font>
            <font color="green">// WINCONV not supported for ATo32, since only used for sizeof(wchar_t) == 4</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_ICONV<font color="black">)</font>
            nToLen <font color="black">=</font> x_IConv<font color="black">(</font> convert, pTo, <font color="maroon">4</font>, <font color="maroon">1</font> <font color="black">)</font>;
<font color="blue">#endif</font> <font color="green">// ICONV</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">else</font>
    <font color="black">{</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_ICONV<font color="black">)</font>
        nToLen <font color="black">=</font> x_IConv<font color="black">(</font> convert, pTo, <font color="maroon">1</font>, <font color="maroon">1</font> <font color="black">)</font>;
<font color="blue">#elif</font> defined<font color="black">(</font>MARKUP_WINCONV<font color="black">)</font>
        wchar_t<font color="black">*</font> pwszUTF16 <font color="black">=</font> <font color="blue">new</font> wchar_t<font color="black">[</font>convert.nFromLen<font color="black">]</font>;
        <font color="blue">int</font> nUTF16Len <font color="black">=</font> MultiByteToWideChar<font color="black">(</font>nFromCP,<font color="maroon">0</font>,<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">)</font>convert.pFrom,convert.nFromLen,pwszUTF16,convert.nFromLen<font color="black">)</font>;
        nToLen <font color="black">=</font> WideCharToMultiByte<font color="black">(</font>nToCP,<font color="maroon">0</font>,pwszUTF16,nUTF16Len,<font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>pTo,convert.nToCount,NULL,
            <font color="black">(</font>nToCP<font color="black">=</font><font color="black">=</font>CP_UTF8<font color="black">)</font>?NULL<font color="black">:</font><font color="black">&</font>convert.nFailedChars<font color="black">)</font>; <font color="green">// cannot specify lpUsedDefaultChar if UTF-8!</font>
        <font color="blue">delete</font><font color="black">[</font><font color="black">]</font> pwszUTF16;
<font color="blue">#endif</font> <font color="green">// WINCONV</font>
    <font color="black">}</font>

    <font color="green">// Store the length in case this is called again after allocating output buffer to fit</font>
    convert.nToCount <font color="black">=</font> nToLen;
    <font color="blue">return</font> nToLen;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_EndianSwapRequired<font color="black">(</font> <font color="blue">int</font> nDocFlags <font color="black">)</font>
<font color="black">{</font>
    <font color="blue">short</font> nWord <font color="black">=</font> <font color="maroon">1</font>;
    <font color="blue">char</font> cFirstByte <font color="black">=</font> <font color="black">(</font><font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font><font color="black">&</font>nWord<font color="black">)</font><font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;
    <font color="blue">if</font> <font color="black">(</font> cFirstByte <font color="black">)</font> <font color="green">// LE</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> nDocFlags <font color="black">&</font> MDF_UTF16BEFILE <font color="black">)</font>
            <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> nDocFlags <font color="black">&</font> MDF_UTF16LEFILE <font color="black">)</font>
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>

<font color="blue">void</font> CMarkup<font color="black">:</font><font color="black">:</font>x_EndianSwapUTF16<font color="black">(</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pBuffer, <font color="blue">int</font> nCharLen <font color="black">)</font>
<font color="black">{</font>
    <font color="blue">unsigned</font> <font color="blue">short</font> cChar;
    <font color="blue">while</font> <font color="black">(</font> nCharLen<font color="black">-</font><font color="black">-</font><font color="black">)</font>
    <font color="black">{</font>
        cChar <font color="black">=</font> pBuffer<font color="black">[</font>nCharLen<font color="black">]</font>;
        pBuffer<font color="black">[</font>nCharLen<font color="black">]</font> <font color="black">=</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">)</font><font color="black">(</font><font color="black">(</font>cChar<font color="black">&#60;</font><font color="black">&#60;</font><font color="maroon">8</font><font color="black">)</font> <font color="black">|</font> <font color="black">(</font>cChar<font color="black">&#62;</font><font color="black">&#62;</font><font color="maroon">8</font><font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
<font color="black">}</font>

<font color="blue">struct</font> BomTableStruct <font color="black">{</font> <font color="blue">const</font> <font color="blue">char</font><font color="black">*</font> pszBom; <font color="blue">int</font> nBomLen; MCD_PCSZ pszBomEnc; <font color="blue">int</font> nBomFlag; <font color="black">}</font> BomTable<font color="black">[</font><font color="black">]</font> <font color="black">=</font>
<font color="black">{</font>
    <font color="black">{</font> <font color="maroon">"\xef\xbb\xbf"</font>, <font color="maroon">3</font>, MCD_T<font color="black">(</font><font color="maroon">"UTF-8"</font><font color="black">)</font>, CMarkup<font color="black">:</font><font color="black">:</font>MDF_UTF8PREAMBLE <font color="black">}</font>,
    <font color="black">{</font> <font color="maroon">"\xff\xfe"</font>, <font color="maroon">2</font>, MCD_T<font color="black">(</font><font color="maroon">"UTF-16LE"</font><font color="black">)</font>, CMarkup<font color="black">:</font><font color="black">:</font>MDF_UTF16LEFILE <font color="black">}</font>,
    <font color="black">{</font> <font color="maroon">"\xfe\xff"</font>, <font color="maroon">2</font>, MCD_T<font color="black">(</font><font color="maroon">"UTF-16BE"</font><font color="black">)</font>, CMarkup<font color="black">:</font><font color="black">:</font>MDF_UTF16BEFILE <font color="black">}</font>,
    <font color="black">{</font> NULL,<font color="maroon">0</font>,NULL,<font color="maroon">0</font> <font color="black">}</font>
<font color="black">}</font>;

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_Open<font color="black">(</font> MCD_CSTR_FILENAME szFileName, FilePos<font color="black">&</font> file <font color="black">)</font>
<font color="black">{</font>
    MCD_STRCLEAR<font color="black">(</font> file.strIOResult <font color="black">)</font>;

    <font color="green">// Open file</font>
    MCD_PCSZ_FILENAME pMode <font color="black">=</font> MCD_T_FILENAME<font color="black">(</font><font color="maroon">"rb"</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> file.nDocFlags <font color="black">&</font> MDF_APPENDFILE <font color="black">)</font>
        pMode <font color="black">=</font> MCD_T_FILENAME<font color="black">(</font><font color="maroon">"ab"</font><font color="black">)</font>;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> file.nDocFlags <font color="black">&</font> MDF_WRITEFILE <font color="black">)</font>
        pMode <font color="black">=</font> MCD_T_FILENAME<font color="black">(</font><font color="maroon">"wb"</font><font color="black">)</font>;
    file.fp <font color="black">=</font> NULL;
    MCD_FOPEN<font color="black">(</font> file.fp, szFileName, pMode <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> file.fp <font color="black">)</font>
    <font color="black">{</font>
        file.strIOResult <font color="black">=</font> x_GetLastError<font color="black">(</font><font color="black">)</font>;
        <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>

    <font color="green">// Prepare file</font>
    <font color="blue">bool</font> bSuccess <font color="black">=</font> <font color="blue">true</font>;
    <font color="blue">int</font> nBomLen <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">if</font> <font color="black">(</font> file.nDocFlags <font color="black">&</font> MDF_READFILE <font color="black">)</font>
    <font color="black">{</font>
        <font color="green">// Get file length</font>
        fseek<font color="black">(</font> file.fp, <font color="maroon">0</font>, SEEK_END <font color="black">)</font>;
        file.nFileByteLen <font color="black">=</font> ftell<font color="black">(</font> file.fp <font color="black">)</font>;
        fseek<font color="black">(</font> file.fp, <font color="maroon">0</font>, SEEK_SET <font color="black">)</font>;

        <font color="green">// Read the top of the file to check BOM and encoding</font>
        <font color="blue">int</font> nReadTop <font color="black">=</font> <font color="maroon">1024</font>;
        <font color="blue">if</font> <font color="black">(</font> file.nFileByteLen <font color="black">&#60;</font> nReadTop <font color="black">)</font>
            nReadTop <font color="black">=</font> file.nFileByteLen;
        <font color="blue">if</font> <font color="black">(</font> nReadTop <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">char</font><font color="black">*</font> pFileTop <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>nReadTop<font color="black">]</font>;
            <font color="blue">if</font> <font color="black">(</font> nReadTop <font color="black">)</font>
                bSuccess <font color="black">=</font> <font color="black">(</font> fread<font color="black">(</font> pFileTop, nReadTop, <font color="maroon">1</font>, file.fp <font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">1</font> <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> bSuccess <font color="black">)</font>
            <font color="black">{</font>
                <font color="green">// Check for Byte Order Mark (preamble)</font>
                <font color="blue">int</font> nBomCheck <font color="black">=</font> <font color="maroon">0</font>;
                file.nDocFlags <font color="black">&</font><font color="black">=</font> ~<font color="black">(</font> MDF_UTF16LEFILE <font color="black">|</font> MDF_UTF8PREAMBLE <font color="black">)</font>;
                file.nFileCharUnitSize <font color="black">=</font> <font color="maroon">1</font>; <font color="green">// unless UTF-16 BOM found</font>
                <font color="blue">while</font> <font color="black">(</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.pszBom <font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">while</font> <font color="black">(</font> nBomLen <font color="black">&#60;</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.nBomLen <font color="black">)</font>
                    <font color="black">{</font>
                        <font color="blue">if</font> <font color="black">(</font> nBomLen <font color="black">&#62;</font><font color="black">=</font> nReadTop <font color="black">|</font><font color="black">|</font> pFileTop<font color="black">[</font>nBomLen<font color="black">]</font> <font color="black">!</font><font color="black">=</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.pszBom<font color="black">[</font>nBomLen<font color="black">]</font> <font color="black">)</font>
                            <font color="blue">break</font>;
                        <font color="black">+</font><font color="black">+</font>nBomLen;
                    <font color="black">}</font>
                    <font color="blue">if</font> <font color="black">(</font> nBomLen <font color="black">=</font><font color="black">=</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.nBomLen <font color="black">)</font>
                    <font color="black">{</font>
                        file.nDocFlags <font color="black">|</font><font color="black">=</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.nBomFlag;
                        file.nFileByteLen <font color="black">-</font><font color="black">=</font> nBomLen;
                        <font color="blue">if</font> <font color="black">(</font> nBomLen <font color="black">=</font><font color="black">=</font> <font color="maroon">2</font> <font color="black">)</font>
                            file.nFileCharUnitSize <font color="black">=</font> <font color="maroon">2</font>;
                        file.strEncoding <font color="black">=</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.pszBomEnc;
                        <font color="blue">break</font>;
                    <font color="black">}</font>
                    <font color="black">+</font><font color="black">+</font>nBomCheck;
                    nBomLen <font color="black">=</font> <font color="maroon">0</font>;
                <font color="black">}</font>
                <font color="blue">if</font> <font color="black">(</font> nReadTop <font color="black">&#62;</font> nBomLen <font color="black">)</font>
                    fseek<font color="black">(</font> file.fp, nBomLen, SEEK_SET <font color="black">)</font>;

                <font color="green">// Encoding check</font>
                <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> nBomLen <font color="black">)</font>
                <font color="black">{</font>
                    MCD_STR strDeclCheck;
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WCHAR<font color="black">)</font> <font color="green">// WCHAR</font>
                    ConvertEncoding convert<font color="black">(</font> MCD_ENC, MCD_T<font color="black">(</font><font color="maroon">"UTF-8"</font><font color="black">)</font>, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pFileTop, nReadTop <font color="black">)</font>;
                    MCD_CHAR<font color="black">*</font> pWideBuffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strDeclCheck,nReadTop<font color="black">)</font>;
                    convert.nToCount <font color="black">=</font> nReadTop;
                    <font color="blue">int</font> nDeclWideLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pWideBuffer <font color="black">)</font>;
                    MCD_RELEASEBUFFER<font color="black">(</font>strDeclCheck,pWideBuffer,nDeclWideLen<font color="black">)</font>;
<font color="blue">#else</font> <font color="green">// not WCHAR</font>
                    MCD_STRASSIGN<font color="black">(</font>strDeclCheck,pFileTop,nReadTop<font color="black">)</font>;
<font color="blue">#endif</font> <font color="green">// not WCHAR</font>
                    file.strEncoding <font color="black">=</font> GetDeclaredEncoding<font color="black">(</font> strDeclCheck <font color="black">)</font>;
                <font color="black">}</font>
                <font color="green">// Assume markup files starting with &#60; sign are UTF-8 if otherwise unknown</font>
                <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>file.strEncoding<font color="black">)</font> <font color="black">&</font><font color="black">&</font> pFileTop<font color="black">[</font><font color="maroon">0</font><font color="black">]</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">'&#60;'</font> <font color="black">)</font>
                    file.strEncoding <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"UTF-8"</font><font color="black">)</font>;
            <font color="black">}</font>
            <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pFileTop;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font> file.nDocFlags <font color="black">&</font> MDF_WRITEFILE <font color="black">)</font>
    <font color="black">{</font>
        file.nFileCharUnitSize <font color="black">=</font> <font color="maroon">1</font>;
        <font color="blue">if</font> <font color="black">(</font> file.nDocFlags <font color="black">&</font> MDF_APPENDFILE <font color="black">)</font>
            file.nFileByteLen <font color="black">=</font> ftell<font color="black">(</font> file.fp <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> file.nFileByteLen <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">int</font> nBomCheck <font color="black">=</font> <font color="maroon">0</font>;
            <font color="blue">while</font> <font color="black">(</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.pszBom <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> file.nDocFlags <font color="black">&</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.nBomFlag <font color="black">)</font>
                <font color="black">{</font>
                    nBomLen <font color="black">=</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.nBomLen;
                    <font color="blue">if</font> <font color="black">(</font> nBomLen <font color="black">=</font><font color="black">=</font> <font color="maroon">2</font> <font color="black">)</font>
                    <font color="black">{</font>
                        file.nFileCharUnitSize <font color="black">=</font> <font color="maroon">2</font>;
                        file.strEncoding <font color="black">=</font> BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.pszBomEnc;
                    <font color="black">}</font>
                    bSuccess <font color="black">=</font> <font color="black">(</font> fwrite<font color="black">(</font>BomTable<font color="black">[</font>nBomCheck<font color="black">]</font>.pszBom,nBomLen,<font color="maroon">1</font>,file.fp<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">1</font> <font color="black">)</font>;
                    <font color="blue">break</font>;
                <font color="black">}</font>
                <font color="black">+</font><font color="black">+</font>nBomCheck;
            <font color="black">}</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> bSuccess <font color="black">)</font>
    <font color="black">{</font>
        file.strIOResult <font color="black">=</font> x_GetLastError<font color="black">(</font><font color="black">)</font>;
        <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>

    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> MCD_STRISEMPTY<font color="black">(</font>file.strEncoding<font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        file.strIOResult <font color="black">=</font> file.strEncoding;
        <font color="blue">if</font> <font color="black">(</font> nBomLen <font color="black">)</font>
            file.strIOResult <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">" BOM +"</font><font color="black">)</font>;
        file.strIOResult <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">" "</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">return</font> bSuccess;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_Read<font color="black">(</font> <font color="blue">void</font><font color="black">*</font> pBuffer, FilePos<font color="black">&</font> file <font color="black">)</font>
<font color="black">{</font>
    MCD_CHAR szReadInfo<font color="black">[</font><font color="maroon">100</font><font color="black">]</font> <font color="black">=</font> <font color="black">{</font><font color="maroon">0</font><font color="black">}</font>;
    <font color="blue">bool</font> bSuccess <font color="black">=</font> <font color="black">(</font> fread<font color="black">(</font> pBuffer,file.nReadByteLen,<font color="maroon">1</font>,file.fp<font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">1</font> <font color="black">)</font>;
    file.nFileTextLen <font color="black">=</font> file.nReadByteLen <font color="black">/</font> file.nFileCharUnitSize;
    <font color="blue">if</font> <font color="black">(</font> bSuccess <font color="black">)</font>
    <font color="black">{</font>
        MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szReadInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"length %d "</font><font color="black">)</font>, file.nFileTextLen <font color="black">)</font>;
        file.strIOResult <font color="black">=</font> szReadInfo;

        <font color="green">// Microsoft components can produce apparently valid docs with some nulls at ends of values</font>
        <font color="blue">int</font> nNullCount <font color="black">=</font> <font color="maroon">0</font>;
        <font color="blue">int</font> nNullCheckCharsRemaining <font color="black">=</font> file.nFileTextLen;
        <font color="blue">char</font><font color="black">*</font> pAfterNull <font color="black">=</font> NULL;
        <font color="blue">char</font><font color="black">*</font> pNullScan <font color="black">=</font> <font color="black">(</font><font color="blue">char</font><font color="black">*</font><font color="black">)</font>pBuffer;
        <font color="blue">bool</font> bSingleByteChar <font color="black">=</font> file.nFileCharUnitSize <font color="black">=</font><font color="black">=</font> <font color="maroon">1</font>;
        <font color="blue">while</font> <font color="black">(</font> nNullCheckCharsRemaining<font color="black">-</font><font color="black">-</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> bSingleByteChar? <font color="black">(</font><font color="black">!</font> <font color="black">*</font>pNullScan<font color="black">)</font> <font color="black">:</font> <font color="black">(</font><font color="black">!</font> <font color="black">(</font><font color="black">*</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>pNullScan<font color="black">)</font><font color="black">)</font> <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font> pAfterNull <font color="black">&</font><font color="black">&</font> pNullScan <font color="black">!</font><font color="black">=</font> pAfterNull <font color="black">)</font>
                    memmove<font color="black">(</font> pAfterNull <font color="black">-</font><font color="black">(</font>nNullCount<font color="black">*</font>file.nFileCharUnitSize<font color="black">)</font>, pAfterNull, pNullScan <font color="black">-</font>pAfterNull <font color="black">)</font>;
                pAfterNull <font color="black">=</font> pNullScan  <font color="black">+</font> file.nFileCharUnitSize;
                <font color="black">+</font><font color="black">+</font>nNullCount;
            <font color="black">}</font>
            pNullScan <font color="black">+</font><font color="black">=</font> file.nFileCharUnitSize;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font> pAfterNull <font color="black">&</font><font color="black">&</font> pNullScan <font color="black">!</font><font color="black">=</font> pAfterNull <font color="black">)</font>
            memmove<font color="black">(</font> pAfterNull <font color="black">-</font><font color="black">(</font>nNullCount<font color="black">*</font>file.nFileCharUnitSize<font color="black">)</font>, pAfterNull, pNullScan <font color="black">-</font>pAfterNull <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> nNullCount <font color="black">)</font>
        <font color="black">{</font>
            MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szReadInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"(%d nulls removed) "</font><font color="black">)</font>, nNullCount <font color="black">)</font>;
            file.strIOResult <font color="black">+</font><font color="black">=</font> szReadInfo;
            file.nFileTextLen <font color="black">-</font><font color="black">=</font> nNullCount;
        <font color="black">}</font>

        <font color="green">// Big endian/little endian conversion</font>
        <font color="blue">if</font> <font color="black">(</font> file.nFileCharUnitSize <font color="black">&#62;</font> <font color="maroon">1</font> <font color="black">&</font><font color="black">&</font> x_EndianSwapRequired<font color="black">(</font>file.nDocFlags<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            x_EndianSwapUTF16<font color="black">(</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>pBuffer, file.nFileTextLen <font color="black">)</font>;
            file.strIOResult <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"endian swap "</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> bSuccess <font color="black">)</font>
        file.strIOResult <font color="black">=</font> x_GetLastError<font color="black">(</font><font color="black">)</font>;
    <font color="blue">return</font> bSuccess;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_ReadText<font color="black">(</font> MCD_STR<font color="black">&</font> strDoc, FilePos<font color="black">&</font> file <font color="black">)</font>
<font color="black">{</font>
    <font color="blue">bool</font> bSuccess <font color="black">=</font> <font color="blue">true</font>;
    MCD_CHAR szReadInfo<font color="black">[</font><font color="maroon">100</font><font color="black">]</font> <font color="black">=</font> <font color="black">{</font><font color="maroon">0</font><font color="black">}</font>;
    MCD_STRCLEAR<font color="black">(</font> file.strIOResult <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> file.nReadByteLen <font color="black">)</font>
    <font color="black">{</font>
        file.strIOResult <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"0 length "</font><font color="black">)</font>;
        <font color="blue">return</font> bSuccess;
    <font color="black">}</font>

    <font color="blue">if</font> <font color="black">(</font> file.nDocFlags <font color="black">&</font> <font color="black">(</font>MDF_UTF16LEFILE <font color="black">|</font> MDF_UTF16BEFILE<font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">int</font> nUTF16Len <font color="black">=</font> file.nReadByteLen <font color="black">/</font> <font color="maroon">2</font>;
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WCHAR<font color="black">)</font> <font color="green">// WCHAR</font>
        <font color="blue">int</font> nBufferSizeForGrow <font color="black">=</font> nUTF16Len <font color="black">+</font> nUTF16Len<font color="black">/</font><font color="maroon">100</font>; <font color="green">// extra 1%</font>
<font color="blue">#if</font> MARKUP_SIZEOFWCHAR <font color="black">=</font><font color="black">=</font> <font color="maroon">4</font> <font color="green">// sizeof(wchar_t) == 4</font>
        <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pUTF16Buffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">[</font>nUTF16Len<font color="black">+</font><font color="maroon">1</font><font color="black">]</font>;
        bSuccess <font color="black">=</font> x_Read<font color="black">(</font> pUTF16Buffer, file <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> bSuccess <font color="black">)</font>
        <font color="black">{</font>
            ConvertEncoding convert<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"UTF-32"</font><font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"UTF-16"</font><font color="black">)</font>, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pUTF16Buffer, nUTF16Len <font color="black">)</font>;
            convert.nToCount <font color="black">=</font> nBufferSizeForGrow;
            MCD_CHAR<font color="black">*</font> pUTF32Buffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strDoc,nBufferSizeForGrow<font color="black">)</font>;
            <font color="blue">int</font> nUTF32Len <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pUTF32Buffer <font color="black">)</font>;
            MCD_RELEASEBUFFER<font color="black">(</font>strDoc,pUTF32Buffer,nUTF32Len<font color="black">)</font>;
            MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szReadInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"to UTF-32 length %d "</font><font color="black">)</font>, nUTF32Len <font color="black">)</font>;
        <font color="black">}</font>
<font color="blue">#else</font> <font color="green">// sizeof(wchar_t) == 2</font>
        MCD_CHAR<font color="black">*</font> pUTF16Buffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strDoc,nBufferSizeForGrow<font color="black">)</font>;
        bSuccess <font color="black">=</font> x_Read<font color="black">(</font> pUTF16Buffer, file <font color="black">)</font>;
        MCD_RELEASEBUFFER<font color="black">(</font>strDoc,pUTF16Buffer,file.nFileTextLen<font color="black">)</font>;
<font color="blue">#endif</font> <font color="green">// sizeof(wchar_t) == 2</font>
<font color="blue">#else</font> <font color="green">// not WCHAR</font>
        <font color="green">// Convert file from UTF-16; it needs to be in memory as UTF-8 or MBCS</font>
        <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pUTF16Buffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">[</font>nUTF16Len<font color="black">+</font><font color="maroon">1</font><font color="black">]</font>;
        bSuccess <font color="black">=</font> x_Read<font color="black">(</font> pUTF16Buffer, file <font color="black">)</font>;
        nUTF16Len <font color="black">=</font> file.nFileTextLen;
        ConvertEncoding convert<font color="black">(</font> MCD_ENC, MCD_T<font color="black">(</font><font color="maroon">"UTF-16"</font><font color="black">)</font>, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pUTF16Buffer, nUTF16Len <font color="black">)</font>;
        <font color="blue">int</font> nMBLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, NULL <font color="black">)</font>;
        <font color="blue">int</font> nBufferSizeForGrow <font color="black">=</font> nMBLen <font color="black">+</font> nMBLen<font color="black">/</font><font color="maroon">100</font>; <font color="green">// extra 1%</font>
        MCD_CHAR<font color="black">*</font> pMBBuffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strDoc,nBufferSizeForGrow<font color="black">)</font>;
        x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pMBBuffer <font color="black">)</font>;
        <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pUTF16Buffer;
        MCD_RELEASEBUFFER<font color="black">(</font>strDoc,pMBBuffer,nMBLen<font color="black">)</font>;
        MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szReadInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"to %d bytes "</font><font color="black">)</font>, nMBLen <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> convert.nFailedChars <font color="black">)</font>
            MCD_PSZCAT<font color="black">(</font> szReadInfo, MCD_T<font color="black">(</font><font color="maroon">"(chars lost in conversion!) "</font><font color="black">)</font> <font color="black">)</font>;
<font color="blue">#endif</font> <font color="green">// not WCHAR</font>
    <font color="black">}</font>
    <font color="blue">else</font> <font color="green">// single or multibyte file (i.e. not UTF-16)</font>
    <font color="black">{</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WCHAR<font color="black">)</font> <font color="green">// WCHAR</font>
        <font color="blue">char</font><font color="black">*</font> pBuffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>file.nReadByteLen<font color="black">]</font>;
        bSuccess <font color="black">=</font> x_Read<font color="black">(</font> pBuffer, file <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>file.strEncoding<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font> DetectUTF8<font color="black">(</font>pBuffer,file.nReadByteLen<font color="black">)</font> <font color="black">)</font>
                file.strEncoding <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"UTF-8"</font><font color="black">)</font>;
            file.strIOResult <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"(used UTF-8 detection) "</font><font color="black">)</font>;
        <font color="black">}</font>
        ConvertEncoding convert<font color="black">(</font> MCD_ENC, file.strEncoding, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pBuffer, file.nFileTextLen <font color="black">)</font>;
        <font color="blue">int</font> nWideLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, NULL <font color="black">)</font>;
        <font color="blue">int</font> nBufferSizeForGrow <font color="black">=</font> nWideLen <font color="black">+</font> nWideLen<font color="black">/</font><font color="maroon">100</font>; <font color="green">// extra 1%</font>
        MCD_CHAR<font color="black">*</font> pWideBuffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strDoc,nBufferSizeForGrow<font color="black">)</font>;
        x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pWideBuffer <font color="black">)</font>;
        MCD_RELEASEBUFFER<font color="black">(</font> strDoc, pWideBuffer, nWideLen <font color="black">)</font>;
        <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pBuffer;
        MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szReadInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"to %d wide chars "</font><font color="black">)</font>, nWideLen <font color="black">)</font>;
<font color="blue">#else</font> <font color="green">// not WCHAR</font>
        <font color="green">// After loading a file with unknown multi-byte encoding</font>
        <font color="blue">bool</font> bAssumeUnknownIsNative <font color="black">=</font> <font color="blue">false</font>;
        <font color="blue">if</font> <font color="black">(</font> MCD_STRISEMPTY<font color="black">(</font>file.strEncoding<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            bAssumeUnknownIsNative <font color="black">=</font> <font color="blue">true</font>;
            file.strEncoding <font color="black">=</font> MCD_ENC;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font> x_CanConvert<font color="black">(</font>MCD_ENC,file.strEncoding<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">char</font><font color="black">*</font> pBuffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>file.nReadByteLen<font color="black">]</font>;
            bSuccess <font color="black">=</font> x_Read<font color="black">(</font> pBuffer, file <font color="black">)</font>;
            ConvertEncoding convert<font color="black">(</font> MCD_ENC, file.strEncoding, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pBuffer, file.nFileTextLen <font color="black">)</font>;
            <font color="blue">int</font> nMBLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, NULL <font color="black">)</font>;
            <font color="blue">int</font> nBufferSizeForGrow <font color="black">=</font> nMBLen <font color="black">+</font> nMBLen<font color="black">/</font><font color="maroon">100</font>; <font color="green">// extra 1%</font>
            MCD_CHAR<font color="black">*</font> pMBBuffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strDoc,nBufferSizeForGrow<font color="black">)</font>;
            x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pMBBuffer <font color="black">)</font>;
            MCD_RELEASEBUFFER<font color="black">(</font> strDoc, pMBBuffer, nMBLen <font color="black">)</font>;
            <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pBuffer;
            MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szReadInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"to length %d "</font><font color="black">)</font>, nMBLen <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> convert.nFailedChars <font color="black">)</font>
                MCD_PSZCAT<font color="black">(</font> szReadInfo, MCD_T<font color="black">(</font><font color="maroon">"(chars lost in conversion!) "</font><font color="black">)</font> <font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="green">// load directly into string</font>
        <font color="black">{</font>
            <font color="blue">int</font> nBufferSizeForGrow <font color="black">=</font> file.nReadByteLen <font color="black">+</font> file.nReadByteLen<font color="black">/</font><font color="maroon">100</font>; <font color="green">// extra 1%</font>
            MCD_CHAR<font color="black">*</font> pBuffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strDoc,nBufferSizeForGrow<font color="black">)</font>;
            bSuccess <font color="black">=</font> x_Read<font color="black">(</font> pBuffer, file <font color="black">)</font>;
            MCD_RELEASEBUFFER<font color="black">(</font> strDoc, pBuffer, file.nFileTextLen <font color="black">)</font>;

            <font color="green">// Might need additional conversion if we assumed an encoding</font>
            <font color="blue">if</font> <font color="black">(</font> bAssumeUnknownIsNative <font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">int</font> nNonASCII;
                <font color="blue">bool</font> bIsUTF8 <font color="black">=</font> DetectUTF8<font color="black">(</font> MCD_2PCSZ<font color="black">(</font>strDoc<font color="black">)</font>, file.nReadByteLen, <font color="black">&</font>nNonASCII <font color="black">)</font>;
                MCD_STR strDetectedEncoding <font color="black">=</font> bIsUTF8? MCD_T<font color="black">(</font><font color="maroon">"UTF-8"</font><font color="black">)</font><font color="black">:</font> MCD_T<font color="black">(</font><font color="maroon">""</font><font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font> nNonASCII <font color="black">&</font><font color="black">&</font> file.strEncoding <font color="black">!</font><font color="black">=</font> strDetectedEncoding <font color="black">)</font> <font color="green">// only need to convert non-ASCII</font>
                <font color="black">{</font>
                    file.strEncoding <font color="black">=</font> strDetectedEncoding;
                    ConvertEncoding convert<font color="black">(</font> MCD_ENC, file.strEncoding, MCD_2PCSZ<font color="black">(</font>strDoc<font color="black">)</font>, file.nFileTextLen <font color="black">)</font>;
                    <font color="blue">int</font> nMBLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, NULL <font color="black">)</font>;
                    nBufferSizeForGrow <font color="black">=</font> nMBLen <font color="black">+</font> nMBLen<font color="black">/</font><font color="maroon">100</font>; <font color="green">// extra 1%</font>
                    MCD_STR strConvDoc;
                    MCD_CHAR<font color="black">*</font> pBuffer <font color="black">=</font> MCD_GETBUFFER<font color="black">(</font>strConvDoc,nBufferSizeForGrow<font color="black">)</font>;
                    x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pBuffer <font color="black">)</font>;
                    MCD_RELEASEBUFFER<font color="black">(</font> strConvDoc, pBuffer, nMBLen <font color="black">)</font>;
                    strDoc <font color="black">=</font> strConvDoc;
                    MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szReadInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"to length %d "</font><font color="black">)</font>, nMBLen <font color="black">)</font>;
                    <font color="blue">if</font> <font color="black">(</font> convert.nFailedChars <font color="black">)</font>
                        MCD_PSZCAT<font color="black">(</font> szReadInfo, MCD_T<font color="black">(</font><font color="maroon">"(chars lost in conversion!) "</font><font color="black">)</font> <font color="black">)</font>;
                <font color="black">}</font>
                MCD_PSZCAT<font color="black">(</font> szReadInfo, MCD_T<font color="black">(</font><font color="maroon">"(used UTF-8 detection) "</font><font color="black">)</font> <font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// not WCHAR</font>
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font> bSuccess <font color="black">)</font>
        file.strIOResult <font color="black">+</font><font color="black">=</font> szReadInfo;
    <font color="blue">else</font>
        file.strIOResult <font color="black">=</font> x_GetLastError<font color="black">(</font><font color="black">)</font>;
    <font color="blue">return</font> bSuccess;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_Write<font color="black">(</font> <font color="blue">void</font><font color="black">*</font> pBuffer, FilePos<font color="black">&</font> file, <font color="blue">const</font> <font color="blue">void</font><font color="black">*</font> pConstBuffer <font color="green">/*=NULL*/</font> <font color="black">)</font>
<font color="black">{</font>
    MCD_CHAR szWriteInfo<font color="black">[</font><font color="maroon">100</font><font color="black">]</font> <font color="black">=</font> <font color="black">{</font><font color="maroon">0</font><font color="black">}</font>;
    size_t nDocByteLength <font color="black">=</font> file.nFileTextLen <font color="black">*</font> file.nFileCharUnitSize;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> pConstBuffer <font color="black">)</font>
        pConstBuffer <font color="black">=</font> pBuffer;
    <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pTempEndianBuffer <font color="black">=</font> NULL;
    <font color="blue">if</font> <font color="black">(</font> x_EndianSwapRequired<font color="black">(</font>file.nDocFlags<font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> pBuffer <font color="black">)</font>
        <font color="black">{</font>
            pTempEndianBuffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">[</font>file.nFileTextLen<font color="black">]</font>;
            memcpy<font color="black">(</font> pTempEndianBuffer, pConstBuffer, file.nFileTextLen <font color="black">*</font> <font color="maroon">2</font> <font color="black">)</font>;
            pBuffer <font color="black">=</font> pTempEndianBuffer;
            pConstBuffer <font color="black">=</font> pTempEndianBuffer;
        <font color="black">}</font>
        x_EndianSwapUTF16<font color="black">(</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font><font color="black">)</font>pBuffer, file.nFileTextLen <font color="black">)</font>;
        file.strIOResult <font color="black">+</font><font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"endian swap "</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">bool</font> bSuccess <font color="black">=</font> <font color="black">(</font> fwrite<font color="black">(</font> pConstBuffer, nDocByteLength, <font color="maroon">1</font>, file.fp <font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">1</font> <font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> pTempEndianBuffer <font color="black">)</font>
        <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pTempEndianBuffer;
    <font color="blue">if</font> <font color="black">(</font> bSuccess <font color="black">)</font>
    <font color="black">{</font>
        MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szWriteInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"length %d "</font><font color="black">)</font>, file.nFileTextLen <font color="black">)</font>;
        file.strIOResult <font color="black">+</font><font color="black">=</font> szWriteInfo;
    <font color="black">}</font>
    <font color="blue">else</font>
        file.strIOResult <font color="black">=</font> x_GetLastError<font color="black">(</font><font color="black">)</font>;
    <font color="blue">return</font> bSuccess;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_WriteText<font color="black">(</font> <font color="blue">const</font> MCD_STR<font color="black">&</font> strDoc, FilePos<font color="black">&</font> file <font color="black">)</font>
<font color="black">{</font>
    <font color="blue">bool</font> bSuccess <font color="black">=</font> <font color="blue">true</font>;
    MCD_CHAR szWriteInfo<font color="black">[</font><font color="maroon">100</font><font color="black">]</font> <font color="black">=</font> <font color="black">{</font><font color="maroon">0</font><font color="black">}</font>;
    MCD_STRCLEAR<font color="black">(</font> file.strIOResult <font color="black">)</font>;
    MCD_PCSZ pDoc <font color="black">=</font> MCD_2PCSZ<font color="black">(</font>strDoc<font color="black">)</font>;
    <font color="blue">int</font> nWriteStrLen <font color="black">=</font> MCD_STRLENGTH<font color="black">(</font>strDoc<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font> <font color="black">!</font> nWriteStrLen <font color="black">)</font>
    <font color="black">{</font>
        file.strIOResult <font color="black">=</font> MCD_T<font color="black">(</font><font color="maroon">"0 length "</font><font color="black">)</font>;
        <font color="blue">return</font> bSuccess;
    <font color="black">}</font>

    <font color="blue">if</font> <font color="black">(</font> file.nDocFlags <font color="black">&</font> <font color="black">(</font>MDF_UTF16LEFILE <font color="black">|</font> MDF_UTF16BEFILE<font color="black">)</font> <font color="black">)</font>
    <font color="black">{</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WCHAR<font color="black">)</font> <font color="green">// WCHAR</font>
<font color="blue">#if</font> MARKUP_SIZEOFWCHAR <font color="black">=</font><font color="black">=</font> <font color="maroon">4</font> <font color="green">// sizeof(wchar_t) == 4</font>
        ConvertEncoding convert<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"UTF-16"</font><font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"UTF-32"</font><font color="black">)</font>, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pDoc, nWriteStrLen <font color="black">)</font>;
        file.nFileTextLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, NULL <font color="black">)</font>;
        <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pUTF16Buffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">[</font>file.nFileTextLen<font color="black">]</font>;
        x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pUTF16Buffer <font color="black">)</font>;
        MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szWriteInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"from wide-32 length %d "</font><font color="black">)</font>, nWriteStrLen <font color="black">)</font>;
        bSuccess <font color="black">=</font> x_Write<font color="black">(</font> pUTF16Buffer, file <font color="black">)</font>;
        <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pUTF16Buffer;
<font color="blue">#else</font> <font color="green">// sizeof(wchar_t) == 2</font>
        file.nFileTextLen <font color="black">=</font> nWriteStrLen;
        bSuccess <font color="black">=</font> x_Write<font color="black">(</font> NULL, file, pDoc <font color="black">)</font>;
<font color="blue">#endif</font>
<font color="blue">#else</font> <font color="green">// not WCHAR</font>
        ConvertEncoding convert<font color="black">(</font> MCD_T<font color="black">(</font><font color="maroon">"UTF-16"</font><font color="black">)</font>, MCD_ENC, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pDoc, nWriteStrLen <font color="black">)</font>;
        file.nFileTextLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, NULL <font color="black">)</font>;
        <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">*</font> pUTF16Buffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">unsigned</font> <font color="blue">short</font><font color="black">[</font>file.nFileTextLen<font color="black">]</font>;
        x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pUTF16Buffer <font color="black">)</font>;
        MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szWriteInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"from byte length %d "</font><font color="black">)</font>, nWriteStrLen <font color="black">)</font>;
        bSuccess <font color="black">=</font> x_Write<font color="black">(</font> pUTF16Buffer, file <font color="black">)</font>;
        <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pUTF16Buffer;
<font color="blue">#endif</font> <font color="green">// not WCHAR</font>
    <font color="black">}</font>
    <font color="blue">else</font> <font color="green">// single or multibyte file (i.e. not UTF-16)</font>
    <font color="black">{</font>
<font color="blue">#if</font> defined<font color="black">(</font>MARKUP_WCHAR<font color="black">)</font> <font color="green">// WCHAR</font>
        ConvertEncoding convert<font color="black">(</font> file.strEncoding, MCD_ENC, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pDoc, nWriteStrLen <font color="black">)</font>;
        file.nFileTextLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, NULL <font color="black">)</font>;
        <font color="blue">char</font><font color="black">*</font> pMBBuffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>file.nFileTextLen<font color="black">]</font>;
        x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pMBBuffer <font color="black">)</font>;
        MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szWriteInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"from wide length %d "</font><font color="black">)</font>, nWriteStrLen <font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font> convert.nFailedChars <font color="black">)</font>
            MCD_PSZCAT<font color="black">(</font> szWriteInfo, MCD_T<font color="black">(</font><font color="maroon">"(chars lost in conversion!) "</font><font color="black">)</font> <font color="black">)</font>;
        bSuccess <font color="black">=</font> x_Write<font color="black">(</font> pMBBuffer, file <font color="black">)</font>;
        <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pMBBuffer;
<font color="blue">#else</font> <font color="green">// not WCHAR</font>
        <font color="blue">if</font> <font color="black">(</font> x_CanConvert<font color="black">(</font>file.strEncoding,MCD_ENC<font color="black">)</font> <font color="black">)</font>
        <font color="black">{</font>
            ConvertEncoding convert<font color="black">(</font> file.strEncoding, MCD_ENC, <font color="black">(</font><font color="blue">const</font> <font color="blue">void</font><font color="black">*</font><font color="black">)</font>pDoc, nWriteStrLen <font color="black">)</font>;
            file.nFileTextLen <font color="black">=</font> x_ConvertEncoding<font color="black">(</font> convert, NULL <font color="black">)</font>;
            <font color="blue">char</font><font color="black">*</font> pMBBuffer <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>file.nFileTextLen<font color="black">]</font>;
            x_ConvertEncoding<font color="black">(</font> convert, <font color="black">(</font><font color="blue">void</font><font color="black">*</font><font color="black">)</font>pMBBuffer <font color="black">)</font>;
            MCD_SPRINTF<font color="black">(</font> MCD_SSZ<font color="black">(</font>szWriteInfo<font color="black">)</font>, MCD_T<font color="black">(</font><font color="maroon">"from length %d "</font><font color="black">)</font>, nWriteStrLen <font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font> convert.nFailedChars <font color="black">)</font>
                MCD_PSZCAT<font color="black">(</font> szWriteInfo, MCD_T<font color="black">(</font><font color="maroon">"(chars lost in conversion!) "</font><font color="black">)</font> <font color="black">)</font>;
            bSuccess <font color="black">=</font> x_Write<font color="black">(</font> pMBBuffer, file <font color="black">)</font>;
            <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> pMBBuffer;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="green">// save directly from string</font>
        <font color="black">{</font>
            file.nFileTextLen <font color="black">=</font> nWriteStrLen;
            bSuccess <font color="black">=</font> x_Write<font color="black">(</font> NULL, file, pDoc <font color="black">)</font>;
        <font color="black">}</font>
<font color="blue">#endif</font> <font color="green">// not WCHAR</font>
    <font color="black">}</font>
    
    <font color="blue">if</font> <font color="black">(</font> bSuccess <font color="black">)</font>
        file.strIOResult <font color="black">+</font><font color="black">=</font> szWriteInfo;
    <font color="blue">else</font>
        file.strIOResult <font color="black">=</font> x_GetLastError<font color="black">(</font><font color="black">)</font>;
    <font color="blue">return</font> bSuccess;
<font color="black">}</font>

<font color="blue">bool</font> CMarkup<font color="black">:</font><font color="black">:</font>x_Close<font color="black">(</font> FilePos<font color="black">&</font> file <font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font> file.fp <font color="black">)</font>
    <font color="black">{</font>
        fclose<font color="black">(</font> file.fp <font color="black">)</font>;
        file.fp <font color="black">=</font> NULL;
        file.nDocFlags <font color="black">&</font><font color="black">=</font> ~<font color="black">(</font>MDF_WRITEFILE<font color="black">|</font>MDF_READFILE<font color="black">|</font>MDF_APPENDFILE<font color="black">)</font>;
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>


</PRE>
</BODY>
</HTML>
